

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Directory Entries &mdash; The Linux Kernel 5.10.0-rc6+ documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.10.0-rc6
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devicetree/index.html">Open Firmware and Device Tree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mhi/index.html">MHI</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nios2/nios2.html">Linux on the Nios II architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../x86/index.html">x86-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html">ext4 Data Structures and Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Directory Entries</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/filesystems/ext4/directory.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="directory-entries">
<h1>Directory Entries<a class="headerlink" href="#directory-entries" title="Permalink to this headline">¶</a></h1>
<p>In an ext4 filesystem, a directory is more or less a flat file that maps
an arbitrary byte string (usually ASCII) to an inode number on the
filesystem. There can be many directory entries across the filesystem
that reference the same inode number–these are known as hard links, and
that is why hard links cannot reference files on other filesystems. As
such, directory entries are found by reading the data block(s)
associated with a directory file for the particular directory entry that
is desired.</p>
<div class="section" id="linear-classic-directories">
<h2>Linear (Classic) Directories<a class="headerlink" href="#linear-classic-directories" title="Permalink to this headline">¶</a></h2>
<p>By default, each directory lists its entries in an “almost-linear”
array. I write “almost” because it’s not a linear array in the memory
sense because directory entries are not split across filesystem blocks.
Therefore, it is more accurate to say that a directory is a series of
data blocks and that each block contains a linear array of directory
entries. The end of each per-block array is signified by reaching the
end of the block; the last entry in the block has a record length that
takes it all the way to the end of the block. The end of the entire
directory is of course signified by reaching the end of the file. Unused
directory entries are signified by inode = 0. By default the filesystem
uses <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ext4_dir_entry_2</span></code> for directory entries unless the
“filetype” feature flag is not set, in which case it uses
<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ext4_dir_entry</span></code>.</p>
<p>The original directory entry format is <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ext4_dir_entry</span></code>, which
is at most 263 bytes long, though on disk you’ll need to reference
<code class="docutils literal notranslate"><span class="pre">dirent.rec_len</span></code> to know for sure.</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 30%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Offset</p></th>
<th class="head"><p>Size</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x0</p></td>
<td><p>__le32</p></td>
<td><p>inode</p></td>
<td><p>Number of the inode that this directory entry points to.</p></td>
</tr>
<tr class="row-odd"><td><p>0x4</p></td>
<td><p>__le16</p></td>
<td><p>rec_len</p></td>
<td><p>Length of this directory entry. Must be a multiple of 4.</p></td>
</tr>
<tr class="row-even"><td><p>0x6</p></td>
<td><p>__le16</p></td>
<td><p>name_len</p></td>
<td><p>Length of the file name.</p></td>
</tr>
<tr class="row-odd"><td><p>0x8</p></td>
<td><p>char</p></td>
<td><p>name[EXT4_NAME_LEN]</p></td>
<td><p>File name.</p></td>
</tr>
</tbody>
</table>
<p>Since file names cannot be longer than 255 bytes, the new directory
entry format shortens the name_len field and uses the space for a file
type flag, probably to avoid having to load every inode during directory
tree traversal. This format is <code class="docutils literal notranslate"><span class="pre">ext4_dir_entry_2</span></code>, which is at most
263 bytes long, though on disk you’ll need to reference
<code class="docutils literal notranslate"><span class="pre">dirent.rec_len</span></code> to know for sure.</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 30%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Offset</p></th>
<th class="head"><p>Size</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x0</p></td>
<td><p>__le32</p></td>
<td><p>inode</p></td>
<td><p>Number of the inode that this directory entry points to.</p></td>
</tr>
<tr class="row-odd"><td><p>0x4</p></td>
<td><p>__le16</p></td>
<td><p>rec_len</p></td>
<td><p>Length of this directory entry.</p></td>
</tr>
<tr class="row-even"><td><p>0x6</p></td>
<td><p>__u8</p></td>
<td><p>name_len</p></td>
<td><p>Length of the file name.</p></td>
</tr>
<tr class="row-odd"><td><p>0x7</p></td>
<td><p>__u8</p></td>
<td><p>file_type</p></td>
<td><p>File type code, see <a class="reference internal" href="#ftype">ftype</a> table below.</p></td>
</tr>
<tr class="row-even"><td><p>0x8</p></td>
<td><p>char</p></td>
<td><p>name[EXT4_NAME_LEN]</p></td>
<td><p>File name.</p></td>
</tr>
</tbody>
</table>
<p id="ftype">The directory file type is one of the following values:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 80%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x0</p></td>
<td><p>Unknown.</p></td>
</tr>
<tr class="row-odd"><td><p>0x1</p></td>
<td><p>Regular file.</p></td>
</tr>
<tr class="row-even"><td><p>0x2</p></td>
<td><p>Directory.</p></td>
</tr>
<tr class="row-odd"><td><p>0x3</p></td>
<td><p>Character device file.</p></td>
</tr>
<tr class="row-even"><td><p>0x4</p></td>
<td><p>Block device file.</p></td>
</tr>
<tr class="row-odd"><td><p>0x5</p></td>
<td><p>FIFO.</p></td>
</tr>
<tr class="row-even"><td><p>0x6</p></td>
<td><p>Socket.</p></td>
</tr>
<tr class="row-odd"><td><p>0x7</p></td>
<td><p>Symbolic link.</p></td>
</tr>
</tbody>
</table>
<p>In order to add checksums to these classic directory blocks, a phony
<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ext4_dir_entry</span></code> is placed at the end of each leaf block to
hold the checksum. The directory entry is 12 bytes long. The inode
number and name_len fields are set to zero to fool old software into
ignoring an apparently empty directory entry, and the checksum is stored
in the place where the name normally goes. The structure is
<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ext4_dir_entry_tail</span></code>:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 30%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Offset</p></th>
<th class="head"><p>Size</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x0</p></td>
<td><p>__le32</p></td>
<td><p>det_reserved_zero1</p></td>
<td><p>Inode number, which must be zero.</p></td>
</tr>
<tr class="row-odd"><td><p>0x4</p></td>
<td><p>__le16</p></td>
<td><p>det_rec_len</p></td>
<td><p>Length of this directory entry, which must be 12.</p></td>
</tr>
<tr class="row-even"><td><p>0x6</p></td>
<td><p>__u8</p></td>
<td><p>det_reserved_zero2</p></td>
<td><p>Length of the file name, which must be zero.</p></td>
</tr>
<tr class="row-odd"><td><p>0x7</p></td>
<td><p>__u8</p></td>
<td><p>det_reserved_ft</p></td>
<td><p>File type, which must be 0xDE.</p></td>
</tr>
<tr class="row-even"><td><p>0x8</p></td>
<td><p>__le32</p></td>
<td><p>det_checksum</p></td>
<td><p>Directory leaf block checksum.</p></td>
</tr>
</tbody>
</table>
<p>The leaf directory block checksum is calculated against the FS UUID, the
directory’s inode number, the directory’s inode generation number, and
the entire directory entry block up to (but not including) the fake
directory entry.</p>
</div>
<div class="section" id="hash-tree-directories">
<h2>Hash Tree Directories<a class="headerlink" href="#hash-tree-directories" title="Permalink to this headline">¶</a></h2>
<p>A linear array of directory entries isn’t great for performance, so a
new feature was added to ext3 to provide a faster (but peculiar)
balanced tree keyed off a hash of the directory entry name. If the
EXT4_INDEX_FL (0x1000) flag is set in the inode, this directory uses a
hashed btree (htree) to organize and find directory entries. For
backwards read-only compatibility with ext2, this tree is actually
hidden inside the directory file, masquerading as “empty” directory data
blocks! It was stated previously that the end of the linear directory
entry table was signified with an entry pointing to inode 0; this is
(ab)used to fool the old linear-scan algorithm into thinking that the
rest of the directory block is empty so that it moves on.</p>
<p>The root of the tree always lives in the first data block of the
directory. By ext2 custom, the ‘.’ and ‘..’ entries must appear at the
beginning of this first block, so they are put here as two
<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ext4_dir_entry_2</span></code>s and not stored in the tree. The rest of
the root node contains metadata about the tree and finally a hash-&gt;block
map to find nodes that are lower in the htree. If
<code class="docutils literal notranslate"><span class="pre">dx_root.info.indirect_levels</span></code> is non-zero then the htree has two
levels; the data block pointed to by the root node’s map is an interior
node, which is indexed by a minor hash. Interior nodes in this tree
contains a zeroed out <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ext4_dir_entry_2</span></code> followed by a
minor_hash-&gt;block map to find leafe nodes. Leaf nodes contain a linear
array of all <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ext4_dir_entry_2</span></code>; all of these entries
(presumably) hash to the same value. If there is an overflow, the
entries simply overflow into the next leaf node, and the
least-significant bit of the hash (in the interior node map) that gets
us to this next leaf node is set.</p>
<p>To traverse the directory as a htree, the code calculates the hash of
the desired file name and uses it to find the corresponding block
number. If the tree is flat, the block is a linear array of directory
entries that can be searched; otherwise, the minor hash of the file name
is computed and used against this second block to find the corresponding
third block number. That third block number will be a linear array of
directory entries.</p>
<p>To traverse the directory as a linear array (such as the old code does),
the code simply reads every data block in the directory. The blocks used
for the htree will appear to have no entries (aside from ‘.’ and ‘..’)
and so only the leaf nodes will appear to have any interesting content.</p>
<p>The root of the htree is in <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dx_root</span></code>, which is the full length
of a data block:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 30%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Offset</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x0</p></td>
<td><p>__le32</p></td>
<td><p>dot.inode</p></td>
<td><p>inode number of this directory.</p></td>
</tr>
<tr class="row-odd"><td><p>0x4</p></td>
<td><p>__le16</p></td>
<td><p>dot.rec_len</p></td>
<td><p>Length of this record, 12.</p></td>
</tr>
<tr class="row-even"><td><p>0x6</p></td>
<td><p>u8</p></td>
<td><p>dot.name_len</p></td>
<td><p>Length of the name, 1.</p></td>
</tr>
<tr class="row-odd"><td><p>0x7</p></td>
<td><p>u8</p></td>
<td><p>dot.file_type</p></td>
<td><p>File type of this entry, 0x2 (directory) (if the feature flag is set).</p></td>
</tr>
<tr class="row-even"><td><p>0x8</p></td>
<td><p>char</p></td>
<td><p>dot.name[4]</p></td>
<td><p>“.\0\0\0”</p></td>
</tr>
<tr class="row-odd"><td><p>0xC</p></td>
<td><p>__le32</p></td>
<td><p>dotdot.inode</p></td>
<td><p>inode number of parent directory.</p></td>
</tr>
<tr class="row-even"><td><p>0x10</p></td>
<td><p>__le16</p></td>
<td><p>dotdot.rec_len</p></td>
<td><p>block_size - 12. The record length is long enough to cover all htree
data.</p></td>
</tr>
<tr class="row-odd"><td><p>0x12</p></td>
<td><p>u8</p></td>
<td><p>dotdot.name_len</p></td>
<td><p>Length of the name, 2.</p></td>
</tr>
<tr class="row-even"><td><p>0x13</p></td>
<td><p>u8</p></td>
<td><p>dotdot.file_type</p></td>
<td><p>File type of this entry, 0x2 (directory) (if the feature flag is set).</p></td>
</tr>
<tr class="row-odd"><td><p>0x14</p></td>
<td><p>char</p></td>
<td><p>dotdot_name[4]</p></td>
<td><p>“..\0\0”</p></td>
</tr>
<tr class="row-even"><td><p>0x18</p></td>
<td><p>__le32</p></td>
<td><p>struct dx_root_info.reserved_zero</p></td>
<td><p>Zero.</p></td>
</tr>
<tr class="row-odd"><td><p>0x1C</p></td>
<td><p>u8</p></td>
<td><p>struct dx_root_info.hash_version</p></td>
<td><p>Hash type, see <a class="reference internal" href="#dirhash">dirhash</a> table below.</p></td>
</tr>
<tr class="row-even"><td><p>0x1D</p></td>
<td><p>u8</p></td>
<td><p>struct dx_root_info.info_length</p></td>
<td><p>Length of the tree information, 0x8.</p></td>
</tr>
<tr class="row-odd"><td><p>0x1E</p></td>
<td><p>u8</p></td>
<td><p>struct dx_root_info.indirect_levels</p></td>
<td><p>Depth of the htree. Cannot be larger than 3 if the INCOMPAT_LARGEDIR
feature is set; cannot be larger than 2 otherwise.</p></td>
</tr>
<tr class="row-even"><td><p>0x1F</p></td>
<td><p>u8</p></td>
<td><p>struct dx_root_info.unused_flags</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>0x20</p></td>
<td><p>__le16</p></td>
<td><p>limit</p></td>
<td><p>Maximum number of dx_entries that can follow this header, plus 1 for
the header itself.</p></td>
</tr>
<tr class="row-even"><td><p>0x22</p></td>
<td><p>__le16</p></td>
<td><p>count</p></td>
<td><p>Actual number of dx_entries that follow this header, plus 1 for the
header itself.</p></td>
</tr>
<tr class="row-odd"><td><p>0x24</p></td>
<td><p>__le32</p></td>
<td><p>block</p></td>
<td><p>The block number (within the directory file) that goes with hash=0.</p></td>
</tr>
<tr class="row-even"><td><p>0x28</p></td>
<td><p>struct dx_entry</p></td>
<td><p>entries[0]</p></td>
<td><p>As many 8-byte <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dx_entry</span></code> as fits in the rest of the data block.</p></td>
</tr>
</tbody>
</table>
<p id="dirhash">The directory hash is one of the following values:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 80%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x0</p></td>
<td><p>Legacy.</p></td>
</tr>
<tr class="row-odd"><td><p>0x1</p></td>
<td><p>Half MD4.</p></td>
</tr>
<tr class="row-even"><td><p>0x2</p></td>
<td><p>Tea.</p></td>
</tr>
<tr class="row-odd"><td><p>0x3</p></td>
<td><p>Legacy, unsigned.</p></td>
</tr>
<tr class="row-even"><td><p>0x4</p></td>
<td><p>Half MD4, unsigned.</p></td>
</tr>
<tr class="row-odd"><td><p>0x5</p></td>
<td><p>Tea, unsigned.</p></td>
</tr>
</tbody>
</table>
<p>Interior nodes of an htree are recorded as <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dx_node</span></code>, which is
also the full length of a data block:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 30%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Offset</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x0</p></td>
<td><p>__le32</p></td>
<td><p>fake.inode</p></td>
<td><p>Zero, to make it look like this entry is not in use.</p></td>
</tr>
<tr class="row-odd"><td><p>0x4</p></td>
<td><p>__le16</p></td>
<td><p>fake.rec_len</p></td>
<td><p>The size of the block, in order to hide all of the dx_node data.</p></td>
</tr>
<tr class="row-even"><td><p>0x6</p></td>
<td><p>u8</p></td>
<td><p>name_len</p></td>
<td><p>Zero. There is no name for this “unused” directory entry.</p></td>
</tr>
<tr class="row-odd"><td><p>0x7</p></td>
<td><p>u8</p></td>
<td><p>file_type</p></td>
<td><p>Zero. There is no file type for this “unused” directory entry.</p></td>
</tr>
<tr class="row-even"><td><p>0x8</p></td>
<td><p>__le16</p></td>
<td><p>limit</p></td>
<td><p>Maximum number of dx_entries that can follow this header, plus 1 for
the header itself.</p></td>
</tr>
<tr class="row-odd"><td><p>0xA</p></td>
<td><p>__le16</p></td>
<td><p>count</p></td>
<td><p>Actual number of dx_entries that follow this header, plus 1 for the
header itself.</p></td>
</tr>
<tr class="row-even"><td><p>0xE</p></td>
<td><p>__le32</p></td>
<td><p>block</p></td>
<td><p>The block number (within the directory file) that goes with the lowest
hash value of this block. This value is stored in the parent block.</p></td>
</tr>
<tr class="row-odd"><td><p>0x12</p></td>
<td><p>struct dx_entry</p></td>
<td><p>entries[0]</p></td>
<td><p>As many 8-byte <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dx_entry</span></code> as fits in the rest of the data block.</p></td>
</tr>
</tbody>
</table>
<p>The hash maps that exist in both <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dx_root</span></code> and
<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dx_node</span></code> are recorded as <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dx_entry</span></code>, which is 8 bytes
long:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 30%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Offset</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x0</p></td>
<td><p>__le32</p></td>
<td><p>hash</p></td>
<td><p>Hash code.</p></td>
</tr>
<tr class="row-odd"><td><p>0x4</p></td>
<td><p>__le32</p></td>
<td><p>block</p></td>
<td><p>Block number (within the directory file, not filesystem blocks) of the
next node in the htree.</p></td>
</tr>
</tbody>
</table>
<p>(If you think this is all quite clever and peculiar, so does the
author.)</p>
<p>If metadata checksums are enabled, the last 8 bytes of the directory
block (precisely the length of one dx_entry) are used to store a
<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dx_tail</span></code>, which contains the checksum. The <code class="docutils literal notranslate"><span class="pre">limit</span></code> and
<code class="docutils literal notranslate"><span class="pre">count</span></code> entries in the dx_root/dx_node structures are adjusted as
necessary to fit the dx_tail into the block. If there is no space for
the dx_tail, the user is notified to run e2fsck -D to rebuild the
directory index (which will ensure that there’s space for the checksum.
The dx_tail structure is 8 bytes long and looks like this:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 30%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Offset</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x0</p></td>
<td><p>u32</p></td>
<td><p>dt_reserved</p></td>
<td><p>Zero.</p></td>
</tr>
<tr class="row-odd"><td><p>0x4</p></td>
<td><p>__le32</p></td>
<td><p>dt_checksum</p></td>
<td><p>Checksum of the htree directory block.</p></td>
</tr>
</tbody>
</table>
<p>The checksum is calculated against the FS UUID, the htree index header
(dx_root or dx_node), all of the htree indices (dx_entry) that are in
use, and the tail block (dx_tail).</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright The kernel development community

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>