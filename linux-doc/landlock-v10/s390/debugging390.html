

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Debugging on Linux for s/390 &amp; z/Architecture &mdash; The Linux Kernel 5.2.0+ documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../media/index.html">Linux Media Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../x86/index.html">x86-specific Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/ext4/index.html">ext4 Data Structures and Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Debugging on Linux for s/390 &amp; z/Architecture</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/s390/debugging390.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="debugging-on-linux-for-s-390-z-architecture">
<h1>Debugging on Linux for s/390 &amp; z/Architecture<a class="headerlink" href="#debugging-on-linux-for-s-390-z-architecture" title="Permalink to this headline">¶</a></h1>
<p>Denis Joseph Barrow (<a class="reference external" href="mailto:djbarrow&#37;&#52;&#48;de&#46;ibm&#46;com">djbarrow<span>&#64;</span>de<span>&#46;</span>ibm<span>&#46;</span>com</a>,barrow_dj&#64;yahoo.com)</p>
<p>Copyright (C) 2000-2001 IBM Deutschland Entwicklung GmbH, IBM Corporation</p>
<div class="section" id="overview-of-document">
<h2>Overview of Document:<a class="headerlink" href="#overview-of-document" title="Permalink to this headline">¶</a></h2>
<p>This document is intended to give a good overview of how to debug Linux for
s/390 and z/Architecture. It is not intended as a complete reference and not a
tutorial on the fundamentals of C &amp; assembly. It doesn’t go into
390 IO in any detail. It is intended to complement the documents in the
reference section below &amp; any other worthwhile references you get.</p>
<p>It is intended like the Enterprise Systems Architecture/390 Reference Summary
to be printed out &amp; used as a quick cheat sheet self help style reference when
problems occur.</p>
</div>
<div class="section" id="register-set">
<h2>Register Set<a class="headerlink" href="#register-set" title="Permalink to this headline">¶</a></h2>
<p>The current architectures have the following registers.</p>
<p>16 General propose registers, 32 bit on s/390 and 64 bit on z/Architecture,
r0-r15 (or gpr0-gpr15), used for arithmetic and addressing.</p>
<p>16 Control registers, 32 bit on s/390 and 64 bit on z/Architecture, cr0-cr15,
kernel usage only, used for memory management, interrupt control, debugging
control etc.</p>
<p>16 Access registers (ar0-ar15), 32 bit on both s/390 and z/Architecture,
normally not used by normal programs but potentially could be used as
temporary storage. These registers have a 1:1 association with general
purpose registers and are designed to be used in the so-called access
register mode to select different address spaces.
Access register 0 (and access register 1 on z/Architecture, which needs a
64 bit pointer) is currently used by the pthread library as a pointer to
the current running threads private area.</p>
<p>16 64-bit floating point registers (fp0-fp15 ) IEEE &amp; HFP floating
point format compliant on G5 upwards &amp; a Floating point control reg (FPC)</p>
<p>4  64-bit registers (fp0,fp2,fp4 &amp; fp6) HFP only on older machines.</p>
<dl class="docutils">
<dt>Note:</dt>
<dd>Linux (currently) always uses IEEE &amp; emulates G5 IEEE format on older
machines, ( provided the kernel is configured for this ).</dd>
</dl>
<p>The PSW is the most important register on the machine it
is 64 bit on s/390 &amp; 128 bit on z/Architecture &amp; serves the roles of
a program counter (pc), condition code register,memory space designator.
In IBM standard notation I am counting bit 0 as the MSB.
It has several advantages over a normal program counter
in that you can change address translation &amp; program counter
in a single instruction. To change address translation,
e.g. switching address translation off requires that you
have a logical=physical mapping for the address you are
currently running at.</p>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="22%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head" colspan="2">Bit</th>
<th class="head" rowspan="2">Value</th>
</tr>
<tr class="row-even"><th class="head">s/390</th>
<th class="head">z/Architecture</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-odd"><td>0</td>
<td>0</td>
<td>Reserved (must be 0) otherwise specification
exception occurs.</td>
</tr>
<tr class="row-even"><td>1</td>
<td>1</td>
<td>Program Event Recording 1 PER enabled,
PER is used to facilitate debugging e.g.
single stepping.</td>
</tr>
<tr class="row-odd"><td>2-4</td>
<td>2-4</td>
<td>Reserved (must be 0).</td>
</tr>
<tr class="row-even"><td>5</td>
<td>5</td>
<td>Dynamic address translation 1=DAT on.</td>
</tr>
<tr class="row-odd"><td>6</td>
<td>6</td>
<td>Input/Output interrupt Mask</td>
</tr>
<tr class="row-even"><td>7</td>
<td>7</td>
<td>External interrupt Mask used primarily for
interprocessor signalling and clock interrupts.</td>
</tr>
<tr class="row-odd"><td>8-11</td>
<td>8-11</td>
<td>PSW Key used for complex memory protection
mechanism (not used under linux)</td>
</tr>
<tr class="row-even"><td>12</td>
<td>12</td>
<td>1 on s/390 0 on z/Architecture</td>
</tr>
<tr class="row-odd"><td>13</td>
<td>13</td>
<td>Machine Check Mask 1=enable machine check
interrupts</td>
</tr>
<tr class="row-even"><td>14</td>
<td>14</td>
<td>Wait State. Set this to 1 to stop the processor
except for interrupts and give  time to other
LPARS. Used in CPU idle in the kernel to
increase overall usage of processor resources.</td>
</tr>
<tr class="row-odd"><td>15</td>
<td>15</td>
<td>Problem state (if set to 1 certain instructions
are disabled). All linux user programs run with
this bit 1 (useful info for debugging under VM).</td>
</tr>
<tr class="row-even"><td>16-17</td>
<td>16-17</td>
<td><p class="first">Address Space Control</p>
<p>00 Primary Space Mode:</p>
<p>The register CR1 contains the primary
address-space control element (PASCE), which
points to the primary space region/segment
table origin.</p>
<p>01 Access register mode</p>
<p>10 Secondary Space Mode:</p>
<p>The register CR7 contains the secondary
address-space control element (SASCE), which
points to the secondary space region or
segment table origin.</p>
<p>11 Home Space Mode:</p>
<p>The register CR13 contains the home space
address-space control element (HASCE), which
points to the home space region/segment
table origin.</p>
<p class="last">See “Address Spaces on Linux for s/390 &amp;
z/Architecture” below for more information
about address space usage in Linux.</p>
</td>
</tr>
<tr class="row-odd"><td>18-19</td>
<td>18-19</td>
<td>Condition codes (CC)</td>
</tr>
<tr class="row-even"><td>20</td>
<td>20</td>
<td>Fixed point overflow mask if 1=FPU exceptions
for this event occur (normally 0)</td>
</tr>
<tr class="row-odd"><td>21</td>
<td>21</td>
<td>Decimal overflow mask if 1=FPU exceptions for
this event occur (normally 0)</td>
</tr>
<tr class="row-even"><td>22</td>
<td>22</td>
<td>Exponent underflow mask if 1=FPU exceptions
for this event occur (normally 0)</td>
</tr>
<tr class="row-odd"><td>23</td>
<td>23</td>
<td>Significance Mask if 1=FPU exceptions for this
event occur (normally 0)</td>
</tr>
<tr class="row-even"><td rowspan="3">24-31</td>
<td>24-30</td>
<td>Reserved Must be 0.</td>
</tr>
<tr class="row-odd"><td>31</td>
<td>Extended Addressing Mode</td>
</tr>
<tr class="row-even"><td>32</td>
<td><p class="first">Basic Addressing Mode</p>
<p>Used to set addressing mode</p>
<blockquote class="last">
<div><table border="1" class="docutils">
<colgroup>
<col width="31%" />
<col width="34%" />
<col width="34%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>PSW 31</td>
<td>PSW 32</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>0</td>
<td>0</td>
<td>24 bit</td>
</tr>
<tr class="row-odd"><td>0</td>
<td>1</td>
<td>31 bit</td>
</tr>
<tr class="row-even"><td>1</td>
<td>1</td>
<td>64 bit</td>
</tr>
</tbody>
</table>
</div></blockquote>
</td>
</tr>
<tr class="row-odd"><td>32</td>
<td>&#160;</td>
<td>1=31 bit addressing mode 0=24 bit addressing
mode (for backward compatibility), linux
always runs with this bit set to 1</td>
</tr>
<tr class="row-even"><td rowspan="3">33-64</td>
<td>&#160;</td>
<td>Instruction address.</td>
</tr>
<tr class="row-odd"><td>33-63</td>
<td>Reserved must be 0</td>
</tr>
<tr class="row-even"><td>64-127</td>
<td><p class="first">Address</p>
<blockquote>
<div><ul class="simple">
<li>In 24 bits mode bits 64-103=0 bits 104-127
Address</li>
<li>In 31 bits mode bits 64-96=0 bits 97-127
Address</li>
</ul>
</div></blockquote>
<dl class="last docutils">
<dt>Note:</dt>
<dd>unlike 31 bit mode on s/390 bit 96 must be
zero when loading the address with LPSWE
otherwise a specification exception occurs,
LPSW is fully backward compatible.</dd>
</dl>
</td>
</tr>
</tbody>
</table>
<div class="section" id="prefix-page-s">
<h3>Prefix Page(s)<a class="headerlink" href="#prefix-page-s" title="Permalink to this headline">¶</a></h3>
<p>This per cpu memory area is too intimately tied to the processor not to mention.
It exists between the real addresses 0-4096 on s/390 and between 0-8192 on
z/Architecture and is exchanged with one page on s/390 or two pages on
z/Architecture in absolute storage by the set prefix instruction during Linux
startup.</p>
<p>This page is mapped to a different prefix for each processor in an SMP
configuration (assuming the OS designer is sane of course).</p>
<p>Bytes 0-512 (200 hex) on s/390 and 0-512, 4096-4544, 4604-5119 currently on
z/Architecture are used by the processor itself for holding such information
as exception indications and entry points for exceptions.</p>
<p>Bytes after 0xc00 hex are used by linux for per processor globals on s/390 and
z/Architecture (there is a gap on z/Architecture currently between 0xc00 and
0x1000, too, which is used by Linux).</p>
<p>The closest thing to this on traditional architectures is the interrupt
vector table. This is a good thing &amp; does simplify some of the kernel coding
however it means that we now cannot catch stray NULL pointers in the
kernel without hard coded checks.</p>
</div>
</div>
<div class="section" id="address-spaces-on-intel-linux">
<h2>Address Spaces on Intel Linux<a class="headerlink" href="#address-spaces-on-intel-linux" title="Permalink to this headline">¶</a></h2>
<p>The traditional Intel Linux is approximately mapped as follows forgive
the ascii art:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>0xFFFFFFFF 4GB Himem          *****************
                              *               *
                              * Kernel Space  *
                              *               *
                              *****************         ****************
User Space Himem              *  User Stack   *         *              *
(typically 0xC0000000 3GB )   *****************         *              *
                              *  Shared Libs  *         * Next Process *
                              *****************         *     to       *
                              *               *   &lt;==   *     Run      *  &lt;==
                              *  User Program *         *              *
                              *   Data BSS    *         *              *
                              *    Text       *         *              *
                              *   Sections    *         *              *
0x00000000                    *****************         ****************
</pre></div>
</div>
<p>Now it is easy to see that on Intel it is quite easy to recognise a kernel
address as being one greater than user space himem (in this case 0xC0000000),
and addresses of less than this are the ones in the current running program on
this processor (if an smp box).</p>
<p>If using the virtual machine ( VM ) as a debugger it is quite difficult to
know which user process is running as the address space you are looking at
could be from any process in the run queue.</p>
<p>The limitation of Intels addressing technique is that the linux
kernel uses a very simple real address to virtual addressing technique
of Real Address=Virtual Address-User Space Himem.
This means that on Intel the kernel linux can typically only address
Himem=0xFFFFFFFF-0xC0000000=1GB &amp; this is all the RAM these machines
can typically use.</p>
<p>They can lower User Himem to 2GB or lower &amp; thus be
able to use 2GB of RAM however this shrinks the maximum size
of User Space from 3GB to 2GB they have a no win limit of 4GB unless
they go to 64 Bit.</p>
<p>On 390 our limitations &amp; strengths make us slightly different.
For backward compatibility we are only allowed use 31 bits (2GB)
of our 32 bit addresses, however, we use entirely separate address
spaces for the user &amp; kernel.</p>
<p>This means we can support 2GB of non Extended RAM on s/390, &amp; more
with the Extended memory management swap device &amp;
currently 4TB of physical memory currently on z/Architecture.</p>
</div>
<div class="section" id="address-spaces-on-linux-for-s-390-z-architecture">
<h2>Address Spaces on Linux for s/390 &amp; z/Architecture<a class="headerlink" href="#address-spaces-on-linux-for-s-390-z-architecture" title="Permalink to this headline">¶</a></h2>
<p>Our addressing scheme is basically as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>                                 Primary Space               Home Space
Himem 0x7fffffff 2GB on s/390    *****************          ****************
currently 0x3ffffffffff (2^42)-1 *  User Stack   *          *              *
on z/Architecture.               *****************          *              *
                                 *  Shared Libs  *          *              *
                                 *****************          *              *
                                 *               *          *    Kernel    *
                                 *  User Program *          *              *
                                 *   Data BSS    *          *              *
                                 *    Text       *          *              *
                                 *   Sections    *          *              *
0x00000000                       *****************          ****************
</pre></div>
</div>
<p>This also means that we need to look at the PSW problem state bit and the
addressing mode to decide whether we are looking at user or kernel space.</p>
<p>User space runs in primary address mode (or access register mode within
the vdso code).</p>
<p>The kernel usually also runs in home space mode, however when accessing
user space the kernel switches to primary or secondary address mode if
the mvcos instruction is not available or if a compare-and-swap (futex)
instruction on a user space address is performed.</p>
<p>When also looking at the ASCE control registers, this means:</p>
<p>User space:</p>
<ul class="simple">
<li>runs in primary or access register mode</li>
<li>cr1 contains the user asce</li>
<li>cr7 contains the user asce</li>
<li>cr13 contains the kernel asce</li>
</ul>
<p>Kernel space:</p>
<ul class="simple">
<li>runs in home space mode</li>
<li>cr1 contains the user or kernel asce<ul>
<li>the kernel asce is loaded when a uaccess requires primary or
secondary address mode</li>
</ul>
</li>
<li>cr7 contains the user or kernel asce, (changed with set_fs())</li>
<li>cr13 contains the kernel asce</li>
</ul>
<p>In case of uaccess the kernel changes to:</p>
<ul class="simple">
<li>primary space mode in case of a uaccess (copy_to_user) and uses
e.g. the mvcp instruction to access user space. However the kernel
will stay in home space mode if the mvcos instruction is available</li>
<li>secondary space mode in case of futex atomic operations, so that the
instructions come from primary address space and data from secondary
space</li>
</ul>
<p>In case of KVM, the kernel runs in home space mode, but cr1 gets switched
to contain the gmap asce before the SIE instruction gets executed. When
the SIE instruction is finished, cr1 will be switched back to contain the
user asce.</p>
</div>
<div class="section" id="virtual-addresses-on-s-390-z-architecture">
<h2>Virtual Addresses on s/390 &amp; z/Architecture<a class="headerlink" href="#virtual-addresses-on-s-390-z-architecture" title="Permalink to this headline">¶</a></h2>
<p>A virtual address on s/390 is made up of 3 parts
The SX (segment index, roughly corresponding to the PGD &amp; PMD in Linux
terminology) being bits 1-11.</p>
<p>The PX (page index, corresponding to the page table entry (pte) in Linux
terminology) being bits 12-19.</p>
<p>The remaining bits BX (the byte index are the offset in the page )
i.e. bits 20 to 31.</p>
<p>On z/Architecture in linux we currently make up an address from 4 parts.</p>
<ul class="simple">
<li>The region index bits (RX) 0-32 we currently use bits 22-32</li>
<li>The segment index (SX) being bits 33-43</li>
<li>The page index (PX) being bits  44-51</li>
<li>The byte index (BX) being bits  52-63</li>
</ul>
<dl class="docutils">
<dt>Notes:</dt>
<dd><ol class="first last arabic simple">
<li>s/390 has no PMD so the PMD is really the PGD also.
A lot of this stuff is defined in pgtable.h.</li>
<li>Also seeing as s/390’s page indexes are only 1k  in size
(bits 12-19 x 4 bytes per pte ) we use 1 ( page 4k )
to make the best use of memory by updating 4 segment indices
entries each time we mess with a PMD &amp; use offsets
0,1024,2048 &amp; 3072 in this page as for our segment indexes.
On z/Architecture our page indexes are now 2k in size
( bits 12-19 x 8 bytes per pte ) we do a similar trick
but only mess with 2 segment indices each time we mess with
a PMD.</li>
<li>As z/Architecture supports up to a massive 5-level page table lookup we
can only use 3 currently on Linux ( as this is all the generic kernel
currently supports ) however this may change in future
this allows us to access ( according to my sums )
4TB of virtual storage per process i.e.
4096*512(PTES)*1024(PMDS)*2048(PGD) = 4398046511104 bytes,
enough for another 2 or 3 of years I think :-).
to do this we use a region-third-table designation type in
our address space control registers.</li>
</ol>
</dd>
</dl>
</div>
<div class="section" id="the-linux-for-s-390-z-architecture-kernel-task-structure">
<h2>The Linux for s/390 &amp; z/Architecture Kernel Task Structure<a class="headerlink" href="#the-linux-for-s-390-z-architecture-kernel-task-structure" title="Permalink to this headline">¶</a></h2>
<p>Each process/thread under Linux for S390 has its own kernel task_struct
defined in linux/include/linux/sched.h
The S390 on initialisation &amp; resuming of a process on a cpu sets
the __LC_KERNEL_STACK variable in the spare prefix area for this cpu
(which we use for per-processor globals).</p>
<p>The kernel stack pointer is intimately tied with the task structure for
each processor as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>                      s/390
            ************************
            *  1 page kernel stack *
            *        ( 4K )        *
            ************************
            *   1 page task_struct *
            *        ( 4K )        *
8K aligned  ************************

                 z/Architecture
            ************************
            *  2 page kernel stack *
            *        ( 8K )        *
            ************************
            *  2 page task_struct  *
            *        ( 8K )        *
16K aligned ************************
</pre></div>
</div>
<p>What this means is that we don’t need to dedicate any register or global
variable to point to the current running process &amp; can retrieve it with the
following very simple construct for s/390 &amp; one very similar for
z/Architecture:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>static inline struct task_struct * get_current(void)
{
      struct task_struct *current;
      __asm__(&quot;lhi   %0,-8192\n\t&quot;
              &quot;nr    %0,15&quot;
              : &quot;=r&quot; (current) );
      return current;
}
</pre></div>
</div>
<p>i.e. just anding the current kernel stack pointer with the mask -8192.
Thankfully because Linux doesn’t have support for nested IO interrupts
&amp; our devices have large buffers can survive interrupts being shut for
short amounts of time we don’t need a separate stack for interrupts.</p>
</div>
<div class="section" id="register-usage-stackframes-on-linux-for-s-390-z-architecture">
<h2>Register Usage &amp; Stackframes on Linux for s/390 &amp; z/Architecture<a class="headerlink" href="#register-usage-stackframes-on-linux-for-s-390-z-architecture" title="Permalink to this headline">¶</a></h2>
<div class="section" id="overview">
<h3>Overview:<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h3>
<p>This is the code that gcc produces at the top &amp; the bottom of
each function. It usually is fairly consistent &amp; similar from
function to function &amp; if you know its layout you can probably
make some headway in finding the ultimate cause of a problem
after a crash without a source level debugger.</p>
<p>Note: To follow stackframes requires a knowledge of C or Pascal &amp;
limited knowledge of one assembly language.</p>
<p>It should be noted that there are some differences between the
s/390 and z/Architecture stack layouts as the z/Architecture stack layout
didn’t have to maintain compatibility with older linkage formats.</p>
</div>
<div class="section" id="glossary">
<h3>Glossary:<a class="headerlink" href="#glossary" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>alloca:</dt>
<dd>This is a built in compiler function for runtime allocation
of extra space on the callers stack which is obviously freed
up on function exit ( e.g. the caller may choose to allocate nothing
of a buffer of 4k if required for temporary purposes ), it generates
very efficient code ( a few cycles  ) when compared to alternatives
like malloc.</dd>
<dt>automatics:</dt>
<dd>These are local variables on the stack, i.e they aren’t in registers &amp;
they aren’t static.</dd>
<dt>back-chain:</dt>
<dd>This is a pointer to the stack pointer before entering a
framed functions ( see frameless function ) prologue got by
dereferencing the address of the current stack pointer,
i.e. got by accessing the 32 bit value at the stack pointers
current location.</dd>
<dt>base-pointer:</dt>
<dd>This is a pointer to the back of the literal pool which
is an area just behind each procedure used to store constants
in each function.</dd>
<dt>call-clobbered:</dt>
<dd>The caller probably needs to save these registers if there
is something of value in them, on the stack or elsewhere before making a
call to another procedure so that it can restore it later.</dd>
<dt>epilogue:</dt>
<dd>The code generated by the compiler to return to the caller.</dd>
<dt>frameless-function:</dt>
<dd><p class="first">A frameless function in Linux for s390 &amp; z/Architecture is one which doesn’t
need more than the register save area (96 bytes on s/390, 160 on z/Architecture)
given to it by the caller.</p>
<p>A frameless function never:</p>
<ol class="last arabic simple">
<li>Sets up a back chain.</li>
<li>Calls alloca.</li>
<li>Calls other normal functions</li>
<li>Has automatics.</li>
</ol>
</dd>
<dt>GOT-pointer:</dt>
<dd>This is a pointer to the global-offset-table in ELF
( Executable Linkable Format, Linux’es most common executable format ),
all globals &amp; shared library objects are found using this pointer.</dd>
<dt>lazy-binding</dt>
<dd>ELF shared libraries are typically only loaded when routines in the shared
library are actually first called at runtime. This is lazy binding.</dd>
<dt>procedure-linkage-table</dt>
<dd>This is a table found from the GOT which contains pointers to routines
in other shared libraries which can’t be called to by easier means.</dd>
<dt>prologue:</dt>
<dd>The code generated by the compiler to set up the stack frame.</dd>
<dt>outgoing-args:</dt>
<dd>This is extra area allocated on the stack of the calling function if the
parameters for the callee’s cannot all be put in registers, the same
area can be reused by each function the caller calls.</dd>
<dt>routine-descriptor:</dt>
<dd><p class="first">A COFF  executable format based concept of a procedure reference
actually being 8 bytes or more as opposed to a simple pointer to the routine.
This is typically defined as follows:</p>
<ul class="simple">
<li>Routine Descriptor offset 0=Pointer to Function</li>
<li>Routine Descriptor offset 4=Pointer to Table of Contents</li>
</ul>
<p class="last">The table of contents/TOC is roughly equivalent to a GOT pointer.
&amp; it means that shared libraries etc. can be shared between several
environments each with their own TOC.</p>
</dd>
<dt>static-chain:</dt>
<dd><p class="first">This is used in nested functions a concept adopted from pascal
by gcc not used in ansi C or C++ ( although quite useful ), basically it
is a pointer used to reference local variables of enclosing functions.
You might come across this stuff once or twice in your lifetime.</p>
<p>e.g.</p>
<p>The function below should return 11 though gcc may get upset &amp; toss warnings
about unused variables:</p>
<div class="last highlight-none notranslate"><div class="highlight"><pre><span></span>int FunctionA(int a)
{
    int b;
    FunctionC(int c)
    {
            b=c+1;
    }
    FunctionC(10);
    return(b);
}
</pre></div>
</div>
</dd>
</dl>
</div>
</div>
<div class="section" id="s-390-z-architecture-register-usage">
<h2>s/390 &amp; z/Architecture Register usage<a class="headerlink" href="#s-390-z-architecture-register-usage" title="Permalink to this headline">¶</a></h2>
<table border="1" class="docutils">
<colgroup>
<col width="12%" />
<col width="65%" />
<col width="23%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>r0</td>
<td>used by syscalls/assembly</td>
<td>call-clobbered</td>
</tr>
<tr class="row-even"><td>r1</td>
<td>used by syscalls/assembly</td>
<td>call-clobbered</td>
</tr>
<tr class="row-odd"><td>r2</td>
<td>argument 0 / return value 0</td>
<td>call-clobbered</td>
</tr>
<tr class="row-even"><td>r3</td>
<td>argument 1 / return value 1 (if long long)</td>
<td>call-clobbered</td>
</tr>
<tr class="row-odd"><td>r4</td>
<td>argument 2</td>
<td>call-clobbered</td>
</tr>
<tr class="row-even"><td>r5</td>
<td>argument 3</td>
<td>call-clobbered</td>
</tr>
<tr class="row-odd"><td>r6</td>
<td>argument 4</td>
<td>saved</td>
</tr>
<tr class="row-even"><td>r7</td>
<td>pointer-to arguments 5 to …</td>
<td>saved</td>
</tr>
<tr class="row-odd"><td>r8</td>
<td>this &amp; that</td>
<td>saved</td>
</tr>
<tr class="row-even"><td>r9</td>
<td>this &amp; that</td>
<td>saved</td>
</tr>
<tr class="row-odd"><td>r10</td>
<td>static-chain ( if nested function )</td>
<td>saved</td>
</tr>
<tr class="row-even"><td>r11</td>
<td>frame-pointer ( if function used alloca )</td>
<td>saved</td>
</tr>
<tr class="row-odd"><td>r12</td>
<td>got-pointer</td>
<td>saved</td>
</tr>
<tr class="row-even"><td>r13</td>
<td>base-pointer</td>
<td>saved</td>
</tr>
<tr class="row-odd"><td>r14</td>
<td>return-address</td>
<td>saved</td>
</tr>
<tr class="row-even"><td>r15</td>
<td>stack-pointer</td>
<td>saved</td>
</tr>
<tr class="row-odd"><td>f0</td>
<td>argument 0 / return value ( float/double )</td>
<td>call-clobbered</td>
</tr>
<tr class="row-even"><td>f2</td>
<td>argument 1</td>
<td>call-clobbered</td>
</tr>
<tr class="row-odd"><td>f4</td>
<td>z/Architecture argument 2</td>
<td>saved</td>
</tr>
<tr class="row-even"><td>f6</td>
<td>z/Architecture argument 3</td>
<td>saved</td>
</tr>
</tbody>
</table>
<p>The remaining floating points
f1,f3,f5 f7-f15 are call-clobbered.</p>
<div class="section" id="notes">
<h3>Notes:<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>The only requirement is that registers which are used
by the callee are saved, e.g. the compiler is perfectly
capable of using r11 for purposes other than a frame a
frame pointer if a frame pointer is not needed.</li>
<li>In functions with variable arguments e.g. printf the calling procedure
is identical to one without variable arguments &amp; the same number of
parameters. However, the prologue of this function is somewhat more
hairy owing to it having to move these parameters to the stack to
get va_start, va_arg &amp; va_end to work.</li>
<li>Access registers are currently unused by gcc but are used in
the kernel. Possibilities exist to use them at the moment for
temporary storage but it isn’t recommended.</li>
<li>Only 4 of the floating point registers are used for
parameter passing as older machines such as G3 only have only 4
&amp; it keeps the stack frame compatible with other compilers.
However with IEEE floating point emulation under linux on the
older machines you are free to use the other 12.</li>
<li>A long long or double parameter cannot be have the
first 4 bytes in a register &amp; the second four bytes in the
outgoing args area. It must be purely in the outgoing args
area if crossing this boundary.</li>
<li>Floating point parameters are mixed with outgoing args
on the outgoing args area in the order the are passed in as parameters.</li>
<li>Floating point arguments 2 &amp; 3 are saved in the outgoing args area for
z/Architecture</li>
</ol>
</div>
<div class="section" id="stack-frame-layout">
<h3>Stack Frame Layout<a class="headerlink" href="#stack-frame-layout" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="12%" />
<col width="18%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">s/390</th>
<th class="head">z/Architecture</th>
<th class="head">&#160;</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0</td>
<td>0</td>
<td>back chain ( a 0 here signifies end of back chain )</td>
</tr>
<tr class="row-odd"><td>4</td>
<td>8</td>
<td>eos ( end of stack, not used on Linux for S390 used
in other linkage formats )</td>
</tr>
<tr class="row-even"><td>8</td>
<td>16</td>
<td>glue used in other s/390 linkage formats for saved
routine descriptors etc.</td>
</tr>
<tr class="row-odd"><td>12</td>
<td>24</td>
<td>glue used in other s/390 linkage formats for saved
routine descriptors etc.</td>
</tr>
<tr class="row-even"><td>16</td>
<td>32</td>
<td>scratch area</td>
</tr>
<tr class="row-odd"><td>20</td>
<td>40</td>
<td>scratch area</td>
</tr>
<tr class="row-even"><td>24</td>
<td>48</td>
<td>saved r6 of caller function</td>
</tr>
<tr class="row-odd"><td>28</td>
<td>56</td>
<td>saved r7 of caller function</td>
</tr>
<tr class="row-even"><td>32</td>
<td>64</td>
<td>saved r8 of caller function</td>
</tr>
<tr class="row-odd"><td>36</td>
<td>72</td>
<td>saved r9 of caller function</td>
</tr>
<tr class="row-even"><td>40</td>
<td>80</td>
<td>saved r10 of caller function</td>
</tr>
<tr class="row-odd"><td>44</td>
<td>88</td>
<td>saved r11 of caller function</td>
</tr>
<tr class="row-even"><td>48</td>
<td>96</td>
<td>saved r12 of caller function</td>
</tr>
<tr class="row-odd"><td>52</td>
<td>104</td>
<td>saved r13 of caller function</td>
</tr>
<tr class="row-even"><td>56</td>
<td>112</td>
<td>saved r14 of caller function</td>
</tr>
<tr class="row-odd"><td>60</td>
<td>120</td>
<td>saved r15 of caller function</td>
</tr>
<tr class="row-even"><td>64</td>
<td>128</td>
<td>saved f4 of caller function</td>
</tr>
<tr class="row-odd"><td>72</td>
<td>132</td>
<td>saved f6 of caller function</td>
</tr>
<tr class="row-even"><td>80</td>
<td>&#160;</td>
<td>undefined</td>
</tr>
<tr class="row-odd"><td>96</td>
<td>160</td>
<td>outgoing args passed from caller to callee</td>
</tr>
<tr class="row-even"><td>96+x</td>
<td>160+x</td>
<td>possible stack alignment ( 8 bytes desirable )</td>
</tr>
<tr class="row-odd"><td>96+x+y</td>
<td>160+x+y</td>
<td>alloca space of caller ( if used )</td>
</tr>
<tr class="row-even"><td>96+x+y+z</td>
<td>160+x+y+z</td>
<td>automatics of caller ( if used )</td>
</tr>
<tr class="row-odd"><td>0</td>
<td>&#160;</td>
<td>back-chain</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="a-sample-program-with-comments">
<h2>A sample program with comments.<a class="headerlink" href="#a-sample-program-with-comments" title="Permalink to this headline">¶</a></h2>
<div class="section" id="comments-on-the-function-test">
<h3>Comments on the function test<a class="headerlink" href="#comments-on-the-function-test" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">It didn’t need to set up a pointer to the constant pool gpr13 as it is not
used ( :-( ).</p>
</li>
<li><p class="first">This is a frameless function &amp; no stack is bought.</p>
</li>
<li><p class="first">The compiler was clever enough to recognise that it could return the
value in r2 as well as use it for the passed in parameter ( :-) ).</p>
</li>
<li><p class="first">The basr ( branch relative &amp; save ) trick works as follows the instruction
has a special case with r0,r0 with some instruction operands is understood as
the literal value 0, some risc architectures also do this ). So now
we are branching to the next address &amp; the address new program counter is
in r13,so now we subtract the size of the function prologue we have executed
the size of the literal pool to get to the top of the literal pool:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>0040037c int test(int b)
{                                                     # Function prologue below
  40037c:  90 de f0 34     stm     %r13,%r14,52(%r15) # Save registers r13 &amp; r14
  400380:  0d d0           basr    %r13,%r0           # Set up pointer to constant pool using
  400382:  a7 da ff fa     ahi     %r13,-6            # basr trick
   return(5+b);
                                                      # Huge main program
  400386:  a7 2a 00 05     ahi     %r2,5              # add 5 to r2

                                                      # Function epilogue below
  40038a:  98 de f0 34     lm      %r13,%r14,52(%r15) # restore registers r13 &amp; 14
  40038e:  07 fe           br      %r14               # return
}
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="comments-on-the-function-main">
<h3>Comments on the function main<a class="headerlink" href="#comments-on-the-function-main" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">The compiler did this function optimally ( 8-) ):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Literal pool for main.
400390:    ff ff ff ec     .long 0xffffffec
main(int argc,char *argv[])
{                                                     # Function prologue below
  400394:  90 bf f0 2c     stm     %r11,%r15,44(%r15) # Save necessary registers
  400398:  18 0f           lr      %r0,%r15           # copy stack pointer to r0
  40039a:  a7 fa ff a0     ahi     %r15,-96           # Make area for callee saving
  40039e:  0d d0           basr    %r13,%r0           # Set up r13 to point to
  4003a0:  a7 da ff f0     ahi     %r13,-16           # literal pool
  4003a4:  50 00 f0 00     st      %r0,0(%r15)        # Save backchain

   return(test(5));                                   # Main Program Below
  4003a8:  58 e0 d0 00     l       %r14,0(%r13)       # load relative address of test from
                                                      # literal pool
  4003ac:  a7 28 00 05     lhi     %r2,5              # Set first parameter to 5
  4003b0:  4d ee d0 00     bas     %r14,0(%r14,%r13)  # jump to test setting r14 as return
                                                      # address using branch &amp; save instruction.

                                                      # Function Epilogue below
  4003b4:  98 bf f0 8c     lm      %r11,%r15,140(%r15)# Restore necessary registers.
  4003b8:  07 fe           br      %r14               # return to do program exit
}
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="compiler-updates">
<h3>Compiler updates<a class="headerlink" href="#compiler-updates" title="Permalink to this headline">¶</a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>main(int argc,char *argv[])
{
  4004fc:     90 7f f0 1c             stm     %r7,%r15,28(%r15)
  400500:     a7 d5 00 04             bras    %r13,400508 &lt;main+0xc&gt;
  400504:     00 40 04 f4             .long   0x004004f4
  # compiler now puts constant pool in code to so it saves an instruction
  400508:     18 0f                   lr      %r0,%r15
  40050a:     a7 fa ff a0             ahi     %r15,-96
  40050e:     50 00 f0 00             st      %r0,0(%r15)
      return(test(5));
  400512:     58 10 d0 00             l       %r1,0(%r13)
  400516:     a7 28 00 05             lhi     %r2,5
  40051a:     0d e1                   basr    %r14,%r1
  # compiler adds 1 extra instruction to epilogue this is done to
  # avoid processor pipeline stalls owing to data dependencies on g5 &amp;
  # above as register 14 in the old code was needed directly after being loaded
  # by the lm %r11,%r15,140(%r15) for the br %14.
  40051c:     58 40 f0 98             l       %r4,152(%r15)
  400520:     98 7f f0 7c             lm      %r7,%r15,124(%r15)
  400524:     07 f4                   br      %r4
}
</pre></div>
</div>
<p>Hartmut ( our compiler developer ) also has been threatening to take out the
stack backchain in optimised code as this also causes pipeline stalls, you
have been warned.</p>
</div>
<div class="section" id="bit-z-architecture-code-disassembly">
<h3>64 bit z/Architecture code disassembly<a class="headerlink" href="#bit-z-architecture-code-disassembly" title="Permalink to this headline">¶</a></h3>
<p>If you understand the stuff above you’ll understand the stuff
below too so I’ll avoid repeating myself &amp; just say that
some of the instructions have g’s on the end of them to indicate
they are 64 bit &amp; the stack offsets are a bigger,
the only other difference you’ll find between 32 &amp; 64 bit is that
we now use f4 &amp; f6 for floating point arguments on 64 bit:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>00000000800005b0 &lt;test&gt;:
int test(int b)
{
      return(5+b);
    800005b0: a7 2a 00 05             ahi     %r2,5
    800005b4: b9 14 00 22             lgfr    %r2,%r2 # downcast to integer
    800005b8: 07 fe                   br      %r14
    800005ba: 07 07                   bcr     0,%r7


}

00000000800005bc &lt;main&gt;:
main(int argc,char *argv[])
{
    800005bc: eb bf f0 58 00 24       stmg    %r11,%r15,88(%r15)
    800005c2: b9 04 00 1f             lgr     %r1,%r15
    800005c6: a7 fb ff 60             aghi    %r15,-160
    800005ca: e3 10 f0 00 00 24       stg     %r1,0(%r15)
      return(test(5));
    800005d0: a7 29 00 05             lghi    %r2,5
    # brasl allows jumps &gt; 64k &amp; is overkill here bras would do fune
    800005d4: c0 e5 ff ff ff ee       brasl   %r14,800005b0 &lt;test&gt;
    800005da: e3 40 f1 10 00 04       lg      %r4,272(%r15)
    800005e0: eb bf f0 f8 00 04       lmg     %r11,%r15,248(%r15)
    800005e6: 07 f4                   br      %r4
}
</pre></div>
</div>
</div>
</div>
<div class="section" id="compiling-programs-for-debugging-on-linux-for-s-390-z-architecture">
<h2>Compiling programs for debugging on Linux for s/390 &amp; z/Architecture<a class="headerlink" href="#compiling-programs-for-debugging-on-linux-for-s-390-z-architecture" title="Permalink to this headline">¶</a></h2>
<p>-gdwarf-2 now works it should be considered the default debugging
format for s/390 &amp; z/Architecture as it is more reliable for debugging
shared libraries,  normal -g debugging works much better now
Thanks to the IBM java compiler developers bug reports.</p>
<p>This is typically done adding/appending the flags -g or -gdwarf-2 to the
CFLAGS &amp; LDFLAGS variables Makefile of the program concerned.</p>
<p>If using gdb &amp; you would like accurate displays of registers &amp;
stack traces compile without optimisation i.e make sure
that there is no -O2 or similar on the CFLAGS line of the Makefile &amp;
the emitted gcc commands, obviously this will produce worse code
( not advisable for shipment ) but it is an  aid to the debugging process.</p>
<p>This aids debugging because the compiler will copy parameters passed in
in registers onto the stack so backtracing &amp; looking at passed in
parameters will work, however some larger programs which use inline functions
will not compile without optimisation.</p>
<p>Debugging with optimisation has since much improved after fixing
some bugs, please make sure you are using gdb-5.0 or later developed
after Nov‘2000.</p>
</div>
<div class="section" id="debugging-under-vm">
<h2>Debugging under VM<a class="headerlink" href="#debugging-under-vm" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id1">
<h3>Notes<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Addresses &amp; values in the VM debugger are always hex never decimal
Address ranges are of the format &lt;HexValue1&gt;-&lt;HexValue2&gt; or
&lt;HexValue1&gt;.&lt;HexValue2&gt;
For example, the address range  0x2000 to 0x3000 can be described as 2000-3000
or 2000.1000</p>
<p>The VM Debugger is case insensitive.</p>
<p>VM’s strengths are usually other debuggers weaknesses you can get at any
resource no matter how sensitive e.g. memory management resources, change
address translation in the PSW. For kernel hacking you will reap dividends if
you get good at it.</p>
<p>The VM Debugger displays operators but not operands, and also the debugger
displays useful information on the same line as the author of the code probably
felt that it was a good idea not to go over the 80 columns on the screen.
This isn’t as unintuitive as it may seem as the s/390 instructions are easy to
decode mentally and you can make a good guess at a lot of them as all the
operands are nibble (half byte aligned).
So if you have an objdump listing by hand, it is quite easy to follow, and if
you don’t have an objdump listing keep a copy of the s/390 Reference Summary
or alternatively the s/390 principles of operation next to you.
e.g. even I can guess that
0001AFF8’ LR    180F        CC 0
is a ( load register ) lr r0,r15</p>
<p>Also it is very easy to tell the length of a 390 instruction from the 2 most
significant bits in the instruction (not that this info is really useful except
if you are trying to make sense of a hexdump of code).
Here is a table</p>
<table border="1" class="docutils">
<colgroup>
<col width="56%" />
<col width="44%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Bits</th>
<th class="head">Instruction Length</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>00</td>
<td>2 Bytes</td>
</tr>
<tr class="row-odd"><td>01</td>
<td>4 Bytes</td>
</tr>
<tr class="row-even"><td>10</td>
<td>4 Bytes</td>
</tr>
<tr class="row-odd"><td>11</td>
<td>6 Bytes</td>
</tr>
</tbody>
</table>
<p>The debugger also displays other useful info on the same line such as the
addresses being operated on destination addresses of branches &amp; condition codes.
e.g.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>00019736&#39; AHI   A7DAFF0E    CC 1
000198BA&#39; BRC   A7840004 -&gt; 000198C2&#39;   CC 0
000198CE&#39; STM   900EF068 &gt;&gt; 0FA95E78    CC 2
</pre></div>
</div>
</div>
<div class="section" id="useful-vm-debugger-commands">
<h3>Useful VM debugger commands<a class="headerlink" href="#useful-vm-debugger-commands" title="Permalink to this headline">¶</a></h3>
<p>I suppose I’d better mention this before I start
to list the current active traces do:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Q TR
</pre></div>
</div>
<p>there can be a maximum of 255 of these per set
( more about trace sets later ).</p>
<p>To stop traces issue a:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TR END.
</pre></div>
</div>
<p>To delete a particular breakpoint issue:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TR DEL &lt;breakpoint number&gt;
</pre></div>
</div>
<p>The PA1 key drops to CP mode so you can issue debugger commands,
Doing alt c (on my 3270 console at least ) clears the screen.</p>
<p>hitting b &lt;enter&gt; comes back to the running operating system
from cp mode ( in our case linux ).</p>
<p>It is typically useful to add shortcuts to your profile.exec file
if you have one ( this is roughly equivalent to autoexec.bat in DOS ).
file here are a few from mine:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/* this gives me command history on issuing f12 */
set pf12 retrieve
/* this continues */
set pf8 imm b
/* goes to trace set a */
set pf1 imm tr goto a
/* goes to trace set b */
set pf2 imm tr goto b
/* goes to trace set c */
set pf3 imm tr goto c
</pre></div>
</div>
</div>
<div class="section" id="instruction-tracing">
<h3>Instruction Tracing<a class="headerlink" href="#instruction-tracing" title="Permalink to this headline">¶</a></h3>
<p>Setting a simple breakpoint:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TR I PSWA &lt;address&gt;
</pre></div>
</div>
<p>To debug a particular function try:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TR I R &lt;function address range&gt;
TR I on its own will single step.
TR I DATA &lt;MNEMONIC&gt; &lt;OPTIONAL RANGE&gt; will trace for particular mnemonics
</pre></div>
</div>
<p>e.g.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TR I DATA 4D R 0197BC.4000
</pre></div>
</div>
<p>will trace for BAS’es ( opcode 4D ) in the range 0197BC.4000</p>
<p>if you were inclined you could add traces for all branch instructions &amp;
suffix them with the run prefix so you would have a backtrace on screen
when a program crashes:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TR BR &lt;INTO OR FROM&gt; will trace branches into or out of an address.
</pre></div>
</div>
<p>e.g.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TR BR INTO 0
</pre></div>
</div>
<p>is often quite useful if a program is getting awkward &amp; deciding
to branch to 0 &amp; crashing as this will stop at the address before in jumps to 0.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TR I R &lt;address range&gt; RUN cmd d g
</pre></div>
</div>
<p>single steps a range of addresses but stays running &amp;
displays the gprs on each step.</p>
</div>
<div class="section" id="displaying-modifying-registers">
<h3>Displaying &amp; modifying Registers<a class="headerlink" href="#displaying-modifying-registers" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>D G</dt>
<dd>will display all the gprs</dd>
</dl>
<p>Adding a extra G to all the commands is necessary to access the full 64 bit
content in VM on z/Architecture. Obviously this isn’t required for access
registers as these are still 32 bit.</p>
<p>e.g.</p>
<dl class="docutils">
<dt>DGG</dt>
<dd>instead of DG</dd>
<dt>D X</dt>
<dd>will display all the control registers</dd>
<dt>D AR</dt>
<dd>will display all the access registers</dd>
<dt>D AR4-7</dt>
<dd>will display access registers 4 to 7</dd>
<dt>CPU ALL D G</dt>
<dd>will display the GRPS of all CPUS in the configuration</dd>
<dt>D PSW</dt>
<dd>will display the current PSW</dd>
<dt>st PSW 2000</dt>
<dd>will put the value 2000 into the PSW &amp; cause crash your machine.</dd>
<dt>D PREFIX</dt>
<dd>displays the prefix offset</dd>
</dl>
</div>
<div class="section" id="displaying-memory">
<h3>Displaying Memory<a class="headerlink" href="#displaying-memory" title="Permalink to this headline">¶</a></h3>
<p>To display memory mapped using the current PSW’s mapping try:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>D &lt;range&gt;
</pre></div>
</div>
<p>To make VM display a message each time it hits a particular address and
continue try:</p>
<dl class="docutils">
<dt>D I&lt;range&gt;</dt>
<dd>will disassemble/display a range of instructions.</dd>
<dt>ST addr 32 bit word</dt>
<dd>will store a 32 bit aligned address</dd>
<dt>D T&lt;range&gt;</dt>
<dd>will display the EBCDIC in an address (if you are that way inclined)</dd>
<dt>D R&lt;range&gt;</dt>
<dd>will display real addresses ( without DAT ) but with prefixing.</dd>
</dl>
<p>There are other complex options to display if you need to get at say home space
but are in primary space the easiest thing to do is to temporarily
modify the PSW to the other addressing mode, display the stuff &amp; then
restore it.</p>
</div>
<div class="section" id="hints">
<h3>Hints<a class="headerlink" href="#hints" title="Permalink to this headline">¶</a></h3>
<p>If you want to issue a debugger command without halting your virtual machine
with the PA1 key try prefixing the command with #CP e.g.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#cp tr i pswa 2000
</pre></div>
</div>
<p>also suffixing most debugger commands with RUN will cause them not
to stop just display the mnemonic at the current instruction on the console.</p>
<p>If you have several breakpoints you want to put into your program &amp;
you get fed up of cross referencing with System.map
you can do the following trick for several symbols.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>grep do_signal System.map
</pre></div>
</div>
<p>which emits the following among other things:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>0001f4e0 T do_signal
</pre></div>
</div>
<p>now you can do:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TR I PSWA 0001f4e0 cmd msg * do_signal
</pre></div>
</div>
<p>This sends a message to your own console each time do_signal is entered.
( As an aside I wrote a perl script once which automatically generated a REXX
script with breakpoints on every kernel procedure, this isn’t a good idea
because there are thousands of these routines &amp; VM can only set 255 breakpoints
at a time so you nearly had to spend as long pruning the file down as you would
entering the msgs by hand), however, the trick might be useful for a single
object file. In the 3270 terminal emulator x3270 there is a very useful option
in the file menu called “Save Screen In File” - this is very good for keeping a
copy of traces.</p>
<p>From CMS help &lt;command name&gt; will give you online help on a particular command.
e.g.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>HELP DISPLAY
</pre></div>
</div>
<p>Also CP has a file called profile.exec which automatically gets called
on startup of CMS ( like autoexec.bat ), keeping on a DOS analogy session
CP has a feature similar to doskey, it may be useful for you to
use profile.exec to define some keystrokes.</p>
<dl class="docutils">
<dt>SET PF9 IMM B</dt>
<dd>This does a single step in VM on pressing F8.</dd>
<dt>SET PF10  ^</dt>
<dd>This sets up the ^ key.
which can be used for ^c (ctrl-c),^z (ctrl-z) which can’t be typed
directly into some 3270 consoles.</dd>
<dt>SET PF11 ^-</dt>
<dd>This types the starting keystrokes for a sysrq see SysRq below.</dd>
<dt>SET PF12 RETRIEVE</dt>
<dd>This retrieves command history on pressing F12.</dd>
</dl>
<p>Sometimes in VM the display is set up to scroll automatically this
can be very annoying if there are messages you wish to look at
to stop this do</p>
<dl class="docutils">
<dt>TERM MORE 255 255</dt>
<dd>This will nearly stop automatic screen updates, however it will
cause a denial of service if lots of messages go to the 3270 console,
so it would be foolish to use this as the default on a production machine.</dd>
</dl>
</div>
<div class="section" id="tracing-particular-processes">
<h3>Tracing particular processes<a class="headerlink" href="#tracing-particular-processes" title="Permalink to this headline">¶</a></h3>
<p>The kernel’s text segment is intentionally at an address in memory that it will
very seldom collide with text segments of user programs ( thanks Martin ),
this simplifies debugging the kernel.
However it is quite common for user processes to have addresses which collide
this can make debugging a particular process under VM painful under normal
circumstances as the process may change when doing a:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TR I R &lt;address range&gt;.
</pre></div>
</div>
<p>Thankfully after reading VM’s online help I figured out how to debug
I particular process.</p>
<p>Your first problem is to find the STD ( segment table designation )
of the program you wish to debug.
There are several ways you can do this here are a few</p>
<p>Run:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>objdump --syms &lt;program to be debugged&gt; | grep main
</pre></div>
</div>
<p>To get the address of main in the program. Then:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>tr i pswa &lt;address of main&gt;
</pre></div>
</div>
<p>Start the program, if VM drops to CP on what looks like the entry
point of the main function this is most likely the process you wish to debug.
Now do a D X13 or D XG13 on z/Architecture.</p>
<p>On 31 bit the STD is bits 1-19 ( the STO segment table origin )
&amp; 25-31 ( the STL segment table length ) of CR13.</p>
<p>now type:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TR I R STD &lt;CR13&#39;s value&gt; 0.7fffffff
</pre></div>
</div>
<p>e.g.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TR I R STD 8F32E1FF 0.7fffffff
</pre></div>
</div>
<p>Another very useful variation is:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TR STORE INTO STD &lt;CR13&#39;s value&gt; &lt;address range&gt;
</pre></div>
</div>
<p>for finding out when a particular variable changes.</p>
<p>An alternative way of finding the STD of a currently running process
is to do the following, ( this method is more complex but
could be quite convenient if you aren’t updating the kernel much &amp;
so your kernel structures will stay constant for a reasonable period of
time ).</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>grep task /proc/&lt;pid&gt;/status
</pre></div>
</div>
<p>from this you should see something like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>task: 0f160000 ksp: 0f161de8 pt_regs: 0f161f68
</pre></div>
</div>
<p>This now gives you a pointer to the task structure.</p>
<p>Now make:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CC:=&quot;s390-gcc -g&quot; kernel/sched.s
</pre></div>
</div>
<p>To get the task_struct stabinfo.</p>
<p>( task_struct is defined in include/linux/sched.h ).</p>
<p>Now we want to look at
task-&gt;active_mm-&gt;pgd</p>
<p>on my machine the active_mm in the task structure stab is
active_mm:(4,12),672,32</p>
<p>its offset is 672/8=84=0x54</p>
<p>the pgd member in the mm_struct stab is
pgd:(4,6)=*(29,5),96,32
so its offset is 96/8=12=0xc</p>
<p>so we’ll:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>hexdump -s 0xf160054 /dev/mem | more
</pre></div>
</div>
<p>i.e. task_struct+active_mm offset
to look at the active_mm member:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>f160054 0fee cc60 0019 e334 0000 0000 0000 0011
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>hexdump -s 0x0feecc6c /dev/mem | more
</pre></div>
</div>
<p>i.e. active_mm+pgd offset:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>feecc6c 0f2c 0000 0000 0001 0000 0001 0000 0010
</pre></div>
</div>
<p>we get something like
now do:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TR I R STD &lt;pgd|0x7f&gt; 0.7fffffff
</pre></div>
</div>
<p>i.e. the 0x7f is added because the pgd only
gives the page table origin &amp; we need to set the low bits
to the maximum possible segment table length.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TR I R STD 0f2c007f 0.7fffffff
</pre></div>
</div>
<p>on z/Architecture you’ll probably need to do:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TR I R STD &lt;pgd|0x7&gt; 0.ffffffffffffffff
</pre></div>
</div>
<p>to set the TableType to 0x1 &amp; the Table length to 3.</p>
</div>
<div class="section" id="tracing-program-exceptions">
<h3>Tracing Program Exceptions<a class="headerlink" href="#tracing-program-exceptions" title="Permalink to this headline">¶</a></h3>
<p>If you get a crash which says something like
illegal operation or specification exception followed by a register dump
You can restart linux &amp; trace these using the tr prog &lt;range or value&gt; trace
option.</p>
<p>The most common ones you will normally be tracing for is:</p>
<ul class="simple">
<li>1=operation exception</li>
<li>2=privileged operation exception</li>
<li>4=protection exception</li>
<li>5=addressing exception</li>
<li>6=specification exception</li>
<li>10=segment translation exception</li>
<li>11=page translation exception</li>
</ul>
<p>The full list of these is on page 22 of the current s/390 Reference Summary.
e.g.</p>
<p>tr prog 10 will trace segment translation exceptions.</p>
<p>tr prog on its own will trace all program interruption codes.</p>
</div>
<div class="section" id="trace-sets">
<h3>Trace Sets<a class="headerlink" href="#trace-sets" title="Permalink to this headline">¶</a></h3>
<p>On starting VM you are initially in the INITIAL trace set.
You can do a Q TR to verify this.
If you have a complex tracing situation where you wish to wait for instance
till a driver is open before you start tracing IO, but know in your
heart that you are going to have to make several runs through the code till you
have a clue whats going on.</p>
<p>What you can do is:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TR I PSWA &lt;Driver open address&gt;
</pre></div>
</div>
<p>hit b to continue till breakpoint</p>
<p>reach the breakpoint</p>
<p>now do your:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TR GOTO B
TR IO 7c08-7c09 inst int run
</pre></div>
</div>
<p>or whatever the IO channels you wish to trace are &amp; hit b</p>
<p>To got back to the initial trace set do:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TR GOTO INITIAL
</pre></div>
</div>
<p>&amp; the TR I PSWA &lt;Driver open address&gt; will be the only active breakpoint again.</p>
</div>
<div class="section" id="tracing-linux-syscalls-under-vm">
<h3>Tracing linux syscalls under VM<a class="headerlink" href="#tracing-linux-syscalls-under-vm" title="Permalink to this headline">¶</a></h3>
<p>Syscalls are implemented on Linux for S390 by the Supervisor call instruction
(SVC). There 256 possibilities of these as the instruction is made up of a 0xA
opcode and the second byte being the syscall number. They are traced using the
simple command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TR SVC  &lt;Optional value or range&gt;
</pre></div>
</div>
<p>the syscalls are defined in linux/arch/s390/include/asm/unistd.h
e.g. to trace all file opens just do:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TR SVC 5 ( as this is the syscall number of open )
</pre></div>
</div>
</div>
<div class="section" id="smp-specific-commands">
<h3>SMP Specific commands<a class="headerlink" href="#smp-specific-commands" title="Permalink to this headline">¶</a></h3>
<p>To find out how many cpus you have
Q CPUS displays all the CPU’s available to your virtual machine
To find the cpu that the current cpu VM debugger commands are being directed at
do Q CPU to change the current cpu VM debugger commands are being directed at
do:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CPU &lt;desired cpu no&gt;
</pre></div>
</div>
<p>On a SMP guest issue a command to all CPUs try prefixing the command with cpu
all. To issue a command to a particular cpu try cpu &lt;cpu number&gt; e.g.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CPU 01 TR I R 2000.3000
</pre></div>
</div>
<p>If you are running on a guest with several cpus &amp; you have a IO related problem
&amp; cannot follow the flow of code but you know it isn’t smp related.</p>
<p>from the bash prompt issue:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>shutdown -h now or halt.
</pre></div>
</div>
<p>do a:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Q CPUS
</pre></div>
</div>
<p>to find out how many cpus you have detach each one of them from cp except
cpu 0 by issuing a:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DETACH CPU 01-(number of cpus in configuration)
</pre></div>
</div>
<p>&amp; boot linux again.</p>
<dl class="docutils">
<dt>TR SIGP</dt>
<dd>will trace inter processor signal processor instructions.</dd>
<dt>DEFINE CPU 01-(number in configuration)</dt>
<dd>will get your guests cpus back.</dd>
</dl>
</div>
<div class="section" id="help-for-displaying-ascii-textstrings">
<h3>Help for displaying ascii textstrings<a class="headerlink" href="#help-for-displaying-ascii-textstrings" title="Permalink to this headline">¶</a></h3>
<p>On the very latest VM Nucleus’es VM can now display ascii
( thanks Neale for the hint ) by doing:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>D TX&lt;lowaddr&gt;.&lt;len&gt;
</pre></div>
</div>
<p>e.g.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>D TX0.100
</pre></div>
</div>
</div>
</div>
<div class="section" id="alternatively">
<h2>Alternatively<a class="headerlink" href="#alternatively" title="Permalink to this headline">¶</a></h2>
<p>Under older VM debuggers (I love EBDIC too) you can use following little
program which converts a command line of hex digits to ascii text. It can be
compiled under linux and you can copy the hex digits from your x3270 terminal
to your xterm if you are debugging from a linuxbox.</p>
<p>This is quite useful when looking at a parameter passed in as a text string
under VM ( unless you are good at decoding ASCII in your head ).</p>
<p>e.g. consider tracing an open syscall:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TR SVC 5
</pre></div>
</div>
<p>We have stopped at a breakpoint:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>000151B0&#39; SVC   0A05     -&gt; 0001909A&#39;   CC 0
</pre></div>
</div>
<p>D 20.8 to check the SVC old psw in the prefix area and see was it from userspace
(for the layout of the prefix area consult the “Fixed Storage Locations”
chapter of the s/390 Reference Summary if you have it available).</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>V00000020  070C2000 800151B2
</pre></div>
</div>
<p>The problem state bit wasn’t set &amp;  it’s also too early in the boot sequence
for it to be a userspace SVC if it was we would have to temporarily switch the
psw to user space addressing so we could get at the first parameter of the open
in gpr2.</p>
<p>Next do a:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>D G2
GPR  2 =  00014CB4
</pre></div>
</div>
<p>Now display what gpr2 is pointing to:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>D 00014CB4.20
V00014CB4  2F646576 2F636F6E 736F6C65 00001BF5
V00014CC4  FC00014C B4001001 E0001000 B8070707
</pre></div>
</div>
<p>Now copy the text till the first 00 hex ( which is the end of the string
to an xterm &amp; do hex2ascii on it:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>hex2ascii 2F646576 2F636F6E 736F6C65 00
</pre></div>
</div>
<p>outputs:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Decoded Hex:=/ d e v / c o n s o l e 0x00
</pre></div>
</div>
<p>We were opening the console device,</p>
<p>You can compile the code below yourself for practice :-),</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/*
 *    hex2ascii.c
 *    a useful little tool for converting a hexadecimal command line to ascii
 *
 *    Author(s): Denis Joseph Barrow (djbarrow@de.ibm.com,barrow_dj@yahoo.com)
 *    (C) 2000 IBM Deutschland Entwicklung GmbH, IBM Corporation.
 */
#include &lt;stdio.h&gt;

int main(int argc,char *argv[])
{
  int cnt1,cnt2,len,toggle=0;
  int startcnt=1;
  unsigned char c,hex;

  if(argc&gt;1&amp;&amp;(strcmp(argv[1],&quot;-a&quot;)==0))
     startcnt=2;
  printf(&quot;Decoded Hex:=&quot;);
  for(cnt1=startcnt;cnt1&lt;argc;cnt1++)
  {
    len=strlen(argv[cnt1]);
    for(cnt2=0;cnt2&lt;len;cnt2++)
    {
       c=argv[cnt1][cnt2];
       if(c&gt;=&#39;0&#39;&amp;&amp;c&lt;=&#39;9&#39;)
        c=c-&#39;0&#39;;
       if(c&gt;=&#39;A&#39;&amp;&amp;c&lt;=&#39;F&#39;)
        c=c-&#39;A&#39;+10;
       if(c&gt;=&#39;a&#39;&amp;&amp;c&lt;=&#39;f&#39;)
        c=c-&#39;a&#39;+10;
       switch(toggle)
       {
        case 0:
           hex=c&lt;&lt;4;
           toggle=1;
        break;
        case 1:
           hex+=c;
           if(hex&lt;32||hex&gt;127)
           {
              if(startcnt==1)
                 printf(&quot;0x%02X &quot;,(int)hex);
              else
                 printf(&quot;.&quot;);
           }
           else
           {
             printf(&quot;%c&quot;,hex);
             if(startcnt==1)
                printf(&quot; &quot;);
           }
           toggle=0;
        break;
       }
    }
  }
  printf(&quot;\n&quot;);
}
</pre></div>
</div>
<div class="section" id="stack-tracing-under-vm">
<h3>Stack tracing under VM<a class="headerlink" href="#stack-tracing-under-vm" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="a-basic-backtrace">
<h3>A basic backtrace<a class="headerlink" href="#a-basic-backtrace" title="Permalink to this headline">¶</a></h3>
<p>Here are the tricks I use 9 out of 10 times it works pretty well,</p>
</div>
<div class="section" id="when-your-backchain-reaches-a-dead-end">
<h3>When your backchain reaches a dead end<a class="headerlink" href="#when-your-backchain-reaches-a-dead-end" title="Permalink to this headline">¶</a></h3>
<p>This can happen when an exception happens in the kernel and the kernel is
entered twice. If you reach the NULL pointer at the end of the back chain you
should be able to sniff further back if you follow the following tricks.
1) A kernel address should be easy to recognise since it is in
primary space &amp; the problem state bit isn’t set &amp; also
The Hi bit of the address is set.
2) Another backchain should also be easy to recognise since it is an
address pointing to another address approximately 100 bytes or 0x70 hex
behind the current stackpointer.</p>
<p>Here is some practice.</p>
<p>boot the kernel &amp; hit PA1 at some random time</p>
<p>d g to display the gprs, this should display something like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>GPR  0 =  00000001  00156018  0014359C  00000000
GPR  4 =  00000001  001B8888  000003E0  00000000
GPR  8 =  00100080  00100084  00000000  000FE000
GPR 12 =  00010400  8001B2DC  8001B36A  000FFED8
</pre></div>
</div>
<p>Note that GPR14 is a return address but as we are real men we are going to
trace the stack.
display 0x40 bytes after the stack pointer:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>V000FFED8  000FFF38 8001B838 80014C8E 000FFF38
V000FFEE8  00000000 00000000 000003E0 00000000
V000FFEF8  00100080 00100084 00000000 000FE000
V000FFF08  00010400 8001B2DC 8001B36A 000FFED8
</pre></div>
</div>
<p>Ah now look at whats in sp+56 (sp+0x38) this is 8001B36A our saved r14 if
you look above at our stackframe &amp; also agrees with GPR14.</p>
<p>now backchain:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>d 000FFF38.40
</pre></div>
</div>
<p>we now are taking the contents of SP to get our first backchain:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>V000FFF38  000FFFA0 00000000 00014995 00147094
V000FFF48  00147090 001470A0 000003E0 00000000
V000FFF58  00100080 00100084 00000000 001BF1D0
V000FFF68  00010400 800149BA 80014CA6 000FFF38
</pre></div>
</div>
<p>This displays a 2nd return address of 80014CA6</p>
<p>now do:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>d 000FFFA0.40
</pre></div>
</div>
<p>for our 3rd backchain:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>V000FFFA0  04B52002 0001107F 00000000 00000000
V000FFFB0  00000000 00000000 FF000000 0001107F
V000FFFC0  00000000 00000000 00000000 00000000
V000FFFD0  00010400 80010802 8001085A 000FFFA0
</pre></div>
</div>
<p>our 3rd return address is 8001085A</p>
<p>as the 04B52002 looks suspiciously like rubbish it is fair to assume that the
kernel entry routines for the sake of optimisation don’t set up a backchain.</p>
<p>now look at System.map to see if the addresses make any sense:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>grep -i 0001b3 System.map
</pre></div>
</div>
<p>outputs among other things:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>0001b304 T cpu_idle
</pre></div>
</div>
<p>so 8001B36A
is cpu_idle+0x66 ( quiet the cpu is asleep, don’t wake it )</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>grep -i 00014 System.map
</pre></div>
</div>
<p>produces among other things:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>00014a78 T start_kernel
</pre></div>
</div>
<p>so 0014CA6 is start_kernel+some hex number I can’t add in my head.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>grep -i 00108 System.map
</pre></div>
</div>
<p>this produces:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>00010800 T _stext
</pre></div>
</div>
<p>so   8001085A is _stext+0x5a</p>
<p>Congrats you’ve done your first backchain.</p>
</div>
</div>
<div class="section" id="s-390-z-architecture-io-overview">
<h2>s/390 &amp; z/Architecture IO Overview<a class="headerlink" href="#s-390-z-architecture-io-overview" title="Permalink to this headline">¶</a></h2>
<p>I am not going to give a course in 390 IO architecture as this would take me
quite a while and I’m no expert. Instead I’ll give a 390 IO architecture
summary for Dummies. If you have the s/390 principles of operation available
read this instead. If nothing else you may find a few useful keywords in here
and be able to use them on a web search engine to find more useful information.</p>
<p>Unlike other bus architectures modern 390 systems do their IO using mostly
fibre optics and devices such as tapes and disks can be shared between several
mainframes. Also S390 can support up to 65536 devices while a high end PC based
system might be choking with around 64.</p>
<p>Here is some of the common IO terminology:</p>
<dl class="docutils">
<dt>Subchannel:</dt>
<dd><p class="first">This is the logical number most IO commands use to talk to an IO device. There
can be up to 0x10000 (65536) of these in a configuration, typically there are a
few hundred. Under VM for simplicity they are allocated contiguously, however
on the native hardware they are not. They typically stay consistent between
boots provided no new hardware is inserted or removed.</p>
<p class="last">Under Linux for s390 we use these as IRQ’s and also when issuing an IO command
(CLEAR SUBCHANNEL, HALT SUBCHANNEL, MODIFY SUBCHANNEL, RESUME SUBCHANNEL,
START SUBCHANNEL, STORE SUBCHANNEL and TEST SUBCHANNEL). We use this as the ID
of the device we wish to talk to. The most important of these instructions are
START SUBCHANNEL (to start IO), TEST SUBCHANNEL (to check whether the IO
completed successfully) and HALT SUBCHANNEL (to kill IO). A subchannel can have
up to 8 channel paths to a device, this offers redundancy if one is not
available.</p>
</dd>
<dt>Device Number:</dt>
<dd>This number remains static and is closely tied to the hardware. There are 65536
of these, made up of a CHPID (Channel Path ID, the most significant 8 bits) and
another lsb 8 bits. These remain static even if more devices are inserted or
removed from the hardware. There is a 1 to 1 mapping between subchannels and
device numbers, provided devices aren’t inserted or removed.</dd>
<dt>Channel Control Words:</dt>
<dd><p class="first">CCWs are linked lists of instructions initially pointed to by an operation
request block (ORB), which is initially given to Start Subchannel (SSCH)
command along with the subchannel number for the IO subsystem to process
while the CPU continues executing normal code.
CCWs come in two flavours, Format 0 (24 bit for backward compatibility) and
Format 1 (31 bit). These are typically used to issue read and write (and many
other) instructions. They consist of a length field and an absolute address
field.</p>
<p class="last">Each IO typically gets 1 or 2 interrupts, one for channel end (primary status)
when the channel is idle, and the second for device end (secondary status).
Sometimes you get both concurrently. You check how the IO went on by issuing a
TEST SUBCHANNEL at each interrupt, from which you receive an Interruption
response block (IRB). If you get channel and device end status in the IRB
without channel checks etc. your IO probably went okay. If you didn’t you
probably need to examine the IRB, extended status word etc.
If an error occurs, more sophisticated control units have a facility known as
concurrent sense. This means that if an error occurs Extended sense information
will be presented in the Extended status word in the IRB. If not you have to
issue a subsequent SENSE CCW command after the test subchannel.</p>
</dd>
</dl>
<p>TPI (Test pending interrupt) can also be used for polled IO, but in
multitasking multiprocessor systems it isn’t recommended except for
checking special cases (i.e. non looping checks for pending IO etc.).</p>
<p>Store Subchannel and Modify Subchannel can be used to examine and modify
operating characteristics of a subchannel (e.g. channel paths).</p>
<p>Other IO related Terms:</p>
<dl class="docutils">
<dt>Sysplex:</dt>
<dd>S390’s Clustering Technology</dd>
<dt>QDIO:</dt>
<dd>S390’s new high speed IO architecture to support devices such as gigabit
ethernet, this architecture is also designed to be forward compatible with
upcoming 64 bit machines.</dd>
</dl>
<div class="section" id="general-concepts">
<h3>General Concepts<a class="headerlink" href="#general-concepts" title="Permalink to this headline">¶</a></h3>
<p>Input Output Processors (IOP’s) are responsible for communicating between
the mainframe CPU’s &amp; the channel &amp; relieve the mainframe CPU’s from the
burden of communicating with IO devices directly, this allows the CPU’s to
concentrate on data processing.</p>
<p>IOP’s can use one or more links ( known as channel paths ) to talk to each
IO device. It first checks for path availability &amp; chooses an available one,
then starts ( &amp; sometimes terminates IO ).
There are two types of channel path: ESCON &amp; the Parallel IO interface.</p>
<p>IO devices are attached to control units, control units provide the
logic to interface the channel paths &amp; channel path IO protocols to
the IO devices, they can be integrated with the devices or housed separately
&amp; often talk to several similar devices ( typical examples would be raid
controllers or a control unit which connects to 1000 3270 terminals ):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>    +---------------------------------------------------------------+
    | +-----+ +-----+ +-----+ +-----+  +----------+  +----------+   |
    | | CPU | | CPU | | CPU | | CPU |  |  Main    |  | Expanded |   |
    | |     | |     | |     | |     |  |  Memory  |  |  Storage |   |
    | +-----+ +-----+ +-----+ +-----+  +----------+  +----------+   |
    |---------------------------------------------------------------+
    |   IOP        |      IOP      |       IOP                      |
    |---------------------------------------------------------------
    | C | C | C | C | C | C | C | C | C | C | C | C | C | C | C | C |
    ----------------------------------------------------------------
         ||                                              ||
         ||  Bus &amp; Tag Channel Path                      || ESCON
         ||  ======================                      || Channel
         ||  ||                  ||                      || Path
    +----------+               +----------+         +----------+
    |          |               |          |         |          |
    |    CU    |               |    CU    |         |    CU    |
    |          |               |          |         |          |
    +----------+               +----------+         +----------+
       |      |                     |                |       |
+----------+ +----------+      +----------+   +----------+ +----------+
|I/O Device| |I/O Device|      |I/O Device|   |I/O Device| |I/O Device|
+----------+ +----------+      +----------+   +----------+ +----------+
  CPU = Central Processing Unit
  C = Channel
  IOP = IP Processor
  CU = Control Unit
</pre></div>
</div>
<p>The 390 IO systems come in 2 flavours the current 390 machines support both</p>
<p>The Older 360 &amp; 370 Interface,sometimes called the Parallel I/O interface,
sometimes called Bus-and Tag &amp; sometimes Original Equipment Manufacturers
Interface (OEMI).</p>
<p>This byte wide Parallel channel path/bus has parity &amp; data on the “Bus” cable
and control lines on the “Tag” cable. These can operate in byte multiplex mode
for sharing between several slow devices or burst mode and monopolize the
channel for the whole burst. Up to 256 devices can be addressed on one of these
cables. These cables are about one inch in diameter. The maximum unextended
length supported by these cables is 125 Meters but this can be extended up to
2km with a fibre optic channel extended such as a 3044. The maximum burst speed
supported is 4.5 megabytes per second. However, some really old processors
support only transfer rates of 3.0, 2.0 &amp; 1.0 MB/sec.
One of these paths can be daisy chained to up to 8 control units.</p>
<p>ESCON if fibre optic it is also called FICON
Was introduced by IBM in 1990. Has 2 fibre optic cables and uses either leds or
lasers for communication at a signaling rate of up to 200 megabits/sec. As
10bits are transferred for every 8 bits info this drops to 160 megabits/sec
and to 18.6 Megabytes/sec once control info and CRC are added. ESCON only
operates in burst mode.</p>
<p>ESCONs typical max cable length is 3km for the led version and 20km for the
laser version known as XDF (extended distance facility). This can be further
extended by using an ESCON director which triples the above mentioned ranges.
Unlike Bus &amp; Tag as ESCON is serial it uses a packet switching architecture,
the standard Bus &amp; Tag control protocol is however present within the packets.
Up to 256 devices can be attached to each control unit that uses one of these
interfaces.</p>
<p>Common 390 Devices include:
Network adapters typically OSA2,3172’s,2116’s &amp; OSA-E gigabit ethernet adapters,
Consoles 3270 &amp; 3215 (a teletype emulated under linux for a line mode console).
DASD’s direct access storage devices ( otherwise known as hard disks ).
Tape Drives.
CTC ( Channel to Channel Adapters ),
ESCON or Parallel Cables used as a very high speed serial link
between 2 machines.</p>
</div>
</div>
<div class="section" id="debugging-io-on-s-390-z-architecture-under-vm">
<h2>Debugging IO on s/390 &amp; z/Architecture under VM<a class="headerlink" href="#debugging-io-on-s-390-z-architecture-under-vm" title="Permalink to this headline">¶</a></h2>
<p>Now we are ready to go on with IO tracing commands under VM</p>
<p>A few self explanatory queries:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Q OSA
Q CTC
Q DISK ( This command is CMS specific )
Q DASD
</pre></div>
</div>
<p>Q OSA on my machine returns:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>OSA  7C08 ON OSA   7C08 SUBCHANNEL = 0000
OSA  7C09 ON OSA   7C09 SUBCHANNEL = 0001
OSA  7C14 ON OSA   7C14 SUBCHANNEL = 0002
OSA  7C15 ON OSA   7C15 SUBCHANNEL = 0003
</pre></div>
</div>
<p>If you have a guest with certain privileges you may be able to see devices
which don’t belong to you. To avoid this, add the option V.
e.g.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Q V OSA
</pre></div>
</div>
<p>Now using the device numbers returned by this command we will
Trace the io starting up on the first device 7c08 &amp; 7c09
In our simplest case we can trace the
start subchannels
like TR SSCH 7C08-7C09
or the halt subchannels
or TR HSCH 7C08-7C09
MSCH’s ,STSCH’s I think you can guess the rest</p>
<p>A good trick is tracing all the IO’s and CCWS and spooling them into the reader
of another VM guest so he can ftp the logfile back to his own machine. I’ll do
a small bit of this and give you a look at the output.</p>
<ol class="arabic">
<li><p class="first">Spool stdout to VM reader:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>SP PRT TO (another vm guest ) or * for the local vm guest
</pre></div>
</div>
</li>
<li><p class="first">Fill the reader with the trace:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TR IO 7c08-7c09 INST INT CCW PRT RUN
</pre></div>
</div>
</li>
<li><p class="first">Start up linux:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>i 00c
</pre></div>
</div>
</li>
<li><p class="first">Finish the trace:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TR END
</pre></div>
</div>
</li>
<li><p class="first">close the reader:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>C PRT
</pre></div>
</div>
</li>
<li><p class="first">list reader contents:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>RDRLIST
</pre></div>
</div>
</li>
<li><p class="first">copy it to linux4’s minidisk:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>RECEIVE / LOG TXT A1 ( replace
</pre></div>
</div>
</li>
</ol>
<p>8)
filel &amp; press F11 to look at it
You should see something like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>00020942&#39; SSCH  B2334000    0048813C    CC 0    SCH 0000    DEV 7C08
          CPA 000FFDF0   PARM 00E2C9C4    KEY 0  FPI C0  LPM 80
          CCW    000FFDF0  E4200100 00487FE8   0000  E4240100 ........
          IDAL                                      43D8AFE8
          IDAL                                      0FB76000
00020B0A&#39;   I/O DEV 7C08 -&gt; 000197BC&#39;   SCH 0000   PARM 00E2C9C4
00021628&#39; TSCH  B2354000 &gt;&gt; 00488164    CC 0    SCH 0000    DEV 7C08
          CCWA 000FFDF8   DEV STS 0C  SCH STS 00  CNT 00EC
           KEY 0   FPI C0  CC 0   CTLS 4007
00022238&#39; STSCH B2344000 &gt;&gt; 00488108    CC 0    SCH 0000    DEV 7C08
</pre></div>
</div>
<p>If you don’t like messing up your readed ( because you possibly booted from it )
you can alternatively spool it to another readers guest.</p>
<div class="section" id="other-common-vm-device-related-commands">
<h3>Other common VM device related commands<a class="headerlink" href="#other-common-vm-device-related-commands" title="Permalink to this headline">¶</a></h3>
<p>These commands are listed only because they have
been of use to me in the past &amp; may be of use to
you too. For more complete info on each of the commands
use type HELP &lt;command&gt; from CMS.</p>
<p>detaching devices:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DET &lt;devno range&gt;
ATT &lt;devno range&gt; &lt;guest&gt;
</pre></div>
</div>
<p>attach a device to guest * for your own guest</p>
<dl class="docutils">
<dt>READY &lt;devno&gt;</dt>
<dd>cause VM to issue a fake interrupt.</dd>
</dl>
<p>The VARY command is normally only available to VM administrators:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>VARY ON PATH &lt;path&gt; TO &lt;devno range&gt;
VARY OFF PATH &lt;PATH&gt; FROM &lt;devno range&gt;
</pre></div>
</div>
<p>This is used to switch on or off channel paths to devices.</p>
<dl class="docutils">
<dt>Q CHPID &lt;channel path ID&gt;</dt>
<dd>This displays state of devices using this channel path</dd>
<dt>D SCHIB &lt;subchannel&gt;</dt>
<dd>This displays the subchannel information SCHIB block for the device.
this I believe is also only available to administrators.</dd>
<dt>DEFINE CTC &lt;devno&gt;</dt>
<dd>defines a virtual CTC channel to channel connection
2 need to be defined on each guest for the CTC driver to use.</dd>
<dt>COUPLE  devno userid remote devno</dt>
<dd>Joins a local virtual device to a remote virtual device
( commonly used for the CTC driver ).</dd>
</dl>
<p>Building a VM ramdisk under CMS which linux can use:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>def vfb-&lt;blocksize&gt; &lt;subchannel&gt; &lt;number blocks&gt;
</pre></div>
</div>
<p>blocksize is commonly 4096 for linux.</p>
<p>Formatting it:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>format &lt;subchannel&gt; &lt;driver letter e.g. x&gt; (blksize &lt;blocksize&gt;
</pre></div>
</div>
<p>Sharing a disk between multiple guests:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>LINK userid devno1 devno2 mode password
</pre></div>
</div>
</div>
</div>
<div class="section" id="gdb-on-s390">
<h2>GDB on S390<a class="headerlink" href="#gdb-on-s390" title="Permalink to this headline">¶</a></h2>
<p>N.B. if compiling for debugging gdb works better without optimisation
( see Compiling programs for debugging )</p>
<div class="section" id="invocation">
<h3>invocation<a class="headerlink" href="#invocation" title="Permalink to this headline">¶</a></h3>
<p>gdb &lt;victim program&gt; &lt;optional corefile&gt;</p>
</div>
<div class="section" id="online-help">
<h3>Online help<a class="headerlink" href="#online-help" title="Permalink to this headline">¶</a></h3>
<p>help: gives help on commands</p>
<p>e.g.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>help
help display
</pre></div>
</div>
<p>Note gdb’s online help is very good use it.</p>
</div>
<div class="section" id="assembly">
<h3>Assembly<a class="headerlink" href="#assembly" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>info registers:</dt>
<dd>displays registers other than floating point.</dd>
<dt>info all-registers:</dt>
<dd>displays floating points as well.</dd>
<dt>disassemble:</dt>
<dd>disassembles</dd>
</dl>
<p>e.g.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>disassemble without parameters will disassemble the current function
disassemble $pc $pc+10
</pre></div>
</div>
</div>
<div class="section" id="viewing-modifying-variables">
<h3>Viewing &amp; modifying variables<a class="headerlink" href="#viewing-modifying-variables" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>print or p:</dt>
<dd>displays variable or register</dd>
</dl>
<p>e.g. p/x $sp will display the stack pointer</p>
<dl class="docutils">
<dt>display:</dt>
<dd>prints variable or register each time program stops</dd>
</dl>
<p>e.g.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>display/x $pc will display the program counter
display argc
</pre></div>
</div>
<dl class="docutils">
<dt>undisplay:</dt>
<dd>undo’s display’s</dd>
<dt>info breakpoints:</dt>
<dd>shows all current breakpoints</dd>
<dt>info stack:</dt>
<dd>shows stack back trace (if this doesn’t work too well, I’ll show
you the stacktrace by hand below).</dd>
<dt>info locals:</dt>
<dd>displays local variables.</dd>
<dt>info args:</dt>
<dd>display current procedure arguments.</dd>
<dt>set args:</dt>
<dd>will set argc &amp; argv each time the victim program is invoked</dd>
</dl>
<p>e.g.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>set &lt;variable&gt;=value
set argc=100
set $pc=0
</pre></div>
</div>
</div>
<div class="section" id="modifying-execution">
<h3>Modifying execution<a class="headerlink" href="#modifying-execution" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>step:</dt>
<dd>steps n lines of sourcecode</dd>
<dt>step</dt>
<dd>steps 1 line.</dd>
<dt>step 100</dt>
<dd>steps 100 lines of code.</dd>
<dt>next:</dt>
<dd>like step except this will not step into subroutines</dd>
<dt>stepi:</dt>
<dd>steps a single machine code instruction.</dd>
</dl>
<p>e.g.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>stepi 100
</pre></div>
</div>
<dl class="docutils">
<dt>nexti:</dt>
<dd>steps a single machine code instruction but will not step into
subroutines.</dd>
<dt>finish:</dt>
<dd>will run until exit of the current routine</dd>
<dt>run:</dt>
<dd>(re)starts a program</dd>
<dt>cont:</dt>
<dd>continues a program</dd>
<dt>quit:</dt>
<dd>exits gdb.</dd>
</dl>
</div>
<div class="section" id="breakpoints">
<h3>breakpoints<a class="headerlink" href="#breakpoints" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>break</dt>
<dd>sets a breakpoint</dd>
</dl>
<p>e.g.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>break main
break *$pc
break *0x400618
</pre></div>
</div>
<p>Here’s a really useful one for large programs</p>
<dl class="docutils">
<dt>rbr</dt>
<dd>Set a breakpoint for all functions matching REGEXP</dd>
</dl>
<p>e.g.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>rbr 390
</pre></div>
</div>
<p>will set a breakpoint with all functions with 390 in their name.</p>
<dl class="docutils">
<dt>info breakpoints</dt>
<dd>lists all breakpoints</dd>
<dt>delete:</dt>
<dd>delete breakpoint by number or delete them all</dd>
</dl>
<p>e.g.</p>
<dl class="docutils">
<dt>delete 1</dt>
<dd>will delete the first breakpoint</dd>
<dt>delete</dt>
<dd>will delete them all</dd>
<dt>watch:</dt>
<dd>This will set a watchpoint ( usually hardware assisted ),</dd>
</dl>
<p>This will watch a variable till it changes</p>
<p>e.g.</p>
<dl class="docutils">
<dt>watch cnt</dt>
<dd>will watch the variable cnt till it changes.</dd>
</dl>
<p>As an aside unfortunately gdb’s, architecture independent watchpoint code
is inconsistent &amp; not very good, watchpoints usually work but not always.</p>
<dl class="docutils">
<dt>info watchpoints:</dt>
<dd>Display currently active watchpoints</dd>
<dt>condition: ( another useful one )</dt>
<dd>Specify breakpoint number N to break only if COND is true.</dd>
</dl>
<p>Usage is <cite>condition N COND</cite>, where N is an integer and COND is an
expression to be evaluated whenever breakpoint N is reached.</p>
</div>
<div class="section" id="user-defined-functions-macros">
<h3>User defined functions/macros<a class="headerlink" href="#user-defined-functions-macros" title="Permalink to this headline">¶</a></h3>
<p>define: ( Note this is very very useful,simple &amp; powerful )</p>
<p>usage define &lt;name&gt; &lt;list of commands&gt; end</p>
<p>examples which you should consider putting into .gdbinit in your home
directory:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>define d
stepi
disassemble $pc $pc+10
end
define e
nexti
disassemble $pc $pc+10
end
</pre></div>
</div>
</div>
<div class="section" id="other-hard-to-classify-stuff">
<h3>Other hard to classify stuff<a class="headerlink" href="#other-hard-to-classify-stuff" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>signal n:</dt>
<dd>sends the victim program a signal.</dd>
</dl>
<p>e.g. <cite>signal 3</cite> will send a SIGQUIT.</p>
<dl class="docutils">
<dt>info signals:</dt>
<dd>what gdb does when the victim receives certain signals.</dd>
</dl>
<p>list:</p>
<p>e.g.:</p>
<dl class="docutils">
<dt>list</dt>
<dd>lists current function source</dd>
<dt>list 1,10</dt>
<dd>list first 10 lines of current file.</dd>
</dl>
<p>list test.c:1,10</p>
<dl class="docutils">
<dt>directory:</dt>
<dd>Adds directories to be searched for source if gdb cannot find the source.
(note it is a bit sensitive about slashes)</dd>
</dl>
<p>e.g. To add the root of the filesystem to the searchpath do:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>directory //
</pre></div>
</div>
<p>call &lt;function&gt;
This calls a function in the victim program, this is pretty powerful
e.g.
(gdb) call printf(“hello world”)
outputs:
$1 = 11</p>
<p>You might now be thinking that the line above didn’t work, something extra had
to be done.
(gdb) call fflush(stdout)
hello world$2 = 0
As an aside the debugger also calls malloc &amp; free under the hood
to make space for the “hello world” string.</p>
</div>
<div class="section" id="id2">
<h3>hints<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>command completion works just like bash
( if you are a bad typist like me this really helps )</li>
</ol>
<p>e.g. hit br &lt;TAB&gt; &amp; cursor up &amp; down :-).</p>
<p>2) if you have a debugging problem that takes a few steps to recreate
put the steps into a file called .gdbinit in your current working directory
if you have defined a few extra useful user defined commands put these in
your home directory &amp; they will be read each time gdb is launched.</p>
<p>A typical .gdbinit file might be.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>break main
run
break runtime_exception
cont
</pre></div>
</div>
</div>
<div class="section" id="stack-chaining-in-gdb-by-hand">
<h3>stack chaining in gdb by hand<a class="headerlink" href="#stack-chaining-in-gdb-by-hand" title="Permalink to this headline">¶</a></h3>
<p>This is done using a the same trick described for VM:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>p/x (*($sp+56))&amp;0x7fffffff
</pre></div>
</div>
<p>get the first backchain.</p>
<p>For z/Architecture
Replace 56 with 112 &amp; ignore the &amp;0x7fffffff
in the macros below &amp; do nasty casts to longs like the following
as gdb unfortunately deals with printed arguments as ints which
messes up everything.</p>
<p>i.e. here is a 3rd backchain dereference:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>p/x *(long *)(***(long ***)$sp+112)
</pre></div>
</div>
<p>this outputs:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$5 = 0x528f18
</pre></div>
</div>
<p>on my machine.</p>
<p>Now you can use:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>info symbol (*($sp+56))&amp;0x7fffffff
</pre></div>
</div>
<p>you might see something like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>rl_getc + 36 in section .text
</pre></div>
</div>
<p>telling you what is located at address 0x528f18
Now do:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>p/x (*(*$sp+56))&amp;0x7fffffff
</pre></div>
</div>
<p>This outputs:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$6 = 0x528ed0
</pre></div>
</div>
<p>Now do:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>info symbol (*(*$sp+56))&amp;0x7fffffff
rl_read_key + 180 in section .text
</pre></div>
</div>
<p>now do:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>p/x (*(**$sp+56))&amp;0x7fffffff
</pre></div>
</div>
<p>&amp; so on.</p>
</div>
<div class="section" id="disassembling-instructions-without-debug-info">
<h3>Disassembling instructions without debug info<a class="headerlink" href="#disassembling-instructions-without-debug-info" title="Permalink to this headline">¶</a></h3>
<p>gdb typically complains if there is a lack of debugging
symbols in the disassemble command with
“No function contains specified address.” To get around
this do:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>x/&lt;number lines to disassemble&gt;xi &lt;address&gt;
</pre></div>
</div>
<p>e.g.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>x/20xi 0x400730
</pre></div>
</div>
<dl class="docutils">
<dt>Note:</dt>
<dd>Remember gdb has history just like bash you don’t need to retype the
whole line just use the up &amp; down arrows.</dd>
</dl>
</div>
<div class="section" id="for-more-info">
<h3>For more info<a class="headerlink" href="#for-more-info" title="Permalink to this headline">¶</a></h3>
<p>From your linuxbox do:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>man gdb
</pre></div>
</div>
<p>or:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>info gdb.
</pre></div>
</div>
</div>
<div class="section" id="core-dumps">
<h3>core dumps<a class="headerlink" href="#core-dumps" title="Permalink to this headline">¶</a></h3>
<div class="section" id="what-a-core-dump">
<h4>What a core dump ?<a class="headerlink" href="#what-a-core-dump" title="Permalink to this headline">¶</a></h4>
<p>A core dump is a file generated by the kernel (if allowed) which contains the
registers and all active pages of the program which has crashed.</p>
<p>From this file gdb will allow you to look at the registers, stack trace and
memory of the program as if it just crashed on your system. It is usually
called core and created in the current working directory.</p>
<p>This is very useful in that a customer can mail a core dump to a technical
support department and the technical support department can reconstruct what
happened. Provided they have an identical copy of this program with debugging
symbols compiled in and the source base of this build is available.</p>
<p>In short it is far more useful than something like a crash log could ever hope
to be.</p>
</div>
<div class="section" id="why-have-i-never-seen-one">
<h4>Why have I never seen one ?<a class="headerlink" href="#why-have-i-never-seen-one" title="Permalink to this headline">¶</a></h4>
<p>Probably because you haven’t used the command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ulimit -c unlimited in bash
</pre></div>
</div>
<p>to allow core dumps, now do:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ulimit -a
</pre></div>
</div>
<p>to verify that the limit was accepted.</p>
<dl class="docutils">
<dt>A sample core dump</dt>
<dd><p class="first">To create this I’m going to do:</p>
<div class="last highlight-none notranslate"><div class="highlight"><pre><span></span>ulimit -c unlimited
gdb
</pre></div>
</div>
</dd>
</dl>
<p>to launch gdb (my victim app. ) now be bad &amp; do the following from another
telnet/xterm session to the same machine:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ps -aux | grep gdb
kill -SIGSEGV &lt;gdb&#39;s pid&gt;
</pre></div>
</div>
<p>or alternatively use <cite>killall -SIGSEGV gdb</cite> if you have the killall command.</p>
<p>Now look at the core dump:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>./gdb core
</pre></div>
</div>
<p>Displays the following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>GNU gdb 4.18
Copyright 1998 Free Software Foundation, Inc.
GDB is free software, covered by the GNU General Public License, and you are
welcome to change it and/or distribute copies of it under certain conditions.
Type &quot;show copying&quot; to see the conditions.
There is absolutely no warranty for GDB.  Type &quot;show warranty&quot; for details.
This GDB was configured as &quot;s390-ibm-linux&quot;...
Core was generated by `./gdb&#39;.
Program terminated with signal 11, Segmentation fault.
Reading symbols from /usr/lib/libncurses.so.4...done.
Reading symbols from /lib/libm.so.6...done.
Reading symbols from /lib/libc.so.6...done.
Reading symbols from /lib/ld-linux.so.2...done.
#0  0x40126d1a in read () from /lib/libc.so.6
Setting up the environment for debugging gdb.
Breakpoint 1 at 0x4dc6f8: file utils.c, line 471.
Breakpoint 2 at 0x4d87a4: file top.c, line 2609.
(top-gdb) info stack
#0  0x40126d1a in read () from /lib/libc.so.6
#1  0x528f26 in rl_getc (stream=0x7ffffde8) at input.c:402
#2  0x528ed0 in rl_read_key () at input.c:381
#3  0x5167e6 in readline_internal_char () at readline.c:454
#4  0x5168ee in readline_internal_charloop () at readline.c:507
#5  0x51692c in readline_internal () at readline.c:521
#6  0x5164fe in readline (prompt=0x7ffff810)
    at readline.c:349
#7  0x4d7a8a in command_line_input (prompt=0x564420 &quot;(gdb) &quot;, repeat=1,
    annotation_suffix=0x4d6b44 &quot;prompt&quot;) at top.c:2091
#8  0x4d6cf0 in command_loop () at top.c:1345
#9  0x4e25bc in main (argc=1, argv=0x7ffffdf4) at main.c:635
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="ldd">
<h2>LDD<a class="headerlink" href="#ldd" title="Permalink to this headline">¶</a></h2>
<p>This is a program which lists the shared libraries which a library needs,
Note you also get the relocations of the shared library text segments which
help when using objdump –source.</p>
<p>e.g.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ldd ./gdb
</pre></div>
</div>
<p>outputs:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>libncurses.so.4 =&gt; /usr/lib/libncurses.so.4 (0x40018000)
libm.so.6 =&gt; /lib/libm.so.6 (0x4005e000)
libc.so.6 =&gt; /lib/libc.so.6 (0x40084000)
/lib/ld-linux.so.2 =&gt; /lib/ld-linux.so.2 (0x40000000)
</pre></div>
</div>
</div>
<div class="section" id="debugging-shared-libraries">
<h2>Debugging shared libraries<a class="headerlink" href="#debugging-shared-libraries" title="Permalink to this headline">¶</a></h2>
<p>Most programs use shared libraries, however it can be very painful
when you single step instruction into a function like printf for the
first time &amp; you end up in functions like _dl_runtime_resolve this is
the ld.so doing lazy binding, lazy binding is a concept in ELF where
shared library functions are not loaded into memory unless they are
actually used, great for saving memory but a pain to debug.</p>
<p>To get around this either relink the program -static or exit gdb type
export LD_BIND_NOW=true this will stop lazy binding &amp; restart the gdb’ing
the program in question.</p>
</div>
<div class="section" id="debugging-modules">
<h2>Debugging modules<a class="headerlink" href="#debugging-modules" title="Permalink to this headline">¶</a></h2>
<p>As modules are dynamically loaded into the kernel their address can be
anywhere to get around this use the -m option with insmod to emit a load
map which can be piped into a file if required.</p>
</div>
<div class="section" id="the-proc-file-system">
<h2>The proc file system<a class="headerlink" href="#the-proc-file-system" title="Permalink to this headline">¶</a></h2>
<p>What is it ?.
It is a filesystem created by the kernel with files which are created on demand
by the kernel if read, or can be used to modify kernel parameters,
it is a powerful concept.</p>
<p>e.g.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cat /proc/sys/net/ipv4/ip_forward
</pre></div>
</div>
<p>On my machine outputs:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>0
</pre></div>
</div>
<p>telling me ip_forwarding is not on to switch it on I can do:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>echo 1 &gt;  /proc/sys/net/ipv4/ip_forward
</pre></div>
</div>
<p>cat it again:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cat /proc/sys/net/ipv4/ip_forward
</pre></div>
</div>
<p>On my machine now outputs:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
<p>IP forwarding is on.</p>
<p>There is a lot of useful info in here best found by going in and having a look
around, so I’ll take you through some entries I consider important.</p>
<p>All the processes running on the machine have their own entry defined by
/proc/&lt;pid&gt;</p>
<p>So lets have a look at the init process:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cd /proc/1
cat cmdline
</pre></div>
</div>
<p>emits:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>init [2]
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cd /proc/1/fd
</pre></div>
</div>
<p>This contains numerical entries of all the open files,
some of these you can cat e.g. stdout (2):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cat /proc/29/maps
</pre></div>
</div>
<p>on my machine emits:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>00400000-00478000 r-xp 00000000 5f:00 4103       /bin/bash
00478000-0047e000 rw-p 00077000 5f:00 4103       /bin/bash
0047e000-00492000 rwxp 00000000 00:00 0
40000000-40015000 r-xp 00000000 5f:00 14382      /lib/ld-2.1.2.so
40015000-40016000 rw-p 00014000 5f:00 14382      /lib/ld-2.1.2.so
40016000-40017000 rwxp 00000000 00:00 0
40017000-40018000 rw-p 00000000 00:00 0
40018000-4001b000 r-xp 00000000 5f:00 14435      /lib/libtermcap.so.2.0.8
4001b000-4001c000 rw-p 00002000 5f:00 14435      /lib/libtermcap.so.2.0.8
4001c000-4010d000 r-xp 00000000 5f:00 14387      /lib/libc-2.1.2.so
4010d000-40111000 rw-p 000f0000 5f:00 14387      /lib/libc-2.1.2.so
40111000-40114000 rw-p 00000000 00:00 0
40114000-4011e000 r-xp 00000000 5f:00 14408      /lib/libnss_files-2.1.2.so
4011e000-4011f000 rw-p 00009000 5f:00 14408      /lib/libnss_files-2.1.2.so
7fffd000-80000000 rwxp ffffe000 00:00 0
</pre></div>
</div>
<p>Showing us the shared libraries init uses where they are in memory
&amp; memory access permissions for each virtual memory area.</p>
<p>/proc/1/cwd is a softlink to the current working directory.</p>
<p>/proc/1/root is the root of the filesystem for this process.</p>
<p>/proc/1/mem is the current running processes memory which you
can read &amp; write to like a file.</p>
<p>strace uses this sometimes as it is a bit faster than the
rather inefficient ptrace interface for peeking at DATA.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cat status

Name:   init
State:  S (sleeping)
Pid:    1
PPid:   0
Uid:    0       0       0       0
Gid:    0       0       0       0
Groups:
VmSize:      408 kB
VmLck:         0 kB
VmRSS:       208 kB
VmData:       24 kB
VmStk:         8 kB
VmExe:       368 kB
VmLib:         0 kB
SigPnd: 0000000000000000
SigBlk: 0000000000000000
SigIgn: 7fffffffd7f0d8fc
SigCgt: 00000000280b2603
CapInh: 00000000fffffeff
CapPrm: 00000000ffffffff
CapEff: 00000000fffffeff

User PSW:    070de000 80414146
task: 004b6000 tss: 004b62d8 ksp: 004b7ca8 pt_regs: 004b7f68
User GPRS:
00000400  00000000  0000000b  7ffffa90
00000000  00000000  00000000  0045d9f4
0045cafc  7ffffa90  7fffff18  0045cb08
00010400  804039e8  80403af8  7ffff8b0
User ACRS:
00000000  00000000  00000000  00000000
00000001  00000000  00000000  00000000
00000000  00000000  00000000  00000000
00000000  00000000  00000000  00000000
Kernel BackChain  CallChain    BackChain  CallChain
       004b7ca8   8002bd0c     004b7d18   8002b92c
       004b7db8   8005cd50     004b7e38   8005d12a
       004b7f08   80019114
</pre></div>
</div>
<p>Showing among other things memory usage &amp; status of some signals &amp;
the processes’es registers from the kernel task_structure
as well as a backchain which may be useful if a process crashes
in the kernel for some unknown reason.</p>
</div>
<div class="section" id="some-driver-debugging-techniques">
<h2>Some driver debugging techniques<a class="headerlink" href="#some-driver-debugging-techniques" title="Permalink to this headline">¶</a></h2>
<div class="section" id="debug-feature">
<h3>debug feature<a class="headerlink" href="#debug-feature" title="Permalink to this headline">¶</a></h3>
<p>Some of our drivers now support a “debug feature” in
/proc/s390dbf see s390dbf.txt in the linux/Documentation directory
for more info.</p>
<p>e.g.
to switch on the lcs “debug feature”:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>echo 5 &gt; /proc/s390dbf/lcs/level
</pre></div>
</div>
<p>&amp; then after the error occurred:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cat /proc/s390dbf/lcs/sprintf &gt;/logfile
</pre></div>
</div>
<p>the logfile now contains some information which may help
tech support resolve a problem in the field.</p>
</div>
<div class="section" id="high-level-debugging-network-drivers">
<h3>high level debugging network drivers<a class="headerlink" href="#high-level-debugging-network-drivers" title="Permalink to this headline">¶</a></h3>
<p>ifconfig is a quite useful command
it gives the current state of network drivers.</p>
<p>If you suspect your network device driver is dead
one way to check is type:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ifconfig &lt;network device&gt;
</pre></div>
</div>
<p>e.g. tr0</p>
<p>You should see something like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ifconfig tr0
tr0      Link encap:16/4 Mbps Token Ring (New)  HWaddr 00:04:AC:20:8E:48
        inet addr:9.164.185.132  Bcast:9.164.191.255  Mask:255.255.224.0
        UP BROADCAST RUNNING MULTICAST  MTU:2000  Metric:1
        RX packets:246134 errors:0 dropped:0 overruns:0 frame:0
        TX packets:5 errors:0 dropped:0 overruns:0 carrier:0
        collisions:0 txqueuelen:100
</pre></div>
</div>
<p>if the device doesn’t say up
try:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/etc/rc.d/init.d/network start
</pre></div>
</div>
<p>( this starts the network stack &amp; hopefully calls ifconfig tr0 up ).
ifconfig looks at the output of /proc/net/dev and presents it in a more
presentable form.</p>
<p>Now ping the device from a machine in the same subnet.</p>
<p>if the RX packets count &amp; TX packets counts don’t increment you probably
have problems.</p>
<p>next:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cat /proc/net/arp
</pre></div>
</div>
<p>Do you see any hardware addresses in the cache if not you may have problems.
Next try:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ping -c 5 &lt;broadcast_addr&gt;
</pre></div>
</div>
<p>i.e. the Bcast field above in the output of
ifconfig. Do you see any replies from machines other than the local machine
if not you may have problems. also if the TX packets count in ifconfig
hasn’t incremented either you have serious problems in your driver
(e.g. the txbusy field of the network device being stuck on )
or you may have multiple network devices connected.</p>
</div>
<div class="section" id="chandev">
<h3>chandev<a class="headerlink" href="#chandev" title="Permalink to this headline">¶</a></h3>
<p>There is a new device layer for channel devices, some
drivers e.g. lcs are registered with this layer.</p>
<p>If the device uses the channel device layer you’ll be
able to find what interrupts it uses &amp; the current state
of the device.</p>
<p>See the manpage chandev.8 &amp;type cat /proc/chandev for more info.</p>
</div>
</div>
<div class="section" id="sysrq">
<h2>SysRq<a class="headerlink" href="#sysrq" title="Permalink to this headline">¶</a></h2>
<p>This is now supported by linux for s/390 &amp; z/Architecture.</p>
<p>To enable it do compile the kernel with:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Kernel Hacking -&gt; Magic SysRq Key Enabled
</pre></div>
</div>
<p>Then:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>echo &quot;1&quot; &gt; /proc/sys/kernel/sysrq
</pre></div>
</div>
<p>also type:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>echo &quot;8&quot; &gt;/proc/sys/kernel/printk
</pre></div>
</div>
<p>To make printk output go to console.</p>
<p>On 390 all commands are prefixed with:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>^-
</pre></div>
</div>
<p>e.g.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>^-t will show tasks.
^-? or some unknown command will display help.
</pre></div>
</div>
<p>The sysrq key reading is very picky ( I have to type the keys in an
xterm session &amp; paste them  into the x3270 console )
&amp; it may be wise to predefine the keys as described in the VM hints above</p>
<p>This is particularly useful for syncing disks unmounting &amp; rebooting
if the machine gets partially hung.</p>
<p>Read Documentation/admin-guide/sysrq.rst for more info</p>
</div>
<div class="section" id="references">
<h2>References:<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Enterprise Systems Architecture Reference Summary</li>
<li>Enterprise Systems Architecture Principles of Operation</li>
<li>Hartmut Penners s390 stack frame sheet.</li>
<li>IBM Mainframe Channel Attachment a technology brief from a CISCO webpage</li>
<li>Various bits of man &amp; info pages of Linux.</li>
<li>Linux &amp; GDB source.</li>
<li>Various info &amp; man pages.</li>
<li>CMS Help on tracing commands.</li>
<li>Linux for s/390 Elf Application Binary Interface</li>
<li>Linux for z/Series Elf Application Binary Interface ( Both Highly Recommended )</li>
<li>z/Architecture Principles of Operation SA22-7832-00</li>
<li>Enterprise Systems Architecture/390 Reference Summary SA22-7209-01 &amp; the</li>
<li>Enterprise Systems Architecture/390 Principles of Operation SA22-7201-05</li>
</ul>
</div>
<div class="section" id="special-thanks">
<h2>Special Thanks<a class="headerlink" href="#special-thanks" title="Permalink to this headline">¶</a></h2>
<p>Special thanks to Neale Ferguson who maintains a much
prettier HTML version of this page at
<a class="reference external" href="http://linuxvm.org/penguinvm/">http://linuxvm.org/penguinvm/</a>
Bob Grainger Stefan Bader &amp; others for reporting bugs</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>