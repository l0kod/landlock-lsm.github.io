

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>NXP SJA1105 switch driver &mdash; The Linux Kernel 5.11.0-rc6+ documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="DSA switch configuration from userspace" href="configuration.html" />
    <link rel="prev" title="LAN9303 Ethernet switch driver" href="lan9303.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.11.0-rc6
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devicetree/index.html">Open Firmware and Device Tree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Linux Networking Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../netdev-FAQ.html">netdev FAQ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../af_xdp.html">AF_XDP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bareudp.html">Bare UDP Tunnelling Module Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../batman-adv.html">batman-adv</a></li>
<li class="toctree-l2"><a class="reference internal" href="../can.html">SocketCAN - Controller Area Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="../can_ucan_protocol.html">The UCAN Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="../device_drivers/index.html">Hardware Device Drivers</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Distributed Switch Architecture</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="dsa.html">Architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="b53.html">Broadcom RoboSwitch Ethernet switch driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="bcm_sf2.html">Broadcom Starfighter 2 Ethernet switch driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="lan9303.html">LAN9303 Ethernet switch driver</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">NXP SJA1105 switch driver</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#traffic-support">Traffic support</a></li>
<li class="toctree-l4"><a class="reference internal" href="#switching-features">Switching features</a></li>
<li class="toctree-l4"><a class="reference internal" href="#offloads">Offloads</a></li>
<li class="toctree-l4"><a class="reference internal" href="#device-tree-bindings-and-board-design">Device Tree bindings and board design</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html">DSA switch configuration from userspace</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../devlink/index.html">Linux Devlink Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../caif/index.html">CAIF</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ethtool-netlink.html">Netlink interface for ethtool</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ieee802154.html">IEEE 802.15.4 Developer’s Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../j1939.html">J1939 Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kapi.html">Linux Networking and Network Devices APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../msg_zerocopy.html">MSG_ZEROCOPY</a></li>
<li class="toctree-l2"><a class="reference internal" href="../failover.html">FAILOVER</a></li>
<li class="toctree-l2"><a class="reference internal" href="../net_dim.html">Net DIM - Generic Network Dynamic Interrupt Moderation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../net_failover.html">NET_FAILOVER</a></li>
<li class="toctree-l2"><a class="reference internal" href="../page_pool.html">Page Pool API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../phy.html">PHY Abstraction Layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sfp-phylink.html">phylink</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alias.html">IP-Aliasing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bridge.html">Ethernet Bridging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../snmp_counter.html">SNMP counter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../checksum-offloads.html">Checksum Offloads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../segmentation-offloads.html">Segmentation Offloads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scaling.html">Scaling in the Linux Networking Stack</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tls.html">Kernel TLS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tls-offload.html">Kernel TLS offload</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nfc.html">Linux NFC subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../6lowpan.html">Netdev private dataroom for 6lowpan interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../6pack.html">6pack Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="../arcnet-hardware.html">ARCnet Hardware</a></li>
<li class="toctree-l2"><a class="reference internal" href="../arcnet.html">ARCnet</a></li>
<li class="toctree-l2"><a class="reference internal" href="../atm.html">ATM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ax25.html">AX.25</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bonding.html">Linux Ethernet Bonding Driver HOWTO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cdc_mbim.html">cdc_mbim - Driver for CDC MBIM Mobile Broadband modems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dccp.html">DCCP protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dctcp.html">DCTCP (DataCenter TCP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../decnet.html">Linux DECnet Networking Layer Information</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dns_resolver.html">DNS Resolver Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../driver.html">Softnet Driver Issues</a></li>
<li class="toctree-l2"><a class="reference internal" href="../eql.html">EQL Driver: Serial IP Load Balancing HOWTO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../fib_trie.html">LC-trie implementation notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../filter.html">Linux Socket Filtering aka Berkeley Packet Filter (BPF)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../generic-hdlc.html">Generic HDLC layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../generic_netlink.html">Generic Netlink</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gen_stats.html">Generic networking statistics for netlink users</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gtp.html">The Linux kernel GTP tunneling module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ila.html">Identifier Locator Addressing (ILA)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ipddp.html">AppleTalk-IP Decapsulation and AppleTalk-IP Encapsulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ip_dynaddr.html">IP dynamic address hack-port v0.03</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ipsec.html">IPsec</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ip-sysctl.html">IP Sysctl</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ipv6.html">IPv6</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ipvlan.html">IPVLAN Driver HOWTO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ipvs-sysctl.html">IPvs-sysctl</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kcm.html">Kernel Connection Multiplexor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../l2tp.html">L2TP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lapb-module.html">The Linux LAPB Module Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mac80211-injection.html">How to use packet injection with mac80211</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mpls-sysctl.html">MPLS Sysfs variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mptcp-sysctl.html">MPTCP Sysfs variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multiqueue.html">HOWTO for multiqueue network device support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../netconsole.html">Netconsole</a></li>
<li class="toctree-l2"><a class="reference internal" href="../netdev-features.html">Netdev features mess and how to get out from it alive</a></li>
<li class="toctree-l2"><a class="reference internal" href="../netdevices.html">Network Devices, the Kernel, and You!</a></li>
<li class="toctree-l2"><a class="reference internal" href="../netfilter-sysctl.html">Netfilter Sysfs variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../netif-msg.html">NETIF Msg Level</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nf_conntrack-sysctl.html">Netfilter Conntrack Sysfs variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nf_flowtable.html">Netfilter’s flowtable infrastructure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../openvswitch.html">Open vSwitch datapath developer documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../operstates.html">Operational States</a></li>
<li class="toctree-l2"><a class="reference internal" href="../packet_mmap.html">Packet MMAP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../phonet.html">Linux Phonet protocol family</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pktgen.html">HOWTO for the linux packet generator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plip.html">PLIP: The Parallel Line Internet Protocol Device</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ppp_generic.html">PPP Generic Driver and Channel Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../proc_net_tcp.html">The proc/net/tcp and proc/net/tcp6 variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../radiotap-headers.html">How to use radiotap headers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rds.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rds.html#rds-architecture">RDS Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rds.html#socket-interface">Socket Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rds.html#rdma-for-rds">RDMA for RDS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rds.html#congestion-notifications">Congestion Notifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rds.html#rds-protocol">RDS Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rds.html#rds-transport-layer">RDS Transport Layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rds.html#rds-kernel-structures">RDS Kernel Structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rds.html#connection-management">Connection management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rds.html#the-send-path">The send path</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rds.html#the-recv-path">The recv path</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rds.html#multipath-rds-mprds">Multipath RDS (mprds)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../regulatory.html">Linux wireless regulatory documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rxrpc.html">RxRPC Network Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rxrpc.html#socket-options">SOCKET OPTIONS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rxrpc.html#security">SECURITY</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rxrpc.html#example-client-usage">EXAMPLE CLIENT USAGE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sctp.html">Linux Kernel SCTP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../secid.html">LSM/SeLinux secid</a></li>
<li class="toctree-l2"><a class="reference internal" href="../seg6-sysctl.html">Seg6 Sysfs variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../statistics.html">Interface statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../strparser.html">Stream Parser (strparser)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../switchdev.html">Ethernet switch device driver model (switchdev)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sysfs-tagging.html">Sysfs tagging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tc-actions-env-rules.html">TC Actions - Environmental Rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tcp-thin.html">Thin-streams and TCP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../team.html">Team</a></li>
<li class="toctree-l2"><a class="reference internal" href="../timestamping.html">Timestamping</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tipc.html">Linux Kernel TIPC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tproxy.html">Transparent proxy support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tuntap.html">Universal TUN/TAP device driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../udplite.html">The UDP-Lite protocol (RFC 3828)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vrf.html">Virtual Routing and Forwarding (VRF)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vxlan.html">Virtual eXtensible Local Area Networking documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../x25-iface.html">Packet Layer to Device Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../x25-iface.html#device-driver-to-packet-layer">Device Driver to Packet Layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../x25.html">Linux X.25 Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="../xfrm_device.html">XFRM device - offloading the IPsec computations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../xfrm_proc.html">XFRM proc - /proc/net/xfrm_* files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../xfrm_sync.html">XFRM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../xfrm_sysctl.html">XFRM Syscall</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mhi/index.html">MHI</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nios2/index.html">Nios II Specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../x86/index.html">x86-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../filesystems/ext4/index.html">ext4 Data Structures and Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Linux Networking Documentation</a> &raquo;</li>
        
          <li><a href="index.html">Distributed Switch Architecture</a> &raquo;</li>
        
      <li>NXP SJA1105 switch driver</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/networking/dsa/sja1105.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="nxp-sja1105-switch-driver">
<h1>NXP SJA1105 switch driver<a class="headerlink" href="#nxp-sja1105-switch-driver" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The NXP SJA1105 is a family of 6 devices:</p>
<ul class="simple">
<li><p>SJA1105E: First generation, no TTEthernet</p></li>
<li><p>SJA1105T: First generation, TTEthernet</p></li>
<li><p>SJA1105P: Second generation, no TTEthernet, no SGMII</p></li>
<li><p>SJA1105Q: Second generation, TTEthernet, no SGMII</p></li>
<li><p>SJA1105R: Second generation, no TTEthernet, SGMII</p></li>
<li><p>SJA1105S: Second generation, TTEthernet, SGMII</p></li>
</ul>
<p>These are SPI-managed automotive switches, with all ports being gigabit
capable, and supporting MII/RMII/RGMII and optionally SGMII on one port.</p>
<p>Being automotive parts, their configuration interface is geared towards
set-and-forget use, with minimal dynamic interaction at runtime. They
require a static configuration to be composed by software and packed
with CRC and table headers, and sent over SPI.</p>
<p>The static configuration is composed of several configuration tables. Each
table takes a number of entries. Some configuration tables can be (partially)
reconfigured at runtime, some not. Some tables are mandatory, some not:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 38%" />
<col style="width: 24%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Table</p></th>
<th class="head"><p>Mandatory</p></th>
<th class="head"><p>Reconfigurable</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Schedule</p></td>
<td><p>no</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-odd"><td><p>Schedule entry points</p></td>
<td><p>if Scheduling</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-even"><td><p>VL Lookup</p></td>
<td><p>no</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-odd"><td><p>VL Policing</p></td>
<td><p>if VL Lookup</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-even"><td><p>VL Forwarding</p></td>
<td><p>if VL Lookup</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-odd"><td><p>L2 Lookup</p></td>
<td><p>no</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-even"><td><p>L2 Policing</p></td>
<td><p>yes</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-odd"><td><p>VLAN Lookup</p></td>
<td><p>yes</p></td>
<td><p>yes</p></td>
</tr>
<tr class="row-even"><td><p>L2 Forwarding</p></td>
<td><p>yes</p></td>
<td><p>partially (fully on P/Q/R/S)</p></td>
</tr>
<tr class="row-odd"><td><p>MAC Config</p></td>
<td><p>yes</p></td>
<td><p>partially (fully on P/Q/R/S)</p></td>
</tr>
<tr class="row-even"><td><p>Schedule Params</p></td>
<td><p>if Scheduling</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-odd"><td><p>Schedule Entry Points Params</p></td>
<td><p>if Scheduling</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-even"><td><p>VL Forwarding Params</p></td>
<td><p>if VL Forwarding</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-odd"><td><p>L2 Lookup Params</p></td>
<td><p>no</p></td>
<td><p>partially (fully on P/Q/R/S)</p></td>
</tr>
<tr class="row-even"><td><p>L2 Forwarding Params</p></td>
<td><p>yes</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-odd"><td><p>Clock Sync Params</p></td>
<td><p>no</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-even"><td><p>AVB Params</p></td>
<td><p>no</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-odd"><td><p>General Params</p></td>
<td><p>yes</p></td>
<td><p>partially</p></td>
</tr>
<tr class="row-even"><td><p>Retagging</p></td>
<td><p>no</p></td>
<td><p>yes</p></td>
</tr>
<tr class="row-odd"><td><p>xMII Params</p></td>
<td><p>yes</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-even"><td><p>SGMII</p></td>
<td><p>no</p></td>
<td><p>yes</p></td>
</tr>
</tbody>
</table>
<p>Also the configuration is write-only (software cannot read it back from the
switch except for very few exceptions).</p>
<p>The driver creates a static configuration at probe time, and keeps it at
all times in memory, as a shadow for the hardware state. When required to
change a hardware setting, the static configuration is also updated.
If that changed setting can be transmitted to the switch through the dynamic
reconfiguration interface, it is; otherwise the switch is reset and
reprogrammed with the updated static configuration.</p>
</div>
<div class="section" id="traffic-support">
<h2>Traffic support<a class="headerlink" href="#traffic-support" title="Permalink to this headline">¶</a></h2>
<p>The switches do not have hardware support for DSA tags, except for “slow
protocols” for switch control as STP and PTP. For these, the switches have two
programmable filters for link-local destination MACs.
These are used to trap BPDUs and PTP traffic to the master netdevice, and are
further used to support STP and 1588 ordinary clock/boundary clock
functionality. For frames trapped to the CPU, source port and switch ID
information is encoded by the hardware into the frames.</p>
<p>But by leveraging <code class="docutils literal notranslate"><span class="pre">CONFIG_NET_DSA_TAG_8021Q</span></code> (a software-defined DSA tagging
format based on VLANs), general-purpose traffic termination through the network
stack can be supported under certain circumstances.</p>
<p>Depending on VLAN awareness state, the following operating modes are possible
with the switch:</p>
<ul class="simple">
<li><p>Mode 1 (VLAN-unaware): a port is in this mode when it is used as a standalone
net device, or when it is enslaved to a bridge with <code class="docutils literal notranslate"><span class="pre">vlan_filtering=0</span></code>.</p></li>
<li><p>Mode 2 (fully VLAN-aware): a port is in this mode when it is enslaved to a
bridge with <code class="docutils literal notranslate"><span class="pre">vlan_filtering=1</span></code>. Access to the entire VLAN range is given to
the user through <code class="docutils literal notranslate"><span class="pre">bridge</span> <span class="pre">vlan</span></code> commands, but general-purpose (anything
other than STP, PTP etc) traffic termination is not possible through the
switch net devices. The other packets can be still by user space processed
through the DSA master interface (similar to <code class="docutils literal notranslate"><span class="pre">DSA_TAG_PROTO_NONE</span></code>).</p></li>
<li><p>Mode 3 (best-effort VLAN-aware): a port is in this mode when enslaved to a
bridge with <code class="docutils literal notranslate"><span class="pre">vlan_filtering=1</span></code>, and the devlink property of its parent
switch named <code class="docutils literal notranslate"><span class="pre">best_effort_vlan_filtering</span></code> is set to <code class="docutils literal notranslate"><span class="pre">true</span></code>. When
configured like this, the range of usable VIDs is reduced (0 to 1023 and 3072
to 4094), so is the number of usable VIDs (maximum of 7 non-pvid VLANs per
port*), and shared VLAN learning is performed (FDB lookup is done only by
DMAC, not also by VID).</p></li>
</ul>
<p>To summarize, in each mode, the following types of traffic are supported over
the switch net devices:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 26%" />
<col style="width: 22%" />
<col style="width: 28%" />
<col style="width: 24%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"><p>Mode 1</p></th>
<th class="head"><p>Mode 2</p></th>
<th class="head"><p>Mode 3</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Regular
traffic</p></td>
<td><p>Yes</p></td>
<td><p>No
(use master)</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p>Management
traffic
(BPDU, PTP)</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
</tr>
</tbody>
</table>
<p>To configure the switch to operate in Mode 3, the following steps can be
followed:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ip link add dev br0 type bridge
# swp2 operates in Mode 1 now
ip link set dev swp2 master br0
# swp2 temporarily moves to Mode 2
ip link set dev br0 type bridge vlan_filtering 1
[   61.204770] sja1105 spi0.1: Reset switch and programmed static config. Reason: VLAN filtering
[   61.239944] sja1105 spi0.1: Disabled switch tagging
# swp3 now operates in Mode 3
devlink dev param set spi/spi0.1 name best_effort_vlan_filtering value true cmode runtime
[   64.682927] sja1105 spi0.1: Reset switch and programmed static config. Reason: VLAN filtering
[   64.711925] sja1105 spi0.1: Enabled switch tagging
# Cannot use VLANs in range 1024-3071 while in Mode 3.
bridge vlan add dev swp2 vid 1025 untagged pvid
RTNETLINK answers: Operation not permitted
bridge vlan add dev swp2 vid 100
bridge vlan add dev swp2 vid 101 untagged
bridge vlan
port    vlan ids
swp5     1 PVID Egress Untagged

swp2     1 PVID Egress Untagged
         100
         101 Egress Untagged

swp3     1 PVID Egress Untagged

swp4     1 PVID Egress Untagged

br0      1 PVID Egress Untagged
bridge vlan add dev swp2 vid 102
bridge vlan add dev swp2 vid 103
bridge vlan add dev swp2 vid 104
bridge vlan add dev swp2 vid 105
bridge vlan add dev swp2 vid 106
bridge vlan add dev swp2 vid 107
# Cannot use mode than 7 VLANs per port while in Mode 3.
[ 3885.216832] sja1105 spi0.1: No more free subvlans
</pre></div>
</div>
<p>* “maximum of 7 non-pvid VLANs per port”: Decoding VLAN-tagged packets on the
CPU in mode 3 is possible through VLAN retagging of packets that go from the
switch to the CPU. In cross-chip topologies, the port that goes to the CPU
might also go to other switches. In that case, those other switches will see
only a retagged packet (which only has meaning for the CPU). So if they are
interested in this VLAN, they need to apply retagging in the reverse direction,
to recover the original value from it. This consumes extra hardware resources
for this switch. There is a maximum of 32 entries in the Retagging Table of
each switch device.</p>
<p>As an example, consider this cross-chip topology:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-------------------------------------------------+
| Host SoC                                        |
|           +-------------------------+           |
|           | DSA master for embedded |           |
|           |   switch (non-sja1105)  |           |
|  +--------+-------------------------+--------+  |
|  |   embedded L2 switch                      |  |
|  |                                           |  |
|  |   +--------------+     +--------------+   |  |
|  |   |DSA master for|     |DSA master for|   |  |
|  |   |  SJA1105 1   |     |  SJA1105 2   |   |  |
+--+---+--------------+-----+--------------+---+--+

+-----------------------+ +-----------------------+
|   SJA1105 switch 1    | |   SJA1105 switch 2    |
+-----+-----+-----+-----+ +-----+-----+-----+-----+
|sw1p0|sw1p1|sw1p2|sw1p3| |sw2p0|sw2p1|sw2p2|sw2p3|
+-----+-----+-----+-----+ +-----+-----+-----+-----+
</pre></div>
</div>
<p>To reach the CPU, SJA1105 switch 1 (spi/spi2.1) uses the same port as is uses
to reach SJA1105 switch 2 (spi/spi2.2), which would be port 4 (not drawn).
Similarly for SJA1105 switch 2.</p>
<p>Also consider the following commands, that add VLAN 100 to every sja1105 user
port:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>devlink dev param set spi/spi2.1 name best_effort_vlan_filtering value true cmode runtime
devlink dev param set spi/spi2.2 name best_effort_vlan_filtering value true cmode runtime
ip link add dev br0 type bridge
for port in sw1p0 sw1p1 sw1p2 sw1p3 \
            sw2p0 sw2p1 sw2p2 sw2p3; do
    ip link set dev $port master br0
done
ip link set dev br0 type bridge vlan_filtering 1
for port in sw1p0 sw1p1 sw1p2 sw1p3 \
            sw2p0 sw2p1 sw2p2; do
    bridge vlan add dev $port vid 100
done
ip link add link br0 name br0.100 type vlan id 100 &amp;&amp; ip link set dev br0.100 up
ip addr add 192.168.100.3/24 dev br0.100
bridge vlan add dev br0 vid 100 self

bridge vlan
port    vlan ids
sw1p0    1 PVID Egress Untagged
         100

sw1p1    1 PVID Egress Untagged
         100

sw1p2    1 PVID Egress Untagged
         100

sw1p3    1 PVID Egress Untagged
         100

sw2p0    1 PVID Egress Untagged
         100

sw2p1    1 PVID Egress Untagged
         100

sw2p2    1 PVID Egress Untagged
         100

sw2p3    1 PVID Egress Untagged

br0      1 PVID Egress Untagged
         100
</pre></div>
</div>
<p>SJA1105 switch 1 consumes 1 retagging entry for each VLAN on each user port
towards the CPU. It also consumes 1 retagging entry for each non-pvid VLAN that
it is also interested in, which is configured on any port of any neighbor
switch.</p>
<p>In this case, SJA1105 switch 1 consumes a total of 11 retagging entries, as
follows:</p>
<ul class="simple">
<li><p>8 retagging entries for VLANs 1 and 100 installed on its user ports
(<code class="docutils literal notranslate"><span class="pre">sw1p0</span></code> - <code class="docutils literal notranslate"><span class="pre">sw1p3</span></code>)</p></li>
<li><p>3 retagging entries for VLAN 100 installed on the user ports of SJA1105
switch 2 (<code class="docutils literal notranslate"><span class="pre">sw2p0</span></code> - <code class="docutils literal notranslate"><span class="pre">sw2p2</span></code>), because it also has ports that are
interested in it. The VLAN 1 is a pvid on SJA1105 switch 2 and does not need
reverse retagging.</p></li>
</ul>
<p>SJA1105 switch 2 also consumes 11 retagging entries, but organized as follows:</p>
<ul class="simple">
<li><p>7 retagging entries for the bridge VLANs on its user ports (<code class="docutils literal notranslate"><span class="pre">sw2p0</span></code> -
<code class="docutils literal notranslate"><span class="pre">sw2p3</span></code>).</p></li>
<li><p>4 retagging entries for VLAN 100 installed on the user ports of SJA1105
switch 1 (<code class="docutils literal notranslate"><span class="pre">sw1p0</span></code> - <code class="docutils literal notranslate"><span class="pre">sw1p3</span></code>).</p></li>
</ul>
</div>
<div class="section" id="switching-features">
<h2>Switching features<a class="headerlink" href="#switching-features" title="Permalink to this headline">¶</a></h2>
<p>The driver supports the configuration of L2 forwarding rules in hardware for
port bridging. The forwarding, broadcast and flooding domain between ports can
be restricted through two methods: either at the L2 forwarding level (isolate
one bridge’s ports from another’s) or at the VLAN port membership level
(isolate ports within the same bridge). The final forwarding decision taken by
the hardware is a logical AND of these two sets of rules.</p>
<p>The hardware tags all traffic internally with a port-based VLAN (pvid), or it
decodes the VLAN information from the 802.1Q tag. Advanced VLAN classification
is not possible. Once attributed a VLAN tag, frames are checked against the
port’s membership rules and dropped at ingress if they don’t match any VLAN.
This behavior is available when switch ports are enslaved to a bridge with
<code class="docutils literal notranslate"><span class="pre">vlan_filtering</span> <span class="pre">1</span></code>.</p>
<p>Normally the hardware is not configurable with respect to VLAN awareness, but
by changing what TPID the switch searches 802.1Q tags for, the semantics of a
bridge with <code class="docutils literal notranslate"><span class="pre">vlan_filtering</span> <span class="pre">0</span></code> can be kept (accept all traffic, tagged or
untagged), and therefore this mode is also supported.</p>
<p>Segregating the switch ports in multiple bridges is supported (e.g. 2 + 2), but
all bridges should have the same level of VLAN awareness (either both have
<code class="docutils literal notranslate"><span class="pre">vlan_filtering</span></code> 0, or both 1). Also an inevitable limitation of the fact
that VLAN awareness is global at the switch level is that once a bridge with
<code class="docutils literal notranslate"><span class="pre">vlan_filtering</span></code> enslaves at least one switch port, the other un-bridged
ports are no longer available for standalone traffic termination.</p>
<p>Topology and loop detection through STP is supported.</p>
<p>L2 FDB manipulation (add/delete/dump) is currently possible for the first
generation devices. Aging time of FDB entries, as well as enabling fully static
management (no address learning and no flooding of unknown traffic) is not yet
configurable in the driver.</p>
<p>A special comment about bridging with other netdevices (illustrated with an
example):</p>
<p>A board has eth0, eth1, <a class="reference external" href="mailto:swp0&#37;&#52;&#48;eth1">swp0<span>&#64;</span>eth1</a>, <a class="reference external" href="mailto:swp1&#37;&#52;&#48;eth1">swp1<span>&#64;</span>eth1</a>, <a class="reference external" href="mailto:swp2&#37;&#52;&#48;eth1">swp2<span>&#64;</span>eth1</a>, <a class="reference external" href="mailto:swp3&#37;&#52;&#48;eth1">swp3<span>&#64;</span>eth1</a>.
The switch ports (swp0-3) are under br0.
It is desired that eth0 is turned into another switched port that communicates
with swp0-3.</p>
<p>If br0 has vlan_filtering 0, then eth0 can simply be added to br0 with the
intended results.
If br0 has vlan_filtering 1, then a new br1 interface needs to be created that
enslaves eth0 and eth1 (the DSA master of the switch ports). This is because in
this mode, the switch ports beneath br0 are not capable of regular traffic, and
are only used as a conduit for switchdev operations.</p>
</div>
<div class="section" id="offloads">
<h2>Offloads<a class="headerlink" href="#offloads" title="Permalink to this headline">¶</a></h2>
<div class="section" id="time-aware-scheduling">
<h3>Time-aware scheduling<a class="headerlink" href="#time-aware-scheduling" title="Permalink to this headline">¶</a></h3>
<p>The switch supports a variation of the enhancements for scheduled traffic
specified in IEEE 802.1Q-2018 (formerly 802.1Qbv). This means it can be used to
ensure deterministic latency for priority traffic that is sent in-band with its
gate-open event in the network schedule.</p>
<p>This capability can be managed through the tc-taprio offload (‘flags 2’). The
difference compared to the software implementation of taprio is that the latter
would only be able to shape traffic originated from the CPU, but not
autonomously forwarded flows.</p>
<p>The device has 8 traffic classes, and maps incoming frames to one of them based
on the VLAN PCP bits (if no VLAN is present, the port-based default is used).
As described in the previous sections, depending on the value of
<code class="docutils literal notranslate"><span class="pre">vlan_filtering</span></code>, the EtherType recognized by the switch as being VLAN can
either be the typical 0x8100 or a custom value used internally by the driver
for tagging. Therefore, the switch ignores the VLAN PCP if used in standalone
or bridge mode with <code class="docutils literal notranslate"><span class="pre">vlan_filtering=0</span></code>, as it will not recognize the 0x8100
EtherType. In these modes, injecting into a particular TX queue can only be
done by the DSA net devices, which populate the PCP field of the tagging header
on egress. Using <code class="docutils literal notranslate"><span class="pre">vlan_filtering=1</span></code>, the behavior is the other way around:
offloaded flows can be steered to TX queues based on the VLAN PCP, but the DSA
net devices are no longer able to do that. To inject frames into a hardware TX
queue with VLAN awareness active, it is necessary to create a VLAN
sub-interface on the DSA master port, and send normal (0x8100) VLAN-tagged
towards the switch, with the VLAN PCP bits set appropriately.</p>
<p>Management traffic (having DMAC 01-80-C2-xx-xx-xx or 01-19-1B-xx-xx-xx) is the
notable exception: the switch always treats it with a fixed priority and
disregards any VLAN PCP bits even if present. The traffic class for management
traffic has a value of 7 (highest priority) at the moment, which is not
configurable in the driver.</p>
<p>Below is an example of configuring a 500 us cyclic schedule on egress port
<code class="docutils literal notranslate"><span class="pre">swp5</span></code>. The traffic class gate for management traffic (7) is open for 100 us,
and the gates for all other traffic classes are open for 400 us:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#!/bin/bash

set -e -u -o pipefail

NSEC_PER_SEC=&quot;1000000000&quot;

gatemask() {
        local tc_list=&quot;$1&quot;
        local mask=0

        for tc in ${tc_list}; do
                mask=$((${mask} | (1 &lt;&lt; ${tc})))
        done

        printf &quot;%02x&quot; ${mask}
}

if ! systemctl is-active --quiet ptp4l; then
        echo &quot;Please start the ptp4l service&quot;
        exit
fi

now=$(phc_ctl /dev/ptp1 get | gawk &#39;/clock time is/ { print $5; }&#39;)
# Phase-align the base time to the start of the next second.
sec=$(echo &quot;${now}&quot; | gawk -F. &#39;{ print $1; }&#39;)
base_time=&quot;$(((${sec} + 1) * ${NSEC_PER_SEC}))&quot;

tc qdisc add dev swp5 parent root handle 100 taprio \
        num_tc 8 \
        map 0 1 2 3 5 6 7 \
        queues 1@0 1@1 1@2 1@3 1@4 1@5 1@6 1@7 \
        base-time ${base_time} \
        sched-entry S $(gatemask 7) 100000 \
        sched-entry S $(gatemask &quot;0 1 2 3 4 5 6&quot;) 400000 \
        flags 2
</pre></div>
</div>
<p>It is possible to apply the tc-taprio offload on multiple egress ports. There
are hardware restrictions related to the fact that no gate event may trigger
simultaneously on two ports. The driver checks the consistency of the schedules
against this restriction and errors out when appropriate. Schedule analysis is
needed to avoid this, which is outside the scope of the document.</p>
</div>
<div class="section" id="routing-actions-redirect-trap-drop">
<h3>Routing actions (redirect, trap, drop)<a class="headerlink" href="#routing-actions-redirect-trap-drop" title="Permalink to this headline">¶</a></h3>
<p>The switch is able to offload flow-based redirection of packets to a set of
destination ports specified by the user. Internally, this is implemented by
making use of Virtual Links, a TTEthernet concept.</p>
<p>The driver supports 2 types of keys for Virtual Links:</p>
<ul class="simple">
<li><p>VLAN-aware virtual links: these match on destination MAC address, VLAN ID and
VLAN PCP.</p></li>
<li><p>VLAN-unaware virtual links: these match on destination MAC address only.</p></li>
</ul>
<p>The VLAN awareness state of the bridge (vlan_filtering) cannot be changed while
there are virtual link rules installed.</p>
<p>Composing multiple actions inside the same rule is supported. When only routing
actions are requested, the driver creates a “non-critical” virtual link. When
the action list also contains tc-gate (more details below), the virtual link
becomes “time-critical” (draws frame buffers from a reserved memory partition,
etc).</p>
<p>The 3 routing actions that are supported are “trap”, “drop” and “redirect”.</p>
<p>Example 1: send frames received on swp2 with a DA of 42:be:24:9b:76:20 to the
CPU and to swp3. This type of key (DA only) when the port’s VLAN awareness
state is off:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>tc qdisc add dev swp2 clsact
tc filter add dev swp2 ingress flower skip_sw dst_mac 42:be:24:9b:76:20 \
        action mirred egress redirect dev swp3 \
        action trap
</pre></div>
</div>
<p>Example 2: drop frames received on swp2 with a DA of 42:be:24:9b:76:20, a VID
of 100 and a PCP of 0:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>tc filter add dev swp2 ingress protocol 802.1Q flower skip_sw \
        dst_mac 42:be:24:9b:76:20 vlan_id 100 vlan_prio 0 action drop
</pre></div>
</div>
</div>
<div class="section" id="time-based-ingress-policing">
<h3>Time-based ingress policing<a class="headerlink" href="#time-based-ingress-policing" title="Permalink to this headline">¶</a></h3>
<p>The TTEthernet hardware abilities of the switch can be constrained to act
similarly to the Per-Stream Filtering and Policing (PSFP) clause specified in
IEEE 802.1Q-2018 (formerly 802.1Qci). This means it can be used to perform
tight timing-based admission control for up to 1024 flows (identified by a
tuple composed of destination MAC address, VLAN ID and VLAN PCP). Packets which
are received outside their expected reception window are dropped.</p>
<p>This capability can be managed through the offload of the tc-gate action. As
routing actions are intrinsic to virtual links in TTEthernet (which performs
explicit routing of time-critical traffic and does not leave that in the hands
of the FDB, flooding etc), the tc-gate action may never appear alone when
asking sja1105 to offload it. One (or more) redirect or trap actions must also
follow along.</p>
<p>Example: create a tc-taprio schedule that is phase-aligned with a tc-gate
schedule (the clocks must be synchronized by a 1588 application stack, which is
outside the scope of this document). No packet delivered by the sender will be
dropped. Note that the reception window is larger than the transmission window
(and much more so, in this example) to compensate for the packet propagation
delay of the link (which can be determined by the 1588 application stack).</p>
<p>Receiver (sja1105):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>tc qdisc add dev swp2 clsact
now=$(phc_ctl /dev/ptp1 get | awk &#39;/clock time is/ {print $5}&#39;) &amp;&amp; \
        sec=$(echo $now | awk -F. &#39;{print $1}&#39;) &amp;&amp; \
        base_time=&quot;$(((sec + 2) * 1000000000))&quot; &amp;&amp; \
        echo &quot;base time ${base_time}&quot;
tc filter add dev swp2 ingress flower skip_sw \
        dst_mac 42:be:24:9b:76:20 \
        action gate base-time ${base_time} \
        sched-entry OPEN  60000 -1 -1 \
        sched-entry CLOSE 40000 -1 -1 \
        action trap
</pre></div>
</div>
<p>Sender:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>now=$(phc_ctl /dev/ptp0 get | awk &#39;/clock time is/ {print $5}&#39;) &amp;&amp; \
        sec=$(echo $now | awk -F. &#39;{print $1}&#39;) &amp;&amp; \
        base_time=&quot;$(((sec + 2) * 1000000000))&quot; &amp;&amp; \
        echo &quot;base time ${base_time}&quot;
tc qdisc add dev eno0 parent root taprio \
        num_tc 8 \
        map 0 1 2 3 4 5 6 7 \
        queues 1@0 1@1 1@2 1@3 1@4 1@5 1@6 1@7 \
        base-time ${base_time} \
        sched-entry S 01  50000 \
        sched-entry S 00  50000 \
        flags 2
</pre></div>
</div>
<p>The engine used to schedule the ingress gate operations is the same that the
one used for the tc-taprio offload. Therefore, the restrictions regarding the
fact that no two gate actions (either tc-gate or tc-taprio gates) may fire at
the same time (during the same 200 ns slot) still apply.</p>
<p>To come in handy, it is possible to share time-triggered virtual links across
more than 1 ingress port, via flow blocks. In this case, the restriction of
firing at the same time does not apply because there is a single schedule in
the system, that of the shared virtual link:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>tc qdisc add dev swp2 ingress_block 1 clsact
tc qdisc add dev swp3 ingress_block 1 clsact
tc filter add block 1 flower skip_sw dst_mac 42:be:24:9b:76:20 \
        action gate index 2 \
        base-time 0 \
        sched-entry OPEN 50000000 -1 -1 \
        sched-entry CLOSE 50000000 -1 -1 \
        action trap
</pre></div>
</div>
<p>Hardware statistics for each flow are also available (“pkts” counts the number
of dropped frames, which is a sum of frames dropped due to timing violations,
lack of destination ports and MTU enforcement checks). Byte-level counters are
not available.</p>
</div>
</div>
<div class="section" id="device-tree-bindings-and-board-design">
<h2>Device Tree bindings and board design<a class="headerlink" href="#device-tree-bindings-and-board-design" title="Permalink to this headline">¶</a></h2>
<p>This section references <code class="docutils literal notranslate"><span class="pre">Documentation/devicetree/bindings/net/dsa/sja1105.txt</span></code>
and aims to showcase some potential switch caveats.</p>
<div class="section" id="rmii-phy-role-and-out-of-band-signaling">
<h3>RMII PHY role and out-of-band signaling<a class="headerlink" href="#rmii-phy-role-and-out-of-band-signaling" title="Permalink to this headline">¶</a></h3>
<p>In the RMII spec, the 50 MHz clock signals are either driven by the MAC or by
an external oscillator (but not by the PHY).
But the spec is rather loose and devices go outside it in several ways.
Some PHYs go against the spec and may provide an output pin where they source
the 50 MHz clock themselves, in an attempt to be helpful.
On the other hand, the SJA1105 is only binary configurable - when in the RMII
MAC role it will also attempt to drive the clock signal. To prevent this from
happening it must be put in RMII PHY role.
But doing so has some unintended consequences.
In the RMII spec, the PHY can transmit extra out-of-band signals via RXD[1:0].
These are practically some extra code words (/J/ and /K/) sent prior to the
preamble of each frame. The MAC does not have this out-of-band signaling
mechanism defined by the RMII spec.
So when the SJA1105 port is put in PHY role to avoid having 2 drivers on the
clock signal, inevitably an RMII PHY-to-PHY connection is created. The SJA1105
emulates a PHY interface fully and generates the /J/ and /K/ symbols prior to
frame preambles, which the real PHY is not expected to understand. So the PHY
simply encodes the extra symbols received from the SJA1105-as-PHY onto the
100Base-Tx wire.
On the other side of the wire, some link partners might discard these extra
symbols, while others might choke on them and discard the entire Ethernet
frames that follow along. This looks like packet loss with some link partners
but not with others.
The take-away is that in RMII mode, the SJA1105 must be let to drive the
reference clock if connected to a PHY.</p>
</div>
<div class="section" id="rgmii-fixed-link-and-internal-delays">
<h3>RGMII fixed-link and internal delays<a class="headerlink" href="#rgmii-fixed-link-and-internal-delays" title="Permalink to this headline">¶</a></h3>
<p>As mentioned in the bindings document, the second generation of devices has
tunable delay lines as part of the MAC, which can be used to establish the
correct RGMII timing budget.
When powered up, these can shift the Rx and Tx clocks with a phase difference
between 73.8 and 101.7 degrees.
The catch is that the delay lines need to lock onto a clock signal with a
stable frequency. This means that there must be at least 2 microseconds of
silence between the clock at the old vs at the new frequency. Otherwise the
lock is lost and the delay lines must be reset (powered down and back up).
In RGMII the clock frequency changes with link speed (125 MHz at 1000 Mbps, 25
MHz at 100 Mbps and 2.5 MHz at 10 Mbps), and link speed might change during the
AN process.
In the situation where the switch port is connected through an RGMII fixed-link
to a link partner whose link state life cycle is outside the control of Linux
(such as a different SoC), then the delay lines would remain unlocked (and
inactive) until there is manual intervention (ifdown/ifup on the switch port).
The take-away is that in RGMII mode, the switch’s internal delays are only
reliable if the link partner never changes link speeds, or if it does, it does
so in a way that is coordinated with the switch port (practically, both ends of
the fixed-link are under control of the same Linux system).
As to why would a fixed-link interface ever change link speeds: there are
Ethernet controllers out there which come out of reset in 100 Mbps mode, and
their driver inevitably needs to change the speed and clock frequency if it’s
required to work at gigabit.</p>
</div>
<div class="section" id="mdio-bus-and-phy-management">
<h3>MDIO bus and PHY management<a class="headerlink" href="#mdio-bus-and-phy-management" title="Permalink to this headline">¶</a></h3>
<p>The SJA1105 does not have an MDIO bus and does not perform in-band AN either.
Therefore there is no link state notification coming from the switch device.
A board would need to hook up the PHYs connected to the switch to any other
MDIO bus available to Linux within the system (e.g. to the DSA master’s MDIO
bus). Link state management then works by the driver manually keeping in sync
(over SPI commands) the MAC link speed with the settings negotiated by the PHY.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="configuration.html" class="btn btn-neutral float-right" title="DSA switch configuration from userspace" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="lan9303.html" class="btn btn-neutral float-left" title="LAN9303 Ethernet switch driver" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright The kernel development community.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>