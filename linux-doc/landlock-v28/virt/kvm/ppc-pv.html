

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>The PPC KVM paravirtual interface &mdash; The Linux Kernel 5.11.0-rc6+ documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="The s390 DIAGNOSE call on KVM" href="s390-diag.html" />
    <link rel="prev" title="Nested VMX" href="nested-vmx.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.11.0-rc6
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devicetree/index.html">Open Firmware and Device Tree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Linux Virtualization Support</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">KVM</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="api.html">The Definitive KVM (Kernel-based Virtual Machine) API Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="amd-memory-encryption.html">Secure Encrypted Virtualization (SEV)</a></li>
<li class="toctree-l3"><a class="reference internal" href="cpuid.html">KVM CPUID bits</a></li>
<li class="toctree-l3"><a class="reference internal" href="halt-polling.html">The KVM halt polling system</a></li>
<li class="toctree-l3"><a class="reference internal" href="hypercalls.html">Linux KVM Hypercall</a></li>
<li class="toctree-l3"><a class="reference internal" href="locking.html">KVM Lock Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="mmu.html">The x86 kvm shadow mmu</a></li>
<li class="toctree-l3"><a class="reference internal" href="msr.html">KVM-specific MSRs</a></li>
<li class="toctree-l3"><a class="reference internal" href="nested-vmx.html">Nested VMX</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">The PPC KVM paravirtual interface</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#querying-for-existence">Querying for existence</a></li>
<li class="toctree-l4"><a class="reference internal" href="#kvm-hypercalls">KVM hypercalls</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-magic-page">The magic page</a></li>
<li class="toctree-l4"><a class="reference internal" href="#magic-page-features">Magic page features</a></li>
<li class="toctree-l4"><a class="reference internal" href="#magic-page-flags">Magic page flags</a></li>
<li class="toctree-l4"><a class="reference internal" href="#msr-bits">MSR bits</a></li>
<li class="toctree-l4"><a class="reference internal" href="#patched-instructions">Patched instructions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#hypercall-abis-in-kvm-on-powerpc">Hypercall ABIs in KVM on PowerPC</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="s390-diag.html">The s390 DIAGNOSE call on KVM</a></li>
<li class="toctree-l3"><a class="reference internal" href="s390-pv.html">s390 (IBM Z) Ultravisor and Protected VMs</a></li>
<li class="toctree-l3"><a class="reference internal" href="s390-pv-boot.html">s390 (IBM Z) Boot/IPL of Protected VMs</a></li>
<li class="toctree-l3"><a class="reference internal" href="timekeeping.html">Timekeeping Virtualization for X86-Based Architectures</a></li>
<li class="toctree-l3"><a class="reference internal" href="vcpu-requests.html">KVM VCPU Requests</a></li>
<li class="toctree-l3"><a class="reference internal" href="review-checklist.html">Review checklist for kvm patches</a></li>
<li class="toctree-l3"><a class="reference internal" href="arm/index.html">ARM</a></li>
<li class="toctree-l3"><a class="reference internal" href="devices/index.html">Devices</a></li>
<li class="toctree-l3"><a class="reference internal" href="running-nested-guests.html">Running nested guests with KVM</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../uml/user_mode_linux_howto_v2.html">UML HowTo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../paravirt_ops.html">Paravirt_ops</a></li>
<li class="toctree-l2"><a class="reference internal" href="../guest-halt-polling.html">Guest halt polling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ne_overview.html">Nitro Enclaves</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mhi/index.html">MHI</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nios2/index.html">Nios II Specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../x86/index.html">x86-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../filesystems/ext4/index.html">ext4 Data Structures and Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Linux Virtualization Support</a> &raquo;</li>
        
          <li><a href="index.html">KVM</a> &raquo;</li>
        
      <li>The PPC KVM paravirtual interface</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/virt/kvm/ppc-pv.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="the-ppc-kvm-paravirtual-interface">
<h1>The PPC KVM paravirtual interface<a class="headerlink" href="#the-ppc-kvm-paravirtual-interface" title="Permalink to this headline">¶</a></h1>
<p>The basic execution principle by which KVM on PowerPC works is to run all kernel
space code in PR=1 which is user space. This way we trap all privileged
instructions and can emulate them accordingly.</p>
<p>Unfortunately that is also the downfall. There are quite some privileged
instructions that needlessly return us to the hypervisor even though they
could be handled differently.</p>
<p>This is what the PPC PV interface helps with. It takes privileged instructions
and transforms them into unprivileged ones with some help from the hypervisor.
This cuts down virtualization costs by about 50% on some of my benchmarks.</p>
<p>The code for that interface can be found in arch/powerpc/kernel/kvm*</p>
<div class="section" id="querying-for-existence">
<h2>Querying for existence<a class="headerlink" href="#querying-for-existence" title="Permalink to this headline">¶</a></h2>
<p>To find out if we’re running on KVM or not, we leverage the device tree. When
Linux is running on KVM, a node /hypervisor exists. That node contains a
compatible property with the value “linux,kvm”.</p>
<p>Once you determined you’re running under a PV capable KVM, you can now use
hypercalls as described below.</p>
</div>
<div class="section" id="kvm-hypercalls">
<h2>KVM hypercalls<a class="headerlink" href="#kvm-hypercalls" title="Permalink to this headline">¶</a></h2>
<p>Inside the device tree’s /hypervisor node there’s a property called
‘hypercall-instructions’. This property contains at most 4 opcodes that make
up the hypercall. To call a hypercall, just call these instructions.</p>
<p>The parameters are as follows:</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 40%" />
<col style="width: 40%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Register</p></th>
<th class="head"><p>IN</p></th>
<th class="head"><p>OUT</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>r0</p></td>
<td><ul class="simple">
<li></li>
</ul>
</td>
<td><p>volatile</p></td>
</tr>
<tr class="row-odd"><td><p>r3</p></td>
<td><p>1st parameter</p></td>
<td><p>Return code</p></td>
</tr>
<tr class="row-even"><td><p>r4</p></td>
<td><p>2nd parameter</p></td>
<td><p>1st output value</p></td>
</tr>
<tr class="row-odd"><td><p>r5</p></td>
<td><p>3rd parameter</p></td>
<td><p>2nd output value</p></td>
</tr>
<tr class="row-even"><td><p>r6</p></td>
<td><p>4th parameter</p></td>
<td><p>3rd output value</p></td>
</tr>
<tr class="row-odd"><td><p>r7</p></td>
<td><p>5th parameter</p></td>
<td><p>4th output value</p></td>
</tr>
<tr class="row-even"><td><p>r8</p></td>
<td><p>6th parameter</p></td>
<td><p>5th output value</p></td>
</tr>
<tr class="row-odd"><td><p>r9</p></td>
<td><p>7th parameter</p></td>
<td><p>6th output value</p></td>
</tr>
<tr class="row-even"><td><p>r10</p></td>
<td><p>8th parameter</p></td>
<td><p>7th output value</p></td>
</tr>
<tr class="row-odd"><td><p>r11</p></td>
<td><p>hypercall number</p></td>
<td><p>8th output value</p></td>
</tr>
<tr class="row-even"><td><p>r12</p></td>
<td><ul class="simple">
<li></li>
</ul>
</td>
<td><p>volatile</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>Hypercall definitions are shared in generic code, so the same hypercall numbers
apply for x86 and powerpc alike with the exception that each KVM hypercall
also needs to be ORed with the KVM vendor code which is (42 &lt;&lt; 16).</p>
<p>Return codes can be as follows:</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 86%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Code</p></th>
<th class="head"><p>Meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>Success</p></td>
</tr>
<tr class="row-odd"><td><p>12</p></td>
<td><p>Hypercall not implemented</p></td>
</tr>
<tr class="row-even"><td><p>&lt;0</p></td>
<td><p>Error</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="the-magic-page">
<h2>The magic page<a class="headerlink" href="#the-magic-page" title="Permalink to this headline">¶</a></h2>
<p>To enable communication between the hypervisor and guest there is a new shared
page that contains parts of supervisor visible register state. The guest can
map this shared page using the KVM hypercall KVM_HC_PPC_MAP_MAGIC_PAGE.</p>
<p>With this hypercall issued the guest always gets the magic page mapped at the
desired location. The first parameter indicates the effective address when the
MMU is enabled. The second parameter indicates the address in real mode, if
applicable to the target. For now, we always map the page to -4096. This way we
can access it using absolute load and store functions. The following
instruction reads the first field of the magic page:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ld      rX, -4096(0)
</pre></div>
</div>
<p>The interface is designed to be extensible should there be need later to add
additional registers to the magic page. If you add fields to the magic page,
also define a new hypercall feature to indicate that the host can give you more
registers. Only if the host supports the additional features, make use of them.</p>
<p>The magic page layout is described by struct kvm_vcpu_arch_shared
in arch/powerpc/include/asm/kvm_para.h.</p>
</div>
<div class="section" id="magic-page-features">
<h2>Magic page features<a class="headerlink" href="#magic-page-features" title="Permalink to this headline">¶</a></h2>
<p>When mapping the magic page using the KVM hypercall KVM_HC_PPC_MAP_MAGIC_PAGE,
a second return value is passed to the guest. This second return value contains
a bitmap of available features inside the magic page.</p>
<p>The following enhancements to the magic page are currently available:</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 42%" />
<col style="width: 58%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>KVM_MAGIC_FEAT_SR</p></td>
<td><p>Maps SR registers r/w in the magic page</p></td>
</tr>
<tr class="row-even"><td><p>KVM_MAGIC_FEAT_MAS0_TO_SPRG7</p></td>
<td><p>Maps MASn, ESR, PIR and high SPRGs</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>For enhanced features in the magic page, please check for the existence of the
feature before using them!</p>
</div>
<div class="section" id="magic-page-flags">
<h2>Magic page flags<a class="headerlink" href="#magic-page-flags" title="Permalink to this headline">¶</a></h2>
<p>In addition to features that indicate whether a host is capable of a particular
feature we also have a channel for a guest to tell the guest whether it’s capable
of something. This is what we call “flags”.</p>
<p>Flags are passed to the host in the low 12 bits of the Effective Address.</p>
<p>The following flags are currently available for a guest to expose:</p>
<blockquote>
<div><p>MAGIC_PAGE_FLAG_NOT_MAPPED_NX Guest handles NX bits correctly wrt magic page</p>
</div></blockquote>
</div>
<div class="section" id="msr-bits">
<h2>MSR bits<a class="headerlink" href="#msr-bits" title="Permalink to this headline">¶</a></h2>
<p>The MSR contains bits that require hypervisor intervention and bits that do
not require direct hypervisor intervention because they only get interpreted
when entering the guest or don’t have any impact on the hypervisor’s behavior.</p>
<p>The following bits are safe to be set inside the guest:</p>
<blockquote>
<div><ul class="simple">
<li><p>MSR_EE</p></li>
<li><p>MSR_RI</p></li>
</ul>
</div></blockquote>
<p>If any other bit changes in the MSR, please still use mtmsr(d).</p>
</div>
<div class="section" id="patched-instructions">
<h2>Patched instructions<a class="headerlink" href="#patched-instructions" title="Permalink to this headline">¶</a></h2>
<p>The “ld” and “std” instructions are transformed to “lwz” and “stw” instructions
respectively on 32 bit systems with an added offset of 4 to accommodate for big
endianness.</p>
<p>The following is a list of mapping the Linux kernel performs when running as
guest. Implementing any of those mappings is optional, as the instruction traps
also act on the shared page. So calling privileged instructions still works as
before.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 42%" />
<col style="width: 58%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>From</p></th>
<th class="head"><p>To</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>mfmsr   rX</p></td>
<td><p>ld      rX, magic_page-&gt;msr</p></td>
</tr>
<tr class="row-odd"><td><p>mfsprg  rX, 0</p></td>
<td><p>ld      rX, magic_page-&gt;sprg0</p></td>
</tr>
<tr class="row-even"><td><p>mfsprg  rX, 1</p></td>
<td><p>ld      rX, magic_page-&gt;sprg1</p></td>
</tr>
<tr class="row-odd"><td><p>mfsprg  rX, 2</p></td>
<td><p>ld      rX, magic_page-&gt;sprg2</p></td>
</tr>
<tr class="row-even"><td><p>mfsprg  rX, 3</p></td>
<td><p>ld      rX, magic_page-&gt;sprg3</p></td>
</tr>
<tr class="row-odd"><td><p>mfsrr0  rX</p></td>
<td><p>ld      rX, magic_page-&gt;srr0</p></td>
</tr>
<tr class="row-even"><td><p>mfsrr1  rX</p></td>
<td><p>ld      rX, magic_page-&gt;srr1</p></td>
</tr>
<tr class="row-odd"><td><p>mfdar   rX</p></td>
<td><p>ld      rX, magic_page-&gt;dar</p></td>
</tr>
<tr class="row-even"><td><p>mfdsisr rX</p></td>
<td><p>lwz     rX, magic_page-&gt;dsisr</p></td>
</tr>
<tr class="row-odd"><td><p>mtmsr   rX</p></td>
<td><p>std     rX, magic_page-&gt;msr</p></td>
</tr>
<tr class="row-even"><td><p>mtsprg  0, rX</p></td>
<td><p>std     rX, magic_page-&gt;sprg0</p></td>
</tr>
<tr class="row-odd"><td><p>mtsprg  1, rX</p></td>
<td><p>std     rX, magic_page-&gt;sprg1</p></td>
</tr>
<tr class="row-even"><td><p>mtsprg  2, rX</p></td>
<td><p>std     rX, magic_page-&gt;sprg2</p></td>
</tr>
<tr class="row-odd"><td><p>mtsprg  3, rX</p></td>
<td><p>std     rX, magic_page-&gt;sprg3</p></td>
</tr>
<tr class="row-even"><td><p>mtsrr0  rX</p></td>
<td><p>std     rX, magic_page-&gt;srr0</p></td>
</tr>
<tr class="row-odd"><td><p>mtsrr1  rX</p></td>
<td><p>std     rX, magic_page-&gt;srr1</p></td>
</tr>
<tr class="row-even"><td><p>mtdar   rX</p></td>
<td><p>std     rX, magic_page-&gt;dar</p></td>
</tr>
<tr class="row-odd"><td><p>mtdsisr rX</p></td>
<td><p>stw     rX, magic_page-&gt;dsisr</p></td>
</tr>
<tr class="row-even"><td><p>tlbsync</p></td>
<td><p>nop</p></td>
</tr>
<tr class="row-odd"><td><p>mtmsrd  rX, 0</p></td>
<td><p>b       &lt;special mtmsr section&gt;</p></td>
</tr>
<tr class="row-even"><td><p>mtmsr   rX</p></td>
<td><p>b       &lt;special mtmsr section&gt;</p></td>
</tr>
<tr class="row-odd"><td><p>mtmsrd  rX, 1</p></td>
<td><p>b       &lt;special mtmsrd section&gt;</p></td>
</tr>
<tr class="row-even"><td><p>[Book3S only]</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>mtsrin  rX, rY</p></td>
<td><p>b       &lt;special mtsrin section&gt;</p></td>
</tr>
<tr class="row-even"><td><p>[BookE only]</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>wrteei  [0|1]</p></td>
<td><p>b       &lt;special wrteei section&gt;</p></td>
</tr>
</tbody>
</table>
<p>Some instructions require more logic to determine what’s going on than a load
or store instruction can deliver. To enable patching of those, we keep some
RAM around where we can live translate instructions to. What happens is the
following:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>copy emulation code to memory</p></li>
<li><p>patch that code to fit the emulated instruction</p></li>
<li><p>patch that code to return to the original pc + 4</p></li>
<li><p>patch the original instruction to branch to the new code</p></li>
</ol>
</div></blockquote>
<p>That way we can inject an arbitrary amount of code as replacement for a single
instruction. This allows us to check for pending interrupts when setting EE=1
for example.</p>
</div>
<div class="section" id="hypercall-abis-in-kvm-on-powerpc">
<h2>Hypercall ABIs in KVM on PowerPC<a class="headerlink" href="#hypercall-abis-in-kvm-on-powerpc" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p>KVM hypercalls (ePAPR)</p></li>
</ol>
<p>These are ePAPR compliant hypercall implementation (mentioned above). Even
generic hypercalls are implemented here, like the ePAPR idle hcall. These are
available on all targets.</p>
<ol class="arabic simple" start="2">
<li><p>PAPR hypercalls</p></li>
</ol>
<p>PAPR hypercalls are needed to run server PowerPC PAPR guests (-M pseries in QEMU).
These are the same hypercalls that pHyp, the POWER hypervisor implements. Some of
them are handled in the kernel, some are handled in user space. This is only
available on book3s_64.</p>
<ol class="arabic simple" start="3">
<li><p>OSI hypercalls</p></li>
</ol>
<p>Mac-on-Linux is another user of KVM on PowerPC, which has its own hypercall (long
before KVM). This is supported to maintain compatibility. All these hypercalls get
forwarded to user space. This is only useful on book3s_32, but can be used with
book3s_64 as well.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="s390-diag.html" class="btn btn-neutral float-right" title="The s390 DIAGNOSE call on KVM" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="nested-vmx.html" class="btn btn-neutral float-left" title="Nested VMX" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright The kernel development community.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>