

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>8. The PCI Express Advanced Error Reporting Driver Guide HOWTO &mdash; The Linux Kernel  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="9. PCI Endpoint Framework" href="endpoint/index.html" />
    <link rel="prev" title="7. PCI Error Recovery" href="pci-error-recovery.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.10.0-rc7
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">Open Firmware and Device Tree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usb/index.html">USB support</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Linux PCI Bus Subsystem</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="pci.html">1. How To Write Linux PCI Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="pciebus-howto.html">2. The PCI Express Port Bus Driver Guide HOWTO</a></li>
<li class="toctree-l2"><a class="reference internal" href="pci-iov-howto.html">3. PCI Express I/O Virtualization Howto</a></li>
<li class="toctree-l2"><a class="reference internal" href="msi-howto.html">4. The MSI Driver Guide HOWTO</a></li>
<li class="toctree-l2"><a class="reference internal" href="sysfs-pci.html">5. Accessing PCI device resources through sysfs</a></li>
<li class="toctree-l2"><a class="reference internal" href="acpi-info.html">6. ACPI considerations for PCI host bridges</a></li>
<li class="toctree-l2"><a class="reference internal" href="pci-error-recovery.html">7. PCI Error Recovery</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">8. The PCI Express Advanced Error Reporting Driver Guide HOWTO</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">8.1. Overview</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#about-this-guide">8.1.1. About this guide</a></li>
<li class="toctree-l4"><a class="reference internal" href="#what-is-the-pci-express-aer-driver">8.1.2. What is the PCI Express AER Driver?</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#user-guide">8.2. User Guide</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#include-the-pci-express-aer-root-driver-into-the-linux-kernel">8.2.1. Include the PCI Express AER Root Driver into the Linux Kernel</a></li>
<li class="toctree-l4"><a class="reference internal" href="#load-pci-express-aer-root-driver">8.2.2. Load PCI Express AER Root Driver</a></li>
<li class="toctree-l4"><a class="reference internal" href="#aer-error-output">8.2.3. AER error output</a></li>
<li class="toctree-l4"><a class="reference internal" href="#aer-statistics-counters">8.2.4. AER Statistics / Counters</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#developer-guide">8.3. Developer Guide</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#configure-the-aer-capability-structure">8.3.1. Configure the AER capability structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="#provide-callbacks">8.3.2. Provide callbacks</a></li>
<li class="toctree-l4"><a class="reference internal" href="#helper-functions">8.3.3. helper functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#frequent-asked-questions">8.3.4. Frequent Asked Questions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#software-error-injection">8.4. Software error injection</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="endpoint/index.html">9. PCI Endpoint Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="boot-interrupts.html">10. Boot Interrupts</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mhi/index.html">MHI</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nios2/nios2.html">Linux on the Nios II architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../x86/index.html">x86-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/ext4/index.html">ext4 Data Structures and Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Linux PCI Bus Subsystem</a> &raquo;</li>
        
      <li><span class="section-number">8. </span>The PCI Express Advanced Error Reporting Driver Guide HOWTO</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/PCI/pcieaer-howto.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="the-pci-express-advanced-error-reporting-driver-guide-howto">
<h1><span class="section-number">8. </span>The PCI Express Advanced Error Reporting Driver Guide HOWTO<a class="headerlink" href="#the-pci-express-advanced-error-reporting-driver-guide-howto" title="Permalink to this headline">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Authors</dt>
<dd class="field-odd"><ul class="simple">
<li><ol class="upperalpha simple" start="20">
<li><p>Long Nguyen &lt;<a class="reference external" href="mailto:tom&#46;l&#46;nguyen&#37;&#52;&#48;intel&#46;com">tom<span>&#46;</span>l<span>&#46;</span>nguyen<span>&#64;</span>intel<span>&#46;</span>com</a>&gt;</p></li>
</ol>
</li>
<li><p>Yanmin Zhang &lt;<a class="reference external" href="mailto:yanmin&#46;zhang&#37;&#52;&#48;intel&#46;com">yanmin<span>&#46;</span>zhang<span>&#64;</span>intel<span>&#46;</span>com</a>&gt;</p></li>
</ul>
</dd>
<dt class="field-even">Copyright</dt>
<dd class="field-even"><p>© 2006 Intel Corporation</p>
</dd>
</dl>
<div class="section" id="overview">
<h2><span class="section-number">8.1. </span>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<div class="section" id="about-this-guide">
<h3><span class="section-number">8.1.1. </span>About this guide<a class="headerlink" href="#about-this-guide" title="Permalink to this headline">¶</a></h3>
<p>This guide describes the basics of the PCI Express Advanced Error
Reporting (AER) driver and provides information on how to use it, as
well as how to enable the drivers of endpoint devices to conform with
PCI Express AER driver.</p>
</div>
<div class="section" id="what-is-the-pci-express-aer-driver">
<h3><span class="section-number">8.1.2. </span>What is the PCI Express AER Driver?<a class="headerlink" href="#what-is-the-pci-express-aer-driver" title="Permalink to this headline">¶</a></h3>
<p>PCI Express error signaling can occur on the PCI Express link itself
or on behalf of transactions initiated on the link. PCI Express
defines two error reporting paradigms: the baseline capability and
the Advanced Error Reporting capability. The baseline capability is
required of all PCI Express components providing a minimum defined
set of error reporting requirements. Advanced Error Reporting
capability is implemented with a PCI Express advanced error reporting
extended capability structure providing more robust error reporting.</p>
<p>The PCI Express AER driver provides the infrastructure to support PCI
Express Advanced Error Reporting capability. The PCI Express AER
driver provides three basic functions:</p>
<blockquote>
<div><ul class="simple">
<li><p>Gathers the comprehensive error information if errors occurred.</p></li>
<li><p>Reports error to the users.</p></li>
<li><p>Performs error recovery actions.</p></li>
</ul>
</div></blockquote>
<p>AER driver only attaches root ports which support PCI-Express AER
capability.</p>
</div>
</div>
<div class="section" id="user-guide">
<h2><span class="section-number">8.2. </span>User Guide<a class="headerlink" href="#user-guide" title="Permalink to this headline">¶</a></h2>
<div class="section" id="include-the-pci-express-aer-root-driver-into-the-linux-kernel">
<h3><span class="section-number">8.2.1. </span>Include the PCI Express AER Root Driver into the Linux Kernel<a class="headerlink" href="#include-the-pci-express-aer-root-driver-into-the-linux-kernel" title="Permalink to this headline">¶</a></h3>
<p>The PCI Express AER Root driver is a Root Port service driver attached
to the PCI Express Port Bus driver. If a user wants to use it, the driver
has to be compiled. Option CONFIG_PCIEAER supports this capability. It
depends on CONFIG_PCIEPORTBUS, so pls. set CONFIG_PCIEPORTBUS=y and
CONFIG_PCIEAER = y.</p>
</div>
<div class="section" id="load-pci-express-aer-root-driver">
<h3><span class="section-number">8.2.2. </span>Load PCI Express AER Root Driver<a class="headerlink" href="#load-pci-express-aer-root-driver" title="Permalink to this headline">¶</a></h3>
<p>Some systems have AER support in firmware. Enabling Linux AER support at
the same time the firmware handles AER may result in unpredictable
behavior. Therefore, Linux does not handle AER events unless the firmware
grants AER control to the OS via the ACPI _OSC method. See the PCI FW 3.0
Specification for details regarding _OSC usage.</p>
</div>
<div class="section" id="aer-error-output">
<h3><span class="section-number">8.2.3. </span>AER error output<a class="headerlink" href="#aer-error-output" title="Permalink to this headline">¶</a></h3>
<p>When a PCIe AER error is captured, an error message will be output to
console. If it’s a correctable error, it is output as a warning.
Otherwise, it is printed as an error. So users could choose different
log level to filter out correctable error messages.</p>
<p>Below shows an example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>0000:50:00.0: PCIe Bus Error: severity=Uncorrected (Fatal), type=Transaction Layer, id=0500(Requester ID)
0000:50:00.0:   device [8086:0329] error status/mask=00100000/00000000
0000:50:00.0:    [20] Unsupported Request    (First)
0000:50:00.0:   TLP Header: 04000001 00200a03 05010000 00050100
</pre></div>
</div>
<p>In the example, ‘Requester ID’ means the ID of the device who sends
the error message to root port. Pls. refer to pci express specs for
other fields.</p>
</div>
<div class="section" id="aer-statistics-counters">
<h3><span class="section-number">8.2.4. </span>AER Statistics / Counters<a class="headerlink" href="#aer-statistics-counters" title="Permalink to this headline">¶</a></h3>
<p>When PCIe AER errors are captured, the counters / statistics are also exposed
in the form of sysfs attributes which are documented at
Documentation/ABI/testing/sysfs-bus-pci-devices-aer_stats</p>
</div>
</div>
<div class="section" id="developer-guide">
<h2><span class="section-number">8.3. </span>Developer Guide<a class="headerlink" href="#developer-guide" title="Permalink to this headline">¶</a></h2>
<p>To enable AER aware support requires a software driver to configure
the AER capability structure within its device and to provide callbacks.</p>
<p>To support AER better, developers need understand how AER does work
firstly.</p>
<p>PCI Express errors are classified into two types: correctable errors
and uncorrectable errors. This classification is based on the impacts
of those errors, which may result in degraded performance or function
failure.</p>
<p>Correctable errors pose no impacts on the functionality of the
interface. The PCI Express protocol can recover without any software
intervention or any loss of data. These errors are detected and
corrected by hardware. Unlike correctable errors, uncorrectable
errors impact functionality of the interface. Uncorrectable errors
can cause a particular transaction or a particular PCI Express link
to be unreliable. Depending on those error conditions, uncorrectable
errors are further classified into non-fatal errors and fatal errors.
Non-fatal errors cause the particular transaction to be unreliable,
but the PCI Express link itself is fully functional. Fatal errors, on
the other hand, cause the link to be unreliable.</p>
<p>When AER is enabled, a PCI Express device will automatically send an
error message to the PCIe root port above it when the device captures
an error. The Root Port, upon receiving an error reporting message,
internally processes and logs the error message in its PCI Express
capability structure. Error information being logged includes storing
the error reporting agent’s requestor ID into the Error Source
Identification Registers and setting the error bits of the Root Error
Status Register accordingly. If AER error reporting is enabled in Root
Error Command Register, the Root Port generates an interrupt if an
error is detected.</p>
<p>Note that the errors as described above are related to the PCI Express
hierarchy and links. These errors do not include any device specific
errors because device specific errors will still get sent directly to
the device driver.</p>
<div class="section" id="configure-the-aer-capability-structure">
<h3><span class="section-number">8.3.1. </span>Configure the AER capability structure<a class="headerlink" href="#configure-the-aer-capability-structure" title="Permalink to this headline">¶</a></h3>
<p>AER aware drivers of PCI Express component need change the device
control registers to enable AER. They also could change AER registers,
including mask and severity registers. Helper function
pci_enable_pcie_error_reporting could be used to enable AER. See
section 3.3.</p>
</div>
<div class="section" id="provide-callbacks">
<h3><span class="section-number">8.3.2. </span>Provide callbacks<a class="headerlink" href="#provide-callbacks" title="Permalink to this headline">¶</a></h3>
<div class="section" id="callback-reset-link-to-reset-pci-express-link">
<h4><span class="section-number">8.3.2.1. </span>callback reset_link to reset pci express link<a class="headerlink" href="#callback-reset-link-to-reset-pci-express-link" title="Permalink to this headline">¶</a></h4>
<p>This callback is used to reset the pci express physical link when a
fatal error happens. The root port aer service driver provides a
default reset_link function, but different upstream ports might
have different specifications to reset pci express link, so all
upstream ports should provide their own reset_link functions.</p>
<p>Section 3.2.2.2 provides more detailed info on when to call
reset_link.</p>
</div>
<div class="section" id="pci-error-recovery-callbacks">
<h4><span class="section-number">8.3.2.2. </span>PCI error-recovery callbacks<a class="headerlink" href="#pci-error-recovery-callbacks" title="Permalink to this headline">¶</a></h4>
<p>The PCI Express AER Root driver uses error callbacks to coordinate
with downstream device drivers associated with a hierarchy in question
when performing error recovery actions.</p>
<p>Data <a class="reference internal" href="pci.html#c.pci_driver" title="pci_driver"><code class="xref c c-struct docutils literal notranslate"><span class="pre">struct</span> <span class="pre">pci_driver</span></code></a> has a pointer, err_handler, to point to
pci_error_handlers who consists of a couple of callback function
pointers. AER driver follows the rules defined in
pci-error-recovery.txt except pci express specific parts (e.g.
reset_link). Pls. refer to pci-error-recovery.txt for detailed
definitions of the callbacks.</p>
<p>Below sections specify when to call the error callback functions.</p>
</div>
<div class="section" id="correctable-errors">
<h4><span class="section-number">8.3.2.3. </span>Correctable errors<a class="headerlink" href="#correctable-errors" title="Permalink to this headline">¶</a></h4>
<p>Correctable errors pose no impacts on the functionality of
the interface. The PCI Express protocol can recover without any
software intervention or any loss of data. These errors do not
require any recovery actions. The AER driver clears the device’s
correctable error status register accordingly and logs these errors.</p>
</div>
<div class="section" id="non-correctable-non-fatal-and-fatal-errors">
<h4><span class="section-number">8.3.2.4. </span>Non-correctable (non-fatal and fatal) errors<a class="headerlink" href="#non-correctable-non-fatal-and-fatal-errors" title="Permalink to this headline">¶</a></h4>
<p>If an error message indicates a non-fatal error, performing link reset
at upstream is not required. The AER driver calls error_detected(dev,
pci_channel_io_normal) to all drivers associated within a hierarchy in
question. for example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>EndPoint&lt;==&gt;DownstreamPort B&lt;==&gt;UpstreamPort A&lt;==&gt;RootPort
</pre></div>
</div>
<p>If Upstream port A captures an AER error, the hierarchy consists of
Downstream port B and EndPoint.</p>
<p>A driver may return PCI_ERS_RESULT_CAN_RECOVER,
PCI_ERS_RESULT_DISCONNECT, or PCI_ERS_RESULT_NEED_RESET, depending on
whether it can recover or the AER driver calls mmio_enabled as next.</p>
<p>If an error message indicates a fatal error, kernel will broadcast
error_detected(dev, pci_channel_io_frozen) to all drivers within
a hierarchy in question. Then, performing link reset at upstream is
necessary. As different kinds of devices might use different approaches
to reset link, AER port service driver is required to provide the
function to reset link via callback parameter of pcie_do_recovery()
function. If reset_link is not NULL, recovery function will use it
to reset the link. If error_detected returns PCI_ERS_RESULT_CAN_RECOVER
and reset_link returns PCI_ERS_RESULT_RECOVERED, the error handling goes
to mmio_enabled.</p>
</div>
</div>
<div class="section" id="helper-functions">
<h3><span class="section-number">8.3.3. </span>helper functions<a class="headerlink" href="#helper-functions" title="Permalink to this headline">¶</a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>int pci_enable_pcie_error_reporting(struct pci_dev *dev);
</pre></div>
</div>
<p>pci_enable_pcie_error_reporting enables the device to send error
messages to root port when an error is detected. Note that devices
don’t enable the error reporting by default, so device drivers need
call this function to enable it.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>int pci_disable_pcie_error_reporting(struct pci_dev *dev);
</pre></div>
</div>
<p>pci_disable_pcie_error_reporting disables the device to send error
messages to root port when an error is detected.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>int pci_aer_clear_nonfatal_status(struct pci_dev *dev);`
</pre></div>
</div>
<p>pci_aer_clear_nonfatal_status clears non-fatal errors in the uncorrectable
error status register.</p>
</div>
<div class="section" id="frequent-asked-questions">
<h3><span class="section-number">8.3.4. </span>Frequent Asked Questions<a class="headerlink" href="#frequent-asked-questions" title="Permalink to this headline">¶</a></h3>
<dl class="simple">
<dt>Q:</dt><dd><p>What happens if a PCI Express device driver does not provide an
error recovery handler (pci_driver-&gt;err_handler is equal to NULL)?</p>
</dd>
<dt>A:</dt><dd><p>The devices attached with the driver won’t be recovered. If the
error is fatal, kernel will print out warning messages. Please refer
to section 3 for more information.</p>
</dd>
<dt>Q:</dt><dd><p>What happens if an upstream port service driver does not provide
callback reset_link?</p>
</dd>
<dt>A:</dt><dd><p>Fatal error recovery will fail if the errors are reported by the
upstream ports who are attached by the service driver.</p>
</dd>
<dt>Q:</dt><dd><p>How does this infrastructure deal with driver that is not PCI
Express aware?</p>
</dd>
<dt>A:</dt><dd><p>This infrastructure calls the error callback functions of the
driver when an error happens. But if the driver is not aware of
PCI Express, the device might not report its own errors to root
port.</p>
</dd>
<dt>Q:</dt><dd><p>What modifications will that driver need to make it compatible
with the PCI Express AER Root driver?</p>
</dd>
<dt>A:</dt><dd><p>It could call the helper functions to enable AER in devices and
cleanup uncorrectable status register. Pls. refer to section 3.3.</p>
</dd>
</dl>
</div>
</div>
<div class="section" id="software-error-injection">
<h2><span class="section-number">8.4. </span>Software error injection<a class="headerlink" href="#software-error-injection" title="Permalink to this headline">¶</a></h2>
<p>Debugging PCIe AER error recovery code is quite difficult because it
is hard to trigger real hardware errors. Software based error
injection can be used to fake various kinds of PCIe errors.</p>
<p>First you should enable PCIe AER software error injection in kernel
configuration, that is, following item should be in your .config.</p>
<p>CONFIG_PCIEAER_INJECT=y or CONFIG_PCIEAER_INJECT=m</p>
<p>After reboot with new kernel or insert the module, a device file named
/dev/aer_inject should be created.</p>
<p>Then, you need a user space tool named aer-inject, which can be gotten
from:</p>
<blockquote>
<div><p><a class="reference external" href="https://git.kernel.org/cgit/linux/kernel/git/gong.chen/aer-inject.git/">https://git.kernel.org/cgit/linux/kernel/git/gong.chen/aer-inject.git/</a></p>
</div></blockquote>
<p>More information about aer-inject can be found in the document comes
with its source code.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="endpoint/index.html" class="btn btn-neutral float-right" title="9. PCI Endpoint Framework" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="pci-error-recovery.html" class="btn btn-neutral float-left" title="7. PCI Error Recovery" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright The kernel development community

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>