

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>POWER9 eXternal Interrupt Virtualization Engine (XIVE Gen1) &mdash; The Linux Kernel 5.12.0-rc3+ documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Running nested guests with KVM" href="../running-nested-guests.html" />
    <link rel="prev" title="XICS interrupt controller" href="xics.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.12.0-rc3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devicetree/index.html">Open Firmware and Device Tree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Linux Virtualization Support</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">KVM</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../api.html">The Definitive KVM (Kernel-based Virtual Machine) API Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../amd-memory-encryption.html">Secure Encrypted Virtualization (SEV)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cpuid.html">KVM CPUID bits</a></li>
<li class="toctree-l3"><a class="reference internal" href="../halt-polling.html">The KVM halt polling system</a></li>
<li class="toctree-l3"><a class="reference internal" href="../hypercalls.html">Linux KVM Hypercall</a></li>
<li class="toctree-l3"><a class="reference internal" href="../locking.html">KVM Lock Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mmu.html">The x86 kvm shadow mmu</a></li>
<li class="toctree-l3"><a class="reference internal" href="../msr.html">KVM-specific MSRs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nested-vmx.html">Nested VMX</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ppc-pv.html">The PPC KVM paravirtual interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../s390-diag.html">The s390 DIAGNOSE call on KVM</a></li>
<li class="toctree-l3"><a class="reference internal" href="../s390-pv.html">s390 (IBM Z) Ultravisor and Protected VMs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../s390-pv-boot.html">s390 (IBM Z) Boot/IPL of Protected VMs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../timekeeping.html">Timekeeping Virtualization for X86-Based Architectures</a></li>
<li class="toctree-l3"><a class="reference internal" href="../vcpu-requests.html">KVM VCPU Requests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../review-checklist.html">Review checklist for kvm patches</a></li>
<li class="toctree-l3"><a class="reference internal" href="../arm/index.html">ARM</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Devices</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="arm-vgic-its.html">ARM Virtual Interrupt Translation Service (ITS)</a></li>
<li class="toctree-l4"><a class="reference internal" href="arm-vgic.html">ARM Virtual Generic Interrupt Controller v2 (VGIC)</a></li>
<li class="toctree-l4"><a class="reference internal" href="arm-vgic-v3.html">ARM Virtual Generic Interrupt Controller v3 and later (VGICv3)</a></li>
<li class="toctree-l4"><a class="reference internal" href="mpic.html">MPIC interrupt controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="s390_flic.html">FLIC (floating interrupt controller)</a></li>
<li class="toctree-l4"><a class="reference internal" href="vcpu.html">Generic vcpu interface</a></li>
<li class="toctree-l4"><a class="reference internal" href="vfio.html">VFIO virtual device</a></li>
<li class="toctree-l4"><a class="reference internal" href="vm.html">Generic vm interface</a></li>
<li class="toctree-l4"><a class="reference internal" href="xics.html">XICS interrupt controller</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">POWER9 eXternal Interrupt Virtualization Engine (XIVE Gen1)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../running-nested-guests.html">Running nested guests with KVM</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../uml/user_mode_linux_howto_v2.html">UML HowTo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../paravirt_ops.html">Paravirt_ops</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guest-halt-polling.html">Guest halt polling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ne_overview.html">Nitro Enclaves</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../acrn/index.html">ACRN Hypervisor</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mhi/index.html">MHI</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nios2/index.html">Nios II Specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../x86/index.html">x86-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Linux Virtualization Support</a> &raquo;</li>
        
          <li><a href="../index.html">KVM</a> &raquo;</li>
        
          <li><a href="index.html">Devices</a> &raquo;</li>
        
      <li>POWER9 eXternal Interrupt Virtualization Engine (XIVE Gen1)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../_sources/virt/kvm/devices/xive.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="power9-external-interrupt-virtualization-engine-xive-gen1">
<h1>POWER9 eXternal Interrupt Virtualization Engine (XIVE Gen1)<a class="headerlink" href="#power9-external-interrupt-virtualization-engine-xive-gen1" title="Permalink to this headline">¶</a></h1>
<dl class="simple">
<dt>Device types supported:</dt><dd><ul class="simple">
<li><p>KVM_DEV_TYPE_XIVE     POWER9 XIVE Interrupt Controller generation 1</p></li>
</ul>
</dd>
</dl>
<p>This device acts as a VM interrupt controller. It provides the KVM
interface to configure the interrupt sources of a VM in the underlying
POWER9 XIVE interrupt controller.</p>
<p>Only one XIVE instance may be instantiated. A guest XIVE device
requires a POWER9 host and the guest OS should have support for the
XIVE native exploitation interrupt mode. If not, it should run using
the legacy interrupt mode, referred as XICS (POWER7/8).</p>
<ul>
<li><p>Device Mappings</p>
<p>The KVM device exposes different MMIO ranges of the XIVE HW which
are required for interrupt management. These are exposed to the
guest in VMAs populated with a custom VM fault handler.</p>
<ol class="arabic simple">
<li><p>Thread Interrupt Management Area (TIMA)</p></li>
</ol>
<p>Each thread has an associated Thread Interrupt Management context
composed of a set of registers. These registers let the thread
handle priority management and interrupt acknowledgment. The most
important are :</p>
<blockquote>
<div><ul class="simple">
<li><p>Interrupt Pending Buffer     (IPB)</p></li>
<li><p>Current Processor Priority   (CPPR)</p></li>
<li><p>Notification Source Register (NSR)</p></li>
</ul>
</div></blockquote>
<p>They are exposed to software in four different pages each proposing
a view with a different privilege. The first page is for the
physical thread context and the second for the hypervisor. Only the
third (operating system) and the fourth (user level) are exposed the
guest.</p>
<ol class="arabic simple" start="2">
<li><p>Event State Buffer (ESB)</p></li>
</ol>
<p>Each source is associated with an Event State Buffer (ESB) with
either a pair of even/odd pair of pages which provides commands to
manage the source: to trigger, to EOI, to turn off the source for
instance.</p>
<ol class="arabic simple" start="3">
<li><p>Device pass-through</p></li>
</ol>
<p>When a device is passed-through into the guest, the source
interrupts are from a different HW controller (PHB4) and the ESB
pages exposed to the guest should accommadate this change.</p>
<p>The passthru_irq helpers, kvmppc_xive_set_mapped() and
kvmppc_xive_clr_mapped() are called when the device HW irqs are
mapped into or unmapped from the guest IRQ number space. The KVM
device extends these helpers to clear the ESB pages of the guest IRQ
number being mapped and then lets the VM fault handler repopulate.
The handler will insert the ESB page corresponding to the HW
interrupt of the device being passed-through or the initial IPI ESB
page if the device has being removed.</p>
<p>The ESB remapping is fully transparent to the guest and the OS
device driver. All handling is done within VFIO and the above
helpers in KVM-PPC.</p>
</li>
<li><p>Groups:</p></li>
</ul>
<ol class="arabic simple">
<li><dl class="simple">
<dt>KVM_DEV_XIVE_GRP_CTRL</dt><dd><p>Provides global controls on the device</p>
</dd>
</dl>
</li>
</ol>
<blockquote>
<div><dl>
<dt>Attributes:</dt><dd><p>1.1 KVM_DEV_XIVE_RESET (write only)
Resets the interrupt controller configuration for sources and event
queues. To be used by kexec and kdump.</p>
<p>Errors: none</p>
<p>1.2 KVM_DEV_XIVE_EQ_SYNC (write only)
Sync all the sources and queues and mark the EQ pages dirty. This
to make sure that a consistent memory state is captured when
migrating the VM.</p>
<p>Errors: none</p>
<p>1.3 KVM_DEV_XIVE_NR_SERVERS (write only)
The kvm_device_attr.addr points to a __u32 value which is the number of
interrupt server numbers (ie, highest possible vcpu id plus one).</p>
<p>Errors:</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 86%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>-EINVAL</p></td>
<td><p>Value greater than KVM_MAX_VCPU_ID.</p></td>
</tr>
<tr class="row-even"><td><p>-EFAULT</p></td>
<td><p>Invalid user pointer for attr-&gt;addr.</p></td>
</tr>
<tr class="row-odd"><td><p>-EBUSY</p></td>
<td><p>A vCPU is already connected to the device.</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</dd>
</dl>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><dl class="simple">
<dt>KVM_DEV_XIVE_GRP_SOURCE (write only)</dt><dd><p>Initializes a new source in the XIVE device and mask it.</p>
</dd>
</dl>
</li>
</ol>
<blockquote>
<div><dl class="simple">
<dt>Attributes:</dt><dd><p>Interrupt source number  (64-bit)</p>
</dd>
</dl>
<p>The kvm_device_attr.addr points to a __u64 value:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>bits:     | 63   ....  2 |   1   |   0
values:   |    unused    | level | type
</pre></div>
</div>
<ul class="simple">
<li><p>type:  0:MSI 1:LSI</p></li>
<li><p>level: assertion level in case of an LSI.</p></li>
</ul>
<p>Errors:</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 86%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>-E2BIG</p></td>
<td><p>Interrupt source number is out of range</p></td>
</tr>
<tr class="row-even"><td><p>-ENOMEM</p></td>
<td><p>Could not create a new source block</p></td>
</tr>
<tr class="row-odd"><td><p>-EFAULT</p></td>
<td><p>Invalid user pointer for attr-&gt;addr.</p></td>
</tr>
<tr class="row-even"><td><p>-ENXIO</p></td>
<td><p>Could not allocate underlying HW interrupt</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</div></blockquote>
<ol class="arabic simple" start="3">
<li><dl class="simple">
<dt>KVM_DEV_XIVE_GRP_SOURCE_CONFIG (write only)</dt><dd><p>Configures source targeting</p>
</dd>
</dl>
</li>
</ol>
<blockquote>
<div><dl class="simple">
<dt>Attributes:</dt><dd><p>Interrupt source number  (64-bit)</p>
</dd>
</dl>
<p>The kvm_device_attr.addr points to a __u64 value:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>bits:     | 63   ....  33 |  32  | 31 .. 3 |  2 .. 0
values:   |    eisn       | mask |  server | priority
</pre></div>
</div>
<ul class="simple">
<li><p>priority: 0-7 interrupt priority level</p></li>
<li><p>server: CPU number chosen to handle the interrupt</p></li>
<li><p>mask: mask flag (unused)</p></li>
<li><p>eisn: Effective Interrupt Source Number</p></li>
</ul>
<p>Errors:</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 11%" />
<col style="width: 89%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>-ENOENT</p></td>
<td><p>Unknown source number</p></td>
</tr>
<tr class="row-even"><td><p>-EINVAL</p></td>
<td><p>Not initialized source number</p></td>
</tr>
<tr class="row-odd"><td><p>-EINVAL</p></td>
<td><p>Invalid priority</p></td>
</tr>
<tr class="row-even"><td><p>-EINVAL</p></td>
<td><p>Invalid CPU number.</p></td>
</tr>
<tr class="row-odd"><td><p>-EFAULT</p></td>
<td><p>Invalid user pointer for attr-&gt;addr.</p></td>
</tr>
<tr class="row-even"><td><p>-ENXIO</p></td>
<td><p>CPU event queues not configured or configuration of the
underlying HW interrupt failed</p></td>
</tr>
<tr class="row-odd"><td><p>-EBUSY</p></td>
<td><p>No CPU available to serve interrupt</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</div></blockquote>
<ol class="arabic simple" start="4">
<li><dl class="simple">
<dt>KVM_DEV_XIVE_GRP_EQ_CONFIG (read-write)</dt><dd><p>Configures an event queue of a CPU</p>
</dd>
</dl>
</li>
</ol>
<blockquote>
<div><dl class="simple">
<dt>Attributes:</dt><dd><p>EQ descriptor identifier (64-bit)</p>
</dd>
</dl>
<p>The EQ descriptor identifier is a tuple (server, priority):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>bits:     | 63   ....  32 | 31 .. 3 |  2 .. 0
values:   |    unused     |  server | priority
</pre></div>
</div>
<p>The kvm_device_attr.addr points to:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct kvm_ppc_xive_eq {
    __u32 flags;
    __u32 qshift;
    __u64 qaddr;
    __u32 qtoggle;
    __u32 qindex;
    __u8  pad[40];
};
</pre></div>
</div>
<ul class="simple">
<li><dl class="simple">
<dt>flags: queue flags</dt><dd><dl class="simple">
<dt>KVM_XIVE_EQ_ALWAYS_NOTIFY (required)</dt><dd><p>forces notification without using the coalescing mechanism
provided by the XIVE END ESBs.</p>
</dd>
</dl>
</dd>
</dl>
</li>
<li><p>qshift: queue size (power of 2)</p></li>
<li><p>qaddr: real address of queue</p></li>
<li><p>qtoggle: current queue toggle bit</p></li>
<li><p>qindex: current queue index</p></li>
<li><p>pad: reserved for future use</p></li>
</ul>
<p>Errors:</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 15%" />
<col style="width: 85%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>-ENOENT</p></td>
<td><p>Invalid CPU number</p></td>
</tr>
<tr class="row-even"><td><p>-EINVAL</p></td>
<td><p>Invalid priority</p></td>
</tr>
<tr class="row-odd"><td><p>-EINVAL</p></td>
<td><p>Invalid flags</p></td>
</tr>
<tr class="row-even"><td><p>-EINVAL</p></td>
<td><p>Invalid queue size</p></td>
</tr>
<tr class="row-odd"><td><p>-EINVAL</p></td>
<td><p>Invalid queue address</p></td>
</tr>
<tr class="row-even"><td><p>-EFAULT</p></td>
<td><p>Invalid user pointer for attr-&gt;addr.</p></td>
</tr>
<tr class="row-odd"><td><p>-EIO</p></td>
<td><p>Configuration of the underlying HW failed</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</div></blockquote>
<ol class="arabic simple" start="5">
<li><dl class="simple">
<dt>KVM_DEV_XIVE_GRP_SOURCE_SYNC (write only)</dt><dd><p>Synchronize the source to flush event notifications</p>
</dd>
</dl>
</li>
</ol>
<blockquote>
<div><dl class="simple">
<dt>Attributes:</dt><dd><p>Interrupt source number  (64-bit)</p>
</dd>
</dl>
<p>Errors:</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 19%" />
<col style="width: 81%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>-ENOENT</p></td>
<td><p>Unknown source number</p></td>
</tr>
<tr class="row-even"><td><p>-EINVAL</p></td>
<td><p>Not initialized source number</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</div></blockquote>
<ul>
<li><p>VCPU state</p>
<p>The XIVE IC maintains VP interrupt state in an internal structure
called the NVT. When a VP is not dispatched on a HW processor
thread, this structure can be updated by HW if the VP is the target
of an event notification.</p>
<p>It is important for migration to capture the cached IPB from the NVT
as it synthesizes the priorities of the pending interrupts. We
capture a bit more to report debug information.</p>
<p>KVM_REG_PPC_VP_STATE (2 * 64bits):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>bits:     |  63  ....  32  |  31  ....  0  |
values:   |   TIMA word0   |   TIMA word1  |
bits:     | 127       ..........       64  |
values:   |            unused              |
</pre></div>
</div>
</li>
<li><p>Migration:</p>
<p>Saving the state of a VM using the XIVE native exploitation mode
should follow a specific sequence. When the VM is stopped :</p>
<ol class="arabic simple">
<li><p>Mask all sources (PQ=01) to stop the flow of events.</p></li>
</ol>
<p>2. Sync the XIVE device with the KVM control KVM_DEV_XIVE_EQ_SYNC to
flush any in-flight event notification and to stabilize the EQs. At
this stage, the EQ pages are marked dirty to make sure they are
transferred in the migration sequence.</p>
<p>3. Capture the state of the source targeting, the EQs configuration
and the state of thread interrupt context registers.</p>
<p>Restore is similar:</p>
<ol class="arabic simple">
<li><p>Restore the EQ configuration. As targeting depends on it.</p></li>
<li><p>Restore targeting</p></li>
<li><p>Restore the thread interrupt contexts</p></li>
<li><p>Restore the source states</p></li>
<li><p>Let the vCPU run</p></li>
</ol>
</li>
</ul>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../running-nested-guests.html" class="btn btn-neutral float-right" title="Running nested guests with KVM" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="xics.html" class="btn btn-neutral float-left" title="XICS interrupt controller" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright The kernel development community.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>