

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>12. Intel(R) Memory Protection Extensions (MPX) &mdash; The Linux Kernel 5.2.0+ documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="13. Linux IOMMU Support" href="intel-iommu.html" />
    <link rel="prev" title="11. PAT (Page Attribute Table)" href="pat.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.4.0-rc3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ioctl/index.html">IOCTLs</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../media/index.html">Linux Media Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mic/index.html">Intel Many Integrated Core (MIC) architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler/index.html">Linux Scheduler</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nios2/nios2.html">Linux on the Nios II architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">x86-specific Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="boot.html">1. The Linux/x86 Boot Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="topology.html">2. x86 Topology</a></li>
<li class="toctree-l2"><a class="reference internal" href="exception-tables.html">3. Kernel level exception handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="kernel-stacks.html">4. Kernel Stacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="entry_64.html">5. Kernel Entries</a></li>
<li class="toctree-l2"><a class="reference internal" href="earlyprintk.html">6. Early Printk</a></li>
<li class="toctree-l2"><a class="reference internal" href="orc-unwinder.html">7. ORC unwinder</a></li>
<li class="toctree-l2"><a class="reference internal" href="zero-page.html">8. Zero Page</a></li>
<li class="toctree-l2"><a class="reference internal" href="tlb.html">9. The TLB</a></li>
<li class="toctree-l2"><a class="reference internal" href="mtrr.html">10. MTRR (Memory Type Range Register) control</a></li>
<li class="toctree-l2"><a class="reference internal" href="pat.html">11. PAT (Page Attribute Table)</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">12. Intel(R) Memory Protection Extensions (MPX)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#intel-r-mpx-overview">12.1. Intel(R) MPX Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-to-get-the-advantage-of-mpx">12.2. How to get the advantage of MPX</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-does-mpx-kernel-code-work">12.3. How does MPX kernel code work</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#handling-br-faults-caused-by-mpx">12.3.1. Handling #BR faults caused by MPX</a></li>
<li class="toctree-l4"><a class="reference internal" href="#on-demand-kernel-allocation-of-bounds-tables">12.3.2. On-demand kernel allocation of bounds tables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#decoding-mpx-instructions">12.3.3. Decoding MPX instructions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cleanup-unused-bounds-tables">12.3.4. Cleanup unused bounds tables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-new-prctl-commands">12.3.5. Adding new prctl commands</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#special-rules">12.4. Special rules</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="intel-iommu.html">13. Linux IOMMU Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="intel_txt.html">14. Intel(R) TXT Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="amd-memory-encryption.html">15. AMD Memory Encryption</a></li>
<li class="toctree-l2"><a class="reference internal" href="pti.html">16. Page Table Isolation (PTI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="mds.html">17. Microarchitectural Data Sampling (MDS) mitigation</a></li>
<li class="toctree-l2"><a class="reference internal" href="microcode.html">18. The Linux Microcode Loader</a></li>
<li class="toctree-l2"><a class="reference internal" href="resctrl_ui.html">19. User Interface for Resource Control feature</a></li>
<li class="toctree-l2"><a class="reference internal" href="usb-legacy-support.html">20. USB Legacy support</a></li>
<li class="toctree-l2"><a class="reference internal" href="i386/index.html">21. i386 Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="x86_64/index.html">22. x86_64 Support</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/ext4/index.html">ext4 Data Structures and Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">x86-specific Documentation</a> &raquo;</li>
        
      <li>12. Intel(R) Memory Protection Extensions (MPX)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/x86/intel_mpx.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="intel-r-memory-protection-extensions-mpx">
<h1>12. Intel(R) Memory Protection Extensions (MPX)<a class="headerlink" href="#intel-r-memory-protection-extensions-mpx" title="Permalink to this headline">¶</a></h1>
<div class="section" id="intel-r-mpx-overview">
<h2>12.1. Intel(R) MPX Overview<a class="headerlink" href="#intel-r-mpx-overview" title="Permalink to this headline">¶</a></h2>
<p>Intel(R) Memory Protection Extensions (Intel(R) MPX) is a new capability
introduced into Intel Architecture. Intel MPX provides hardware features
that can be used in conjunction with compiler changes to check memory
references, for those references whose compile-time normal intentions are
usurped at runtime due to buffer overflow or underflow.</p>
<p>You can tell if your CPU supports MPX by looking in /proc/cpuinfo:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cat /proc/cpuinfo  | grep &#39; mpx &#39;
</pre></div>
</div>
<p>For more information, please refer to Intel(R) Architecture Instruction
Set Extensions Programming Reference, Chapter 9: Intel(R) Memory Protection
Extensions.</p>
<p>Note: As of December 2014, no hardware with MPX is available but it is
possible to use SDE (Intel(R) Software Development Emulator) instead, which
can be downloaded from
<a class="reference external" href="http://software.intel.com/en-us/articles/intel-software-development-emulator">http://software.intel.com/en-us/articles/intel-software-development-emulator</a></p>
</div>
<div class="section" id="how-to-get-the-advantage-of-mpx">
<h2>12.2. How to get the advantage of MPX<a class="headerlink" href="#how-to-get-the-advantage-of-mpx" title="Permalink to this headline">¶</a></h2>
<p>For MPX to work, changes are required in the kernel, binutils and compiler.
No source changes are required for applications, just a recompile.</p>
<p>There are a lot of moving parts of this to all work right. The following
is how we expect the compiler, application and kernel to work together.</p>
<ol class="arabic simple">
<li>Application developer compiles with -fmpx. The compiler will add the
instrumentation as well as some setup code called early after the app
starts. New instruction prefixes are noops for old CPUs.</li>
<li>That setup code allocates (virtual) space for the “bounds directory”,
points the “bndcfgu” register to the directory (must also set the valid
bit) and notifies the kernel (via the new prctl(PR_MPX_ENABLE_MANAGEMENT))
that the app will be using MPX.  The app must be careful not to access
the bounds tables between the time when it populates “bndcfgu” and
when it calls the prctl().  This might be hard to guarantee if the app
is compiled with MPX.  You can add “__attribute__((bnd_legacy))” to
the function to disable MPX instrumentation to help guarantee this.
Also be careful not to call out to any other code which might be
MPX-instrumented.</li>
<li>The kernel detects that the CPU has MPX, allows the new prctl() to
succeed, and notes the location of the bounds directory. Userspace is
expected to keep the bounds directory at that location. We note it
instead of reading it each time because the ‘xsave’ operation needed
to access the bounds directory register is an expensive operation.</li>
<li>If the application needs to spill bounds out of the 4 registers, it
issues a bndstx instruction. Since the bounds directory is empty at
this point, a bounds fault (#BR) is raised, the kernel allocates a
bounds table (in the user address space) and makes the relevant entry
in the bounds directory point to the new table.</li>
<li>If the application violates the bounds specified in the bounds registers,
a separate kind of #BR is raised which will deliver a signal with
information about the violation in the ‘struct siginfo’.</li>
<li>Whenever memory is freed, we know that it can no longer contain valid
pointers, and we attempt to free the associated space in the bounds
tables. If an entire table becomes unused, we will attempt to free
the table and remove the entry in the directory.</li>
</ol>
<p>To summarize, there are essentially three things interacting here:</p>
<dl class="docutils">
<dt>GCC with -fmpx:</dt>
<dd><ul class="first last simple">
<li>enables annotation of code with MPX instructions and prefixes</li>
<li>inserts code early in the application to call in to the “gcc runtime”</li>
</ul>
</dd>
<dt>GCC MPX Runtime:</dt>
<dd><ul class="first last simple">
<li>Checks for hardware MPX support in cpuid leaf</li>
<li>allocates virtual space for the bounds directory (malloc() essentially)</li>
<li>points the hardware BNDCFGU register at the directory</li>
<li>calls a new prctl(PR_MPX_ENABLE_MANAGEMENT) to notify the kernel to
start managing the bounds directories</li>
</ul>
</dd>
<dt>Kernel MPX Code:</dt>
<dd><ul class="first last simple">
<li>Checks for hardware MPX support in cpuid leaf</li>
<li>Handles #BR exceptions and sends SIGSEGV to the app when it violates
bounds, like during a buffer overflow.</li>
<li>When bounds are spilled in to an unallocated bounds table, the kernel
notices in the #BR exception, allocates the virtual space, then
updates the bounds directory to point to the new table. It keeps
special track of the memory with a VM_MPX flag.</li>
<li>Frees unused bounds tables at the time that the memory they described
is unmapped.</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="how-does-mpx-kernel-code-work">
<h2>12.3. How does MPX kernel code work<a class="headerlink" href="#how-does-mpx-kernel-code-work" title="Permalink to this headline">¶</a></h2>
<div class="section" id="handling-br-faults-caused-by-mpx">
<h3>12.3.1. Handling #BR faults caused by MPX<a class="headerlink" href="#handling-br-faults-caused-by-mpx" title="Permalink to this headline">¶</a></h3>
<p>When MPX is enabled, there are 2 new situations that can generate
#BR faults.</p>
<blockquote>
<div><ul class="simple">
<li>new bounds tables (BT) need to be allocated to save bounds.</li>
<li>bounds violation caused by MPX instructions.</li>
</ul>
</div></blockquote>
<p>We hook #BR handler to handle these two new situations.</p>
</div>
<div class="section" id="on-demand-kernel-allocation-of-bounds-tables">
<h3>12.3.2. On-demand kernel allocation of bounds tables<a class="headerlink" href="#on-demand-kernel-allocation-of-bounds-tables" title="Permalink to this headline">¶</a></h3>
<p>MPX only has 4 hardware registers for storing bounds information. If
MPX-enabled code needs more than these 4 registers, it needs to spill
them somewhere. It has two special instructions for this which allow
the bounds to be moved between the bounds registers and some new “bounds
tables”.</p>
<p>#BR exceptions are a new class of exceptions just for MPX. They are
similar conceptually to a page fault and will be raised by the MPX
hardware during both bounds violations or when the tables are not
present. The kernel handles those #BR exceptions for not-present tables
by carving the space out of the normal processes address space and then
pointing the bounds-directory over to it.</p>
<p>The tables need to be accessed and controlled by userspace because
the instructions for moving bounds in and out of them are extremely
frequent. They potentially happen every time a register points to
memory. Any direct kernel involvement (like a syscall) to access the
tables would obviously destroy performance.</p>
<p>Why not do this in userspace? MPX does not strictly require anything in
the kernel. It can theoretically be done completely from userspace. Here
are a few ways this could be done. We don’t think any of them are practical
in the real-world, but here they are.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Q:</th><td class="field-body">Can virtual space simply be reserved for the bounds tables so that we
never have to allocate them?</td>
</tr>
<tr class="field-even field"><th class="field-name">A:</th><td class="field-body">MPX-enabled application will possibly create a lot of bounds tables in
process address space to save bounds information. These tables can take
up huge swaths of memory (as much as 80% of the memory on the system)
even if we clean them up aggressively. In the worst-case scenario, the
tables can be 4x the size of the data structure being tracked. IOW, a
1-page structure can require 4 bounds-table pages. An X-GB virtual
area needs 4*X GB of virtual space, plus 2GB for the bounds directory.
If we were to preallocate them for the 128TB of user virtual address
space, we would need to reserve 512TB+2GB, which is larger than the
entire virtual address space today. This means they can not be reserved
ahead of time. Also, a single process’s pre-populated bounds directory
consumes 2GB of virtual <em>AND</em> physical memory. IOW, it’s completely
infeasible to prepopulate bounds directories.</td>
</tr>
<tr class="field-odd field"><th class="field-name">Q:</th><td class="field-body">Can we preallocate bounds table space at the same time memory is
allocated which might contain pointers that might eventually need
bounds tables?</td>
</tr>
<tr class="field-even field"><th class="field-name">A:</th><td class="field-body">This would work if we could hook the site of each and every memory
allocation syscall. This can be done for small, constrained applications.
But, it isn’t practical at a larger scale since a given app has no
way of controlling how all the parts of the app might allocate memory
(think libraries). The kernel is really the only place to intercept
these calls.</td>
</tr>
<tr class="field-odd field"><th class="field-name">Q:</th><td class="field-body">Could a bounds fault be handed to userspace and the tables allocated
there in a signal handler instead of in the kernel?</td>
</tr>
<tr class="field-even field"><th class="field-name">A:</th><td class="field-body">mmap() is not on the list of safe async handler functions and even
if mmap() would work it still requires locking or nasty tricks to
keep track of the allocation state there.</td>
</tr>
</tbody>
</table>
<p>Having ruled out all of the userspace-only approaches for managing
bounds tables that we could think of, we create them on demand in
the kernel.</p>
</div>
<div class="section" id="decoding-mpx-instructions">
<h3>12.3.3. Decoding MPX instructions<a class="headerlink" href="#decoding-mpx-instructions" title="Permalink to this headline">¶</a></h3>
<p>If a #BR is generated due to a bounds violation caused by MPX.
We need to decode MPX instructions to get violation address and
set this address into extended struct siginfo.</p>
<p>The _sigfault field of struct siginfo is extended as follow:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>87            /* SIGILL, SIGFPE, SIGSEGV, SIGBUS */
88            struct {
89                    void __user *_addr; /* faulting insn/memory ref. */
90 #ifdef __ARCH_SI_TRAPNO
91                    int _trapno;    /* TRAP # which caused the signal */
92 #endif
93                    short _addr_lsb; /* LSB of the reported address */
94                    struct {
95                            void __user *_lower;
96                            void __user *_upper;
97                    } _addr_bnd;
98            } _sigfault;
</pre></div>
</div>
<p>The ‘_addr’ field refers to violation address, and new ‘_addr_and’
field refers to the upper/lower bounds when a #BR is caused.</p>
<p>Glibc will be also updated to support this new siginfo. So user
can get violation address and bounds when bounds violations occur.</p>
</div>
<div class="section" id="cleanup-unused-bounds-tables">
<h3>12.3.4. Cleanup unused bounds tables<a class="headerlink" href="#cleanup-unused-bounds-tables" title="Permalink to this headline">¶</a></h3>
<p>When a BNDSTX instruction attempts to save bounds to a bounds directory
entry marked as invalid, a #BR is generated. This is an indication that
no bounds table exists for this entry. In this case the fault handler
will allocate a new bounds table on demand.</p>
<p>Since the kernel allocated those tables on-demand without userspace
knowledge, it is also responsible for freeing them when the associated
mappings go away.</p>
<p>Here, the solution for this issue is to hook do_munmap() to check
whether one process is MPX enabled. If yes, those bounds tables covered
in the virtual address region which is being unmapped will be freed also.</p>
</div>
<div class="section" id="adding-new-prctl-commands">
<h3>12.3.5. Adding new prctl commands<a class="headerlink" href="#adding-new-prctl-commands" title="Permalink to this headline">¶</a></h3>
<p>Two new prctl commands are added to enable and disable MPX bounds tables
management in kernel.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>155   #define PR_MPX_ENABLE_MANAGEMENT        43
156   #define PR_MPX_DISABLE_MANAGEMENT       44
</pre></div>
</div>
<p>Runtime library in userspace is responsible for allocation of bounds
directory. So kernel have to use XSAVE instruction to get the base
of bounds directory from BNDCFG register.</p>
<p>But XSAVE is expected to be very expensive. In order to do performance
optimization, we have to get the base of bounds directory and save it
into struct mm_struct to be used in future during PR_MPX_ENABLE_MANAGEMENT
command execution.</p>
</div>
</div>
<div class="section" id="special-rules">
<h2>12.4. Special rules<a class="headerlink" href="#special-rules" title="Permalink to this headline">¶</a></h2>
<p>1) If userspace is requesting help from the kernel to do the management
of bounds tables, it may not create or modify entries in the bounds directory.</p>
<p>Certainly users can allocate bounds tables and forcibly point the bounds
directory at them through XSAVE instruction, and then set valid bit
of bounds entry to have this entry valid.  But, the kernel will decline
to assist in managing these tables.</p>
<p>2) Userspace may not take multiple bounds directory entries and point
them at the same bounds table.</p>
<p>This is allowed architecturally.  See more information “Intel(R) Architecture
Instruction Set Extensions Programming Reference” (9.3.4).</p>
<p>However, if users did this, the kernel might be fooled in to unmapping an
in-use bounds table since it does not recognize sharing.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="intel-iommu.html" class="btn btn-neutral float-right" title="13. Linux IOMMU Support" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="pat.html" class="btn btn-neutral float-left" title="11. PAT (Page Attribute Table)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>