

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>TODO list &mdash; The Linux Kernel 5.2.0-rc5+ documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Security Documentation" href="../security/index.html" />
    <link rel="prev" title="VGA Arbiter" href="vgaarbiter.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.2.0-rc5
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../media/index.html">Linux Media Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Linux GPU Driver Developer’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="drm-internals.html">DRM Internals</a></li>
<li class="toctree-l2"><a class="reference internal" href="drm-mm.html">DRM Memory Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="drm-kms.html">Kernel Mode Setting (KMS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="drm-kms-helpers.html">Mode Setting Helper Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="drm-uapi.html">Userland interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="drm-client.html">Kernel clients</a></li>
<li class="toctree-l2"><a class="reference internal" href="drivers.html">GPU Driver Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="vga-switcheroo.html">VGA Switcheroo</a></li>
<li class="toctree-l2"><a class="reference internal" href="vgaarbiter.html">VGA Arbiter</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">TODO list</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#subsystem-wide-refactorings">Subsystem-wide refactorings</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#de-midlayer-drivers">De-midlayer drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#remove-custom-dumb-map-offset-implementations">Remove custom dumb_map_offset implementations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#convert-existing-kms-drivers-to-atomic-modesetting">Convert existing KMS drivers to atomic modesetting</a></li>
<li class="toctree-l4"><a class="reference internal" href="#clean-up-the-clipped-coordination-confusion-around-planes">Clean up the clipped coordination confusion around planes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#convert-early-atomic-drivers-to-async-commit-helpers">Convert early atomic drivers to async commit helpers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fallout-from-atomic-kms">Fallout from atomic KMS</a></li>
<li class="toctree-l4"><a class="reference internal" href="#get-rid-of-dev-struct-mutex-from-gem-drivers">Get rid of dev-&gt;struct_mutex from GEM drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#convert-instances-of-dev-info-dev-err-dev-warn-to-their-drm-dev-equivalent">Convert instances of dev_info/dev_err/dev_warn to their DRM_DEV_* equivalent</a></li>
<li class="toctree-l4"><a class="reference internal" href="#convert-drivers-to-use-simple-modeset-suspend-resume">Convert drivers to use simple modeset suspend/resume</a></li>
<li class="toctree-l4"><a class="reference internal" href="#convert-drivers-to-use-drm-fb-helper-fbdev-setup-teardown">Convert drivers to use drm_fb_helper_fbdev_setup/teardown()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#clean-up-mmap-forwarding">Clean up mmap forwarding</a></li>
<li class="toctree-l4"><a class="reference internal" href="#generic-fbdev-defio-support">Generic fbdev defio support</a></li>
<li class="toctree-l4"><a class="reference internal" href="#remove-the-gem-prime-res-obj-callback">Remove the -&gt;gem_prime_res_obj callback</a></li>
<li class="toctree-l4"><a class="reference internal" href="#idr-init-base">idr_init_base()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#defaults-for-gem-prime-import-and-export">Defaults for .gem_prime_import and export</a></li>
<li class="toctree-l4"><a class="reference internal" href="#struct-drm-gem-object-funcs">struct drm_gem_object_funcs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#use-drm-modeset-lock-all-helpers-instead-of-boilerplate">Use DRM_MODESET_LOCK_ALL_* helpers instead of boilerplate</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rename-cma-helpers-to-dma-helpers">Rename CMA helpers to DMA helpers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#convert-direct-mode-vrefresh-accesses-to-use-drm-mode-vrefresh">Convert direct mode.vrefresh accesses to use drm_mode_vrefresh()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#remove-drm-display-mode-hsync">Remove drm_display_mode.hsync</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#core-refactorings">Core refactorings</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#clean-up-the-drm-header-mess">Clean up the DRM header mess</a></li>
<li class="toctree-l4"><a class="reference internal" href="#add-missing-kerneldoc-for-exported-functions">Add missing kerneldoc for exported functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#make-panic-handling-work">Make panic handling work</a></li>
<li class="toctree-l4"><a class="reference internal" href="#clean-up-the-debugfs-support">Clean up the debugfs support</a></li>
<li class="toctree-l4"><a class="reference internal" href="#kms-cleanups">KMS cleanups</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#better-testing">Better Testing</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#enable-trinity-for-drm">Enable trinity for DRM</a></li>
<li class="toctree-l4"><a class="reference internal" href="#make-kms-tests-in-i-g-t-generic">Make KMS tests in i-g-t generic</a></li>
<li class="toctree-l4"><a class="reference internal" href="#extend-virtual-test-driver-vkms">Extend virtual test driver (VKMS)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#driver-specific">Driver Specific</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#tinydrm">tinydrm</a></li>
<li class="toctree-l4"><a class="reference internal" href="#amd-dc-display-driver">AMD DC Display Driver</a></li>
<li class="toctree-l4"><a class="reference internal" href="#i915">i915</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#outside-drm">Outside DRM</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../x86/index.html">x86-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../x86/index.html">x86-specific Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/ext4/index.html">ext4 Data Structures and Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Linux GPU Driver Developer’s Guide</a> &raquo;</li>
        
      <li>TODO list</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/gpu/todo.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="todo-list">
<span id="todo"></span><h1>TODO list<a class="headerlink" href="#todo-list" title="Permalink to this headline">¶</a></h1>
<p>This section contains a list of smaller janitorial tasks in the kernel DRM
graphics subsystem useful as newbie projects. Or for slow rainy days.</p>
<div class="section" id="subsystem-wide-refactorings">
<h2>Subsystem-wide refactorings<a class="headerlink" href="#subsystem-wide-refactorings" title="Permalink to this headline">¶</a></h2>
<div class="section" id="de-midlayer-drivers">
<h3>De-midlayer drivers<a class="headerlink" href="#de-midlayer-drivers" title="Permalink to this headline">¶</a></h3>
<p>With the recent <code class="docutils literal notranslate"><span class="pre">drm_bus</span></code> cleanup patches for 3.17 it is no longer required
to have a <code class="docutils literal notranslate"><span class="pre">drm_bus</span></code> structure set up. Drivers can directly set up the
<code class="docutils literal notranslate"><span class="pre">drm_device</span></code> structure instead of relying on bus methods in <code class="docutils literal notranslate"><span class="pre">drm_usb.c</span></code>
and <code class="docutils literal notranslate"><span class="pre">drm_pci.c</span></code>. The goal is to get rid of the driver’s <code class="docutils literal notranslate"><span class="pre">-&gt;load</span></code> /
<code class="docutils literal notranslate"><span class="pre">-&gt;unload</span></code> callbacks and open-code the load/unload sequence properly, using
the new two-stage <code class="docutils literal notranslate"><span class="pre">drm_device</span></code> setup/teardown.</p>
<p>Once all existing drivers are converted we can also remove those bus support
files for USB and platform devices.</p>
<p>All you need is a GPU for a non-converted driver (currently almost all of
them, but also all the virtual ones used by KVM, so everyone qualifies).</p>
<p>Contact: Daniel Vetter, Thierry Reding, respective driver maintainers</p>
</div>
<div class="section" id="remove-custom-dumb-map-offset-implementations">
<h3>Remove custom dumb_map_offset implementations<a class="headerlink" href="#remove-custom-dumb-map-offset-implementations" title="Permalink to this headline">¶</a></h3>
<p>All GEM based drivers should be using drm_gem_create_mmap_offset() instead.
Audit each individual driver, make sure it’ll work with the generic
implementation (there’s lots of outdated locking leftovers in various
implementations), and then remove it.</p>
<p>Contact: Daniel Vetter, respective driver maintainers</p>
</div>
<div class="section" id="convert-existing-kms-drivers-to-atomic-modesetting">
<h3>Convert existing KMS drivers to atomic modesetting<a class="headerlink" href="#convert-existing-kms-drivers-to-atomic-modesetting" title="Permalink to this headline">¶</a></h3>
<p>3.19 has the atomic modeset interfaces and helpers, so drivers can now be
converted over. Modern compositors like Wayland or Surfaceflinger on Android
really want an atomic modeset interface, so this is all about the bright
future.</p>
<p>There is a conversion guide for atomic and all you need is a GPU for a
non-converted driver (again virtual HW drivers for KVM are still all
suitable).</p>
<p>As part of this drivers also need to convert to universal plane (which means
exposing primary &amp; cursor as proper plane objects). But that’s much easier to
do by directly using the new atomic helper driver callbacks.</p>
<p>Contact: Daniel Vetter, respective driver maintainers</p>
</div>
<div class="section" id="clean-up-the-clipped-coordination-confusion-around-planes">
<h3>Clean up the clipped coordination confusion around planes<a class="headerlink" href="#clean-up-the-clipped-coordination-confusion-around-planes" title="Permalink to this headline">¶</a></h3>
<p>We have a helper to get this right with drm_plane_helper_check_update(), but
it’s not consistently used. This should be fixed, preferrably in the atomic
helpers (and drivers then moved over to clipped coordinates). Probably the
helper should also be moved from drm_plane_helper.c to the atomic helpers, to
avoid confusion - the other helpers in that file are all deprecated legacy
helpers.</p>
<p>Contact: Ville Syrjälä, Daniel Vetter, driver maintainers</p>
</div>
<div class="section" id="convert-early-atomic-drivers-to-async-commit-helpers">
<h3>Convert early atomic drivers to async commit helpers<a class="headerlink" href="#convert-early-atomic-drivers-to-async-commit-helpers" title="Permalink to this headline">¶</a></h3>
<p>For the first year the atomic modeset helpers didn’t support asynchronous /
nonblocking commits, and every driver had to hand-roll them. This is fixed
now, but there’s still a pile of existing drivers that easily could be
converted over to the new infrastructure.</p>
<p>One issue with the helpers is that they require that drivers handle completion
events for atomic commits correctly. But fixing these bugs is good anyway.</p>
<p>Contact: Daniel Vetter, respective driver maintainers</p>
</div>
<div class="section" id="fallout-from-atomic-kms">
<h3>Fallout from atomic KMS<a class="headerlink" href="#fallout-from-atomic-kms" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">drm_atomic_helper.c</span></code> provides a batch of functions which implement legacy
IOCTLs on top of the new atomic driver interface. Which is really nice for
gradual conversion of drivers, but unfortunately the semantic mismatches are
a bit too severe. So there’s some follow-up work to adjust the function
interfaces to fix these issues:</p>
<ul>
<li><p class="first">atomic needs the lock acquire context. At the moment that’s passed around
implicitly with some horrible hacks, and it’s also allocate with
<code class="docutils literal notranslate"><span class="pre">GFP_NOFAIL</span></code> behind the scenes. All legacy paths need to start allocating
the acquire context explicitly on stack and then also pass it down into
drivers explicitly so that the legacy-on-atomic functions can use them.</p>
<p>Except for some driver code this is done. This task should be finished by
adding WARN_ON(!drm_drv_uses_atomic_modeset) in drm_modeset_lock_all().</p>
</li>
<li><p class="first">A bunch of the vtable hooks are now in the wrong place: DRM has a split
between core vfunc tables (named <code class="docutils literal notranslate"><span class="pre">drm_foo_funcs</span></code>), which are used to
implement the userspace ABI. And then there’s the optional hooks for the
helper libraries (name <code class="docutils literal notranslate"><span class="pre">drm_foo_helper_funcs</span></code>), which are purely for
internal use. Some of these hooks should be move from <code class="docutils literal notranslate"><span class="pre">_funcs</span></code> to
<code class="docutils literal notranslate"><span class="pre">_helper_funcs</span></code> since they are not part of the core ABI. There’s a
<code class="docutils literal notranslate"><span class="pre">FIXME</span></code> comment in the kerneldoc for each such case in <code class="docutils literal notranslate"><span class="pre">drm_crtc.h</span></code>.</p>
</li>
</ul>
<p>Contact: Daniel Vetter</p>
</div>
<div class="section" id="get-rid-of-dev-struct-mutex-from-gem-drivers">
<h3>Get rid of dev-&gt;struct_mutex from GEM drivers<a class="headerlink" href="#get-rid-of-dev-struct-mutex-from-gem-drivers" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">dev-&gt;struct_mutex</span></code> is the Big DRM Lock from legacy days and infested
everything. Nowadays in modern drivers the only bit where it’s mandatory is
serializing GEM buffer object destruction. Which unfortunately means drivers
have to keep track of that lock and either call <code class="docutils literal notranslate"><span class="pre">unreference</span></code> or
<code class="docutils literal notranslate"><span class="pre">unreference_locked</span></code> depending upon context.</p>
<p>Core GEM doesn’t have a need for <code class="docutils literal notranslate"><span class="pre">struct_mutex</span></code> any more since kernel 4.8,
and there’s a <code class="docutils literal notranslate"><span class="pre">gem_free_object_unlocked</span></code> callback for any drivers which are
entirely <code class="docutils literal notranslate"><span class="pre">struct_mutex</span></code> free.</p>
<p>For drivers that need <code class="docutils literal notranslate"><span class="pre">struct_mutex</span></code> it should be replaced with a driver-
private lock. The tricky part is the BO free functions, since those can’t
reliably take that lock any more. Instead state needs to be protected with
suitable subordinate locks or some cleanup work pushed to a worker thread. For
performance-critical drivers it might also be better to go with a more
fine-grained per-buffer object and per-context lockings scheme. Currently only the
<code class="docutils literal notranslate"><span class="pre">msm</span></code> driver still use <code class="docutils literal notranslate"><span class="pre">struct_mutex</span></code>.</p>
<p>Contact: Daniel Vetter, respective driver maintainers</p>
</div>
<div class="section" id="convert-instances-of-dev-info-dev-err-dev-warn-to-their-drm-dev-equivalent">
<h3>Convert instances of dev_info/dev_err/dev_warn to their DRM_DEV_* equivalent<a class="headerlink" href="#convert-instances-of-dev-info-dev-err-dev-warn-to-their-drm-dev-equivalent" title="Permalink to this headline">¶</a></h3>
<p>For drivers which could have multiple instances, it is necessary to
differentiate between which is which in the logs. Since DRM_INFO/WARN/ERROR
don’t do this, drivers used dev_info/warn/err to make this differentiation. We
now have DRM_DEV_* variants of the drm print macros, so we can start to convert
those drivers back to using drm-formwatted specific log messages.</p>
<p>Before you start this conversion please contact the relevant maintainers to make
sure your work will be merged - not everyone agrees that the DRM dmesg macros
are better.</p>
<p>Contact: Sean Paul, Maintainer of the driver you plan to convert</p>
</div>
<div class="section" id="convert-drivers-to-use-simple-modeset-suspend-resume">
<h3>Convert drivers to use simple modeset suspend/resume<a class="headerlink" href="#convert-drivers-to-use-simple-modeset-suspend-resume" title="Permalink to this headline">¶</a></h3>
<p>Most drivers (except i915 and nouveau) that use
drm_atomic_helper_suspend/resume() can probably be converted to use
drm_mode_config_helper_suspend/resume(). Also there’s still open-coded version
of the atomic suspend/resume code in older atomic modeset drivers.</p>
<p>Contact: Maintainer of the driver you plan to convert</p>
</div>
<div class="section" id="convert-drivers-to-use-drm-fb-helper-fbdev-setup-teardown">
<h3>Convert drivers to use drm_fb_helper_fbdev_setup/teardown()<a class="headerlink" href="#convert-drivers-to-use-drm-fb-helper-fbdev-setup-teardown" title="Permalink to this headline">¶</a></h3>
<p>Most drivers can use drm_fb_helper_fbdev_setup() except maybe:</p>
<ul class="simple">
<li>amdgpu which has special logic to decide whether to call
drm_helper_disable_unused_functions()</li>
<li>armada which isn’t atomic and doesn’t call
drm_helper_disable_unused_functions()</li>
<li>i915 which calls drm_fb_helper_initial_config() in a worker</li>
</ul>
<p>Drivers that use drm_framebuffer_remove() to clean up the fbdev framebuffer can
probably use drm_fb_helper_fbdev_teardown().</p>
<p>Contact: Maintainer of the driver you plan to convert</p>
</div>
<div class="section" id="clean-up-mmap-forwarding">
<h3>Clean up mmap forwarding<a class="headerlink" href="#clean-up-mmap-forwarding" title="Permalink to this headline">¶</a></h3>
<p>A lot of drivers forward gem mmap calls to dma-buf mmap for imported buffers.
And also a lot of them forward dma-buf mmap to the gem mmap implementations.
Would be great to refactor this all into a set of small common helpers.</p>
<p>Contact: Daniel Vetter</p>
</div>
<div class="section" id="generic-fbdev-defio-support">
<h3>Generic fbdev defio support<a class="headerlink" href="#generic-fbdev-defio-support" title="Permalink to this headline">¶</a></h3>
<p>The defio support code in the fbdev core has some very specific requirements,
which means drivers need to have a special framebuffer for fbdev. Which prevents
us from using the generic fbdev emulation code everywhere. The main issue is
that it uses some fields in struct page itself, which breaks shmem gem objects
(and other things).</p>
<p>Possible solution would be to write our own defio mmap code in the drm fbdev
emulation. It would need to fully wrap the existing mmap ops, forwarding
everything after it has done the write-protect/mkwrite trickery:</p>
<ul>
<li><p class="first">In the drm_fbdev_fb_mmap helper, if we need defio, change the
default page prots to write-protected with something like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>vma-&gt;vm_page_prot = pgprot_wrprotect(vma-&gt;vm_page_prot);
</pre></div>
</div>
</li>
<li><p class="first">Set the mkwrite and fsync callbacks with similar implementions to the core
fbdev defio stuff. These should all work on plain ptes, they don’t actually
require a struct page.  uff. These should all work on plain ptes, they don’t
actually require a struct page.</p>
</li>
<li><p class="first">Track the dirty pages in a separate structure (bitfield with one bit per page
should work) to avoid clobbering struct page.</p>
</li>
</ul>
<p>Might be good to also have some igt testcases for this.</p>
<p>Contact: Daniel Vetter, Noralf Tronnes</p>
</div>
<div class="section" id="remove-the-gem-prime-res-obj-callback">
<h3>Remove the -&gt;gem_prime_res_obj callback<a class="headerlink" href="#remove-the-gem-prime-res-obj-callback" title="Permalink to this headline">¶</a></h3>
<p>The -&gt;gem_prime_res_obj callback can be removed from drivers by using the
reservation_object in the drm_gem_object. It may also be possible to use the
generic drm_gem_reservation_object_wait helper for waiting for a bo.</p>
<p>Contact: Daniel Vetter</p>
</div>
<div class="section" id="idr-init-base">
<h3>idr_init_base()<a class="headerlink" href="#idr-init-base" title="Permalink to this headline">¶</a></h3>
<p>DRM core&amp;drivers uses a lot of idr (integer lookup directories) for mapping
userspace IDs to internal objects, and in most places ID=0 means NULL and hence
is never used. Switching to idr_init_base() for these would make the idr more
efficient.</p>
<p>Contact: Daniel Vetter</p>
</div>
<div class="section" id="defaults-for-gem-prime-import-and-export">
<h3>Defaults for .gem_prime_import and export<a class="headerlink" href="#defaults-for-gem-prime-import-and-export" title="Permalink to this headline">¶</a></h3>
<p>Most drivers don’t need to set drm_driver-&gt;gem_prime_import and
-&gt;gem_prime_export now that drm_gem_prime_import() and drm_gem_prime_export()
are the default.</p>
</div>
<div class="section" id="struct-drm-gem-object-funcs">
<h3>struct drm_gem_object_funcs<a class="headerlink" href="#struct-drm-gem-object-funcs" title="Permalink to this headline">¶</a></h3>
<p>GEM objects can now have a function table instead of having the callbacks on the
DRM driver struct. This is now the preferred way and drivers can be moved over.</p>
</div>
<div class="section" id="use-drm-modeset-lock-all-helpers-instead-of-boilerplate">
<h3>Use DRM_MODESET_LOCK_ALL_* helpers instead of boilerplate<a class="headerlink" href="#use-drm-modeset-lock-all-helpers-instead-of-boilerplate" title="Permalink to this headline">¶</a></h3>
<p>For cases where drivers are attempting to grab the modeset locks with a local
acquire context. Replace the boilerplate code surrounding
drm_modeset_lock_all_ctx() with DRM_MODESET_LOCK_ALL_BEGIN() and
DRM_MODESET_LOCK_ALL_END() instead.</p>
<p>This should also be done for all places where drm_modest_lock_all() is still
used.</p>
<p>As a reference, take a look at the conversions already completed in drm core.</p>
<p>Contact: Sean Paul, respective driver maintainers</p>
</div>
<div class="section" id="rename-cma-helpers-to-dma-helpers">
<h3>Rename CMA helpers to DMA helpers<a class="headerlink" href="#rename-cma-helpers-to-dma-helpers" title="Permalink to this headline">¶</a></h3>
<p>CMA (standing for contiguous memory allocator) is really a bit an accident of
what these were used for first, a much better name would be DMA helpers. In the
text these should even be called coherent DMA memory helpers (so maybe CDM, but
no one knows what that means) since underneath they just use dma_alloc_coherent.</p>
<p>Contact: Laurent Pinchart, Daniel Vetter</p>
</div>
<div class="section" id="convert-direct-mode-vrefresh-accesses-to-use-drm-mode-vrefresh">
<h3>Convert direct mode.vrefresh accesses to use drm_mode_vrefresh()<a class="headerlink" href="#convert-direct-mode-vrefresh-accesses-to-use-drm-mode-vrefresh" title="Permalink to this headline">¶</a></h3>
<p>drm_display_mode.vrefresh isn’t guaranteed to be populated. As such, using it
is risky and has been known to cause div-by-zero bugs. Fortunately, drm core
has helper which will use mode.vrefresh if it’s !0 and will calculate it from
the timings when it’s 0.</p>
<p>Use simple search/replace, or (more fun) cocci to replace instances of direct
vrefresh access with a call to the helper. Check out
<a class="reference external" href="https://lists.freedesktop.org/archives/dri-devel/2019-January/205186.html">https://lists.freedesktop.org/archives/dri-devel/2019-January/205186.html</a> for
inspiration.</p>
<p>Once all instances of vrefresh have been converted, remove vrefresh from
drm_display_mode to avoid future use.</p>
<p>Contact: Sean Paul</p>
</div>
<div class="section" id="remove-drm-display-mode-hsync">
<h3>Remove drm_display_mode.hsync<a class="headerlink" href="#remove-drm-display-mode-hsync" title="Permalink to this headline">¶</a></h3>
<p>We have drm_mode_hsync() to calculate this from hsync_start/end, since drivers
shouldn’t/don’t use this, remove this member to avoid any temptations to use it
in the future. If there is any debug code using drm_display_mode.hsync, convert
it to use drm_mode_hsync() instead.</p>
<p>Contact: Sean Paul</p>
</div>
</div>
<div class="section" id="core-refactorings">
<h2>Core refactorings<a class="headerlink" href="#core-refactorings" title="Permalink to this headline">¶</a></h2>
<div class="section" id="clean-up-the-drm-header-mess">
<h3>Clean up the DRM header mess<a class="headerlink" href="#clean-up-the-drm-header-mess" title="Permalink to this headline">¶</a></h3>
<p>The DRM subsystem originally had only one huge global header, <code class="docutils literal notranslate"><span class="pre">drmP.h</span></code>. This
is now split up, but many source files still include it. The remaining part of
the cleanup work here is to replace any <code class="docutils literal notranslate"><span class="pre">#include</span> <span class="pre">&lt;drm/drmP.h&gt;</span></code> by only the
headers needed (and fixing up any missing pre-declarations in the headers).</p>
<p>In the end no .c file should need to include <code class="docutils literal notranslate"><span class="pre">drmP.h</span></code> anymore.</p>
<p>Contact: Daniel Vetter</p>
</div>
<div class="section" id="add-missing-kerneldoc-for-exported-functions">
<h3>Add missing kerneldoc for exported functions<a class="headerlink" href="#add-missing-kerneldoc-for-exported-functions" title="Permalink to this headline">¶</a></h3>
<p>The DRM reference documentation is still lacking kerneldoc in a few areas. The
task would be to clean up interfaces like moving functions around between
files to better group them and improving the interfaces like dropping return
values for functions that never fail. Then write kerneldoc for all exported
functions and an overview section and integrate it all into the drm book.</p>
<p>See <a class="reference external" href="https://dri.freedesktop.org/docs/drm/">https://dri.freedesktop.org/docs/drm/</a> for what’s there already.</p>
<p>Contact: Daniel Vetter</p>
</div>
<div class="section" id="make-panic-handling-work">
<h3>Make panic handling work<a class="headerlink" href="#make-panic-handling-work" title="Permalink to this headline">¶</a></h3>
<p>This is a really varied tasks with lots of little bits and pieces:</p>
<ul class="simple">
<li>The panic path can’t be tested currently, leading to constant breaking. The
main issue here is that panics can be triggered from hardirq contexts and
hence all panic related callback can run in hardirq context. It would be
awesome if we could test at least the fbdev helper code and driver code by
e.g. trigger calls through drm debugfs files. hardirq context could be
achieved by using an IPI to the local processor.</li>
<li>There’s a massive confusion of different panic handlers. DRM fbdev emulation
helpers have one, but on top of that the fbcon code itself also has one. We
need to make sure that they stop fighting over each another.</li>
<li><code class="docutils literal notranslate"><span class="pre">drm_can_sleep()</span></code> is a mess. It hides real bugs in normal operations and
isn’t a full solution for panic paths. We need to make sure that it only
returns true if there’s a panic going on for real, and fix up all the
fallout.</li>
<li>The panic handler must never sleep, which also means it can’t ever
<code class="docutils literal notranslate"><span class="pre">mutex_lock()</span></code>. Also it can’t grab any other lock unconditionally, not
even spinlocks (because NMI and hardirq can panic too). We need to either
make sure to not call such paths, or trylock everything. Really tricky.</li>
<li>For the above locking troubles reasons it’s pretty much impossible to
attempt a synchronous modeset from panic handlers. The only thing we could
try to achive is an atomic <code class="docutils literal notranslate"><span class="pre">set_base</span></code> of the primary plane, and hope that
it shows up. Everything else probably needs to be delayed to some worker or
something else which happens later on. Otherwise it just kills the box
harder, prevent the panic from going out on e.g. netconsole.</li>
<li>There’s also proposal for a simplied DRM console instead of the full-blown
fbcon and DRM fbdev emulation. Any kind of panic handling tricks should
obviously work for both console, in case we ever get kmslog merged.</li>
</ul>
<p>Contact: Daniel Vetter</p>
</div>
<div class="section" id="clean-up-the-debugfs-support">
<h3>Clean up the debugfs support<a class="headerlink" href="#clean-up-the-debugfs-support" title="Permalink to this headline">¶</a></h3>
<p>There’s a bunch of issues with it:</p>
<ul class="simple">
<li>The drm_info_list -&gt;show() function doesn’t even bother to cast to the drm
structure for you. This is lazy.</li>
<li>We probably want to have some support for debugfs files on crtc/connectors and
maybe other kms objects directly in core. There’s even drm_print support in
the funcs for these objects to dump kms state, so it’s all there. And then the
-&gt;show() functions should obviously give you a pointer to the right object.</li>
<li>The drm_info_list stuff is centered on drm_minor instead of drm_device. For
anything we want to print drm_device (or maybe drm_file) is the right thing.</li>
<li>The drm_driver-&gt;debugfs_init hooks we have is just an artifact of the old
midlayered load sequence. DRM debugfs should work more like sysfs, where you
can create properties/files for an object anytime you want, and the core
takes care of publishing/unpuplishing all the files at register/unregister
time. Drivers shouldn’t need to worry about these technicalities, and fixing
this (together with the drm_minor-&gt;drm_device move) would allow us to remove
debugfs_init.</li>
</ul>
<p>Contact: Daniel Vetter</p>
</div>
<div class="section" id="kms-cleanups">
<h3>KMS cleanups<a class="headerlink" href="#kms-cleanups" title="Permalink to this headline">¶</a></h3>
<p>Some of these date from the very introduction of KMS in 2008 …</p>
<ul class="simple">
<li>Make -&gt;funcs and -&gt;helper_private vtables optional. There’s a bunch of empty
function tables in drivers, but before we can remove them we need to make sure
that all the users in helpers and drivers do correctly check for a NULL
vtable.</li>
<li>Cleanup up the various -&gt;destroy callbacks. A lot of them just wrapt the
drm_*_cleanup implementations and can be removed. Some tack a kfree() at the
end, for which we could add drm_*_cleanup_kfree(). And then there’s the (for
historical reasons) misnamed drm_primary_helper_destroy() function.</li>
</ul>
</div>
</div>
<div class="section" id="better-testing">
<h2>Better Testing<a class="headerlink" href="#better-testing" title="Permalink to this headline">¶</a></h2>
<div class="section" id="enable-trinity-for-drm">
<h3>Enable trinity for DRM<a class="headerlink" href="#enable-trinity-for-drm" title="Permalink to this headline">¶</a></h3>
<p>And fix up the fallout. Should be really interesting …</p>
</div>
<div class="section" id="make-kms-tests-in-i-g-t-generic">
<h3>Make KMS tests in i-g-t generic<a class="headerlink" href="#make-kms-tests-in-i-g-t-generic" title="Permalink to this headline">¶</a></h3>
<p>The i915 driver team maintains an extensive testsuite for the i915 DRM driver,
including tons of testcases for corner-cases in the modesetting API. It would
be awesome if those tests (at least the ones not relying on Intel-specific GEM
features) could be made to run on any KMS driver.</p>
<p>Basic work to run i-g-t tests on non-i915 is done, what’s now missing is mass-
converting things over. For modeset tests we also first need a bit of
infrastructure to use dumb buffers for untiled buffers, to be able to run all
the non-i915 specific modeset tests.</p>
</div>
<div class="section" id="extend-virtual-test-driver-vkms">
<h3>Extend virtual test driver (VKMS)<a class="headerlink" href="#extend-virtual-test-driver-vkms" title="Permalink to this headline">¶</a></h3>
<p>See the documentation of <a class="reference internal" href="vkms.html#vkms"><span class="std std-ref">VKMS</span></a> for more details. This is an ideal
internship task, since it only requires a virtual machine and can be sized to
fit the available time.</p>
<p>Contact: Daniel Vetter</p>
</div>
</div>
<div class="section" id="driver-specific">
<h2>Driver Specific<a class="headerlink" href="#driver-specific" title="Permalink to this headline">¶</a></h2>
<div class="section" id="tinydrm">
<h3>tinydrm<a class="headerlink" href="#tinydrm" title="Permalink to this headline">¶</a></h3>
<p>Tinydrm is the helper driver for really simple fb drivers. The goal is to make
those drivers as simple as possible, so lots of room for refactoring:</p>
<ul class="simple">
<li>backlight helpers, probably best to put them into a new drm_backlight.c.
This is because drivers/video is de-facto unmaintained. We could also
move drivers/video/backlight to drivers/gpu/backlight and take it all
over within drm-misc, but that’s more work. Backlight helpers require a fair
bit of reworking and refactoring. A simple example is the enabling of a backlight.
Tinydrm has helpers for this. It would be good if other drivers can also use the
helper. However, there are various cases we need to consider i.e different
drivers seem to have different ways of enabling/disabling a backlight.
We also need to consider the backlight drivers (like gpio_backlight). The situation
is further complicated by the fact that the backlight is tied to fbdev
via fb_notifier_callback() which has complicated logic. For further details, refer
to the following discussion thread:
<a class="reference external" href="https://groups.google.com/forum/#!topic/outreachy-kernel/8rBe30lwtdA">https://groups.google.com/forum/#!topic/outreachy-kernel/8rBe30lwtdA</a></li>
<li>spi helpers, probably best put into spi core/helper code. Thierry said
the spi maintainer is fast&amp;reactive, so shouldn’t be a big issue.</li>
<li>extract the mipi-dbi helper (well, the non-tinydrm specific parts at
least) into a separate helper, like we have for mipi-dsi already. Or follow
one of the ideas for having a shared dsi/dbi helper, abstracting away the
transport details more.</li>
</ul>
<p>Contact: Noralf Trønnes, Daniel Vetter</p>
</div>
<div class="section" id="amd-dc-display-driver">
<h3>AMD DC Display Driver<a class="headerlink" href="#amd-dc-display-driver" title="Permalink to this headline">¶</a></h3>
<p>AMD DC is the display driver for AMD devices starting with Vega. There has been
a bunch of progress cleaning it up but there’s still plenty of work to be done.</p>
<p>See drivers/gpu/drm/amd/display/TODO for tasks.</p>
<p>Contact: Harry Wentland, Alex Deucher</p>
</div>
<div class="section" id="i915">
<h3>i915<a class="headerlink" href="#i915" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Our early/late pm callbacks could be removed in favour of using
device_link_add to model the dependency between i915 and snd_had. See
<a class="reference external" href="https://dri.freedesktop.org/docs/drm/driver-api/device_link.html">https://dri.freedesktop.org/docs/drm/driver-api/device_link.html</a></li>
</ul>
</div>
</div>
<div class="section" id="outside-drm">
<h2>Outside DRM<a class="headerlink" href="#outside-drm" title="Permalink to this headline">¶</a></h2>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../security/index.html" class="btn btn-neutral float-right" title="Security Documentation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="vgaarbiter.html" class="btn btn-neutral float-left" title="VGA Arbiter" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>