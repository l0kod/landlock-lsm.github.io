

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Landlock: kernel documentation &mdash; The Linux Kernel 4.10.0-rc8+ documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="The Linux Kernel 4.10.0-rc8+ documentation" href="../../index.html"/>
        <link rel="up" title="Landlock LSM" href="index.html"/>
        <link rel="next" title="Linux Sound Subsystem Documentation" href="../../sound/index.html"/>
        <link rel="prev" title="Landlock: userland documentation" href="user.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                4.10.0-rc8
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">The Linux kernel user&#8217;s and administrator&#8217;s guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">How to write kernel documentation</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">The Linux driver implementer&#8217;s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../media/index.html">Linux Media Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu/index.html">Linux GPU Driver Developer&#8217;s Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Security documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../tpm/index.html">Trusted Platform Module documentation</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Landlock LSM</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="user.html">Landlock: userland documentation</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Landlock: kernel documentation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#ebpf-properties">eBPF properties</a></li>
<li class="toctree-l4"><a class="reference internal" href="#guiding-principles">Guiding principles</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rule-addition-and-propagation">Rule addition and propagation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#questions-and-answers">Questions and answers</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/index.html">Linux Kernel Crypto API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/ko_KR/index.html">Korean translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">The Linux Kernel</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Security documentation</a> &raquo;</li>
      
          <li><a href="index.html">Landlock LSM</a> &raquo;</li>
      
    <li>Landlock: kernel documentation</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/security/landlock/kernel.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="landlock-kernel-documentation">
<h1>Landlock: kernel documentation<a class="headerlink" href="#landlock-kernel-documentation" title="Permalink to this headline">¶</a></h1>
<div class="section" id="ebpf-properties">
<h2>eBPF properties<a class="headerlink" href="#ebpf-properties" title="Permalink to this headline">¶</a></h2>
<p>To get an expressive language while still being safe and small, Landlock is
based on eBPF. Landlock should be usable by untrusted processes and must
therefore expose a minimal attack surface. The eBPF bytecode is minimal,
powerful, widely used and designed to be used by untrusted applications. Thus,
reusing the eBPF support in the kernel enables a generic approach while
minimizing new code.</p>
<p>An eBPF program has access to an eBPF context containing some fields including
event arguments (i.e. arg1 and arg2). These arguments can be used directly or
passed to helper functions according to their types. It is then possible to do
complex access checks without race conditions or inconsistent evaluation (i.e.
<a class="reference external" href="https://www.internetsociety.org/doc/traps-and-pitfalls-practical-problems-system-call-interposition-based-security-tools">incorrect mirroring of the OS code and state</a>).</p>
<p>A Landlock event describes a particular access type.  For now, there is only
one event type dedicated to filesystem related operations:
LANDLOCK_SUBTYPE_EVENT_FS.  A Landlock rule is tied to one event type.  This
makes it possible to statically check context accesses, potentially performed
by such rule, and hence prevents kernel address leaks and ensure the right use
of event arguments with eBPF functions.  Any user can add multiple Landlock
rules per Landlock event.  They are stacked and evaluated one after the other,
starting from the most recent rule, as seccomp-bpf does with its filters.
Underneath, an event is an abstraction over a set of LSM hooks.</p>
</div>
<div class="section" id="guiding-principles">
<h2>Guiding principles<a class="headerlink" href="#guiding-principles" title="Permalink to this headline">¶</a></h2>
<div class="section" id="unprivileged-use">
<h3>Unprivileged use<a class="headerlink" href="#unprivileged-use" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Everything potentially security sensitive which is exposed to a Landlock
rule, through functions or context, shall have an associated ability flag to
specify which kind of privilege a process must have to load such a rule.</li>
<li>Every ability flag expresses a semantic goal (e.g. debug, process
introspection, process modification) potentially tied to a set of
capabilities.</li>
<li>Landlock helpers and context should be usable by any unprivileged and
untrusted rule while following the system security policy enforced by other
access control mechanisms (e.g. DAC, LSM).</li>
</ul>
</div>
<div class="section" id="landlock-event-and-context">
<h3>Landlock event and context<a class="headerlink" href="#landlock-event-and-context" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>A Landlock event shall be focused on access control on kernel objects instead
of syscall filtering (i.e. syscall arguments), which is the purpose of
seccomp-bpf.</li>
<li>A Landlock context provided by an event shall express the minimal interface
to control an access for a kernel object. This can be achieved by wrapping
this raw object (e.g. file, inode, path, dentry) with an abstract
representation (i.e. handle) for userland/bpfland.</li>
<li>An evolution of a context&#8217;s field (e.g. new flags in the status field) shall
only be activated for a rule if the version specified by the loading thread
imply this behavior.  This makes it possible to ensure that the rule code
make sense (e.g.  only watch flags which may be activated).</li>
<li>An event type shall guaranty that all the BPF function calls from a rule are
safe.  Thus, the related Landlock context arguments shall always be of the
same type for a particular event type.  For example, a network event could
share helpers with a file event because of UNIX socket.  However, the same
helpers may not be compatible for a FS handle and a net handle.</li>
<li>Multiple event types may use the same context interface.</li>
</ul>
</div>
<div class="section" id="landlock-helpers">
<h3>Landlock helpers<a class="headerlink" href="#landlock-helpers" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Landlock helpers shall be as generic as possible (i.e. using handles) while
at the same time being as simple as possible and following the syscall
creation principles (cf.  <em>Documentation/adding-syscalls.txt</em>).</li>
<li>The only behavior change allowed on a helper is to fix a (logical) bug to
match the initial semantic.</li>
<li>Helpers shall be reentrant, i.e. only take inputs from arguments (e.g. from
the BPF context) or from the current thread, to allow an event type to use a
cache.  Future rule options might change this cache behavior (e.g. invalidate
cache after some time).</li>
<li>It is quite easy to add new helpers to extend Landlock.  The main concern
should be about the possibility to leak information from a landlocked process
to another (e.g. through maps) to not reproduce the same security sensitive
behavior as ptrace(2).</li>
</ul>
</div>
</div>
<div class="section" id="rule-addition-and-propagation">
<h2>Rule addition and propagation<a class="headerlink" href="#rule-addition-and-propagation" title="Permalink to this headline">¶</a></h2>
<p>See <a class="reference internal" href="user.html#inherited-rules"><span class="std std-ref">Documentation/security/landlock/user</span></a> for the
intended goal of rule propagation.</p>
<div class="section" id="structure-definitions">
<h3>Structure definitions<a class="headerlink" href="#structure-definitions" title="Permalink to this headline">¶</a></h3>
<dl class="type">
<dt id="c.landlock_node">
struct <code class="descname">landlock_node</code><a class="headerlink" href="#c.landlock_node" title="Permalink to this definition">¶</a></dt>
<dd><p>node in the rule hierarchy</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none"><div class="highlight"><pre><span></span>struct landlock_node {
  atomic_t usage;
  struct landlock_rule * rule;
  struct landlock_node * prev;
  struct landlock_node ** owner;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">usage</span></code></dt>
<dd>reference count to manage the node lifetime</dd>
<dt><code class="docutils literal"><span class="pre">rule</span></code></dt>
<dd>list of Landlock rules managed by this node</dd>
<dt><code class="docutils literal"><span class="pre">prev</span></code></dt>
<dd>reference the parent node</dd>
<dt><code class="docutils literal"><span class="pre">owner</span></code></dt>
<dd>reference the address of the node in the <a class="reference internal" href="#c.landlock_events" title="landlock_events"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">landlock_events</span></code></a>.
This is needed to know if we need to append a rule to the current
node or create a new node.</dd>
</dl>
<p><strong>Description</strong></p>
<p>This is created when a task inserts its first rule in the Landlock rule
hierarchy. The set of Landlock rules referenced by this node is then
enforced for all the tasks that inherit this node. However, if a task is
cloned before inserting any rule, it doesn&#8217;t get a dedicated node and its
children will not inherit any rules from this task.</p>
<dl class="type">
<dt id="c.landlock_events">
struct <code class="descname">landlock_events</code><a class="headerlink" href="#c.landlock_events" title="Permalink to this definition">¶</a></dt>
<dd><p>Landlock event rules enforced on a thread</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none"><div class="highlight"><pre><span></span>struct landlock_events {
  atomic_t usage;
  struct landlock_node * nodes[_LANDLOCK_SUBTYPE_EVENT_LAST];
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">usage</span></code></dt>
<dd>reference count to manage the object lifetime. When a thread need to
add Landlock rules and if <strong>usage</strong> is greater than 1, then the thread
must duplicate <a class="reference internal" href="#c.landlock_events" title="landlock_events"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">landlock_events</span></code></a> to not change the children&#8217;s
rules as well.</dd>
<dt><code class="docutils literal"><span class="pre">nodes[_LANDLOCK_SUBTYPE_EVENT_LAST]</span></code></dt>
<dd>array of non-NULL <a class="reference internal" href="#c.landlock_node" title="landlock_node"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">landlock_node</span></code></a> pointers</dd>
</dl>
<p><strong>Description</strong></p>
<p>This is used for low performance impact when forking a process. Instead of
copying the full array and incrementing the usage of each entries, only
create a pointer to <a class="reference internal" href="#c.landlock_events" title="landlock_events"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">landlock_events</span></code></a> and increments its usage.</p>
</div>
<div class="section" id="functions-for-rule-addition">
<h3>Functions for rule addition<a class="headerlink" href="#functions-for-rule-addition" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="c.landlock_append_prog">
struct <a class="reference internal" href="#c.landlock_events" title="landlock_events">landlock_events</a> * <code class="descname">landlock_append_prog</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.landlock_events" title="landlock_events">landlock_events</a> *<em>&nbsp;current_events</em>, struct bpf_prog *<em>&nbsp;prog</em><span class="sig-paren">)</span><a class="headerlink" href="#c.landlock_append_prog" title="Permalink to this definition">¶</a></dt>
<dd><p>attach a Landlock rule to <strong>current_events</strong></p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">landlock_events</span> <span class="pre">*</span> <span class="pre">current_events</span></code></dt>
<dd>landlock_events pointer, must be locked (if needed) to
prevent a concurrent put/free. This pointer must not be
freed after the call.</dd>
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">bpf_prog</span> <span class="pre">*</span> <span class="pre">prog</span></code></dt>
<dd>non-NULL Landlock rule to append to <strong>current_events</strong>. <strong>prog</strong> will be
owned by <a class="reference internal" href="#c.landlock_append_prog" title="landlock_append_prog"><code class="xref c c-func docutils literal"><span class="pre">landlock_append_prog()</span></code></a> and freed if an error happened.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Return <strong>current_events</strong> or a new pointer when OK. Return a pointer error
otherwise.</p>
<dl class="function">
<dt id="c.landlock_seccomp_append_prog">
int <code class="descname">landlock_seccomp_append_prog</code><span class="sig-paren">(</span>unsigned int<em>&nbsp;flags</em>, const char __user *<em>&nbsp;user_bpf_fd</em><span class="sig-paren">)</span><a class="headerlink" href="#c.landlock_seccomp_append_prog" title="Permalink to this definition">¶</a></dt>
<dd><p>attach a Landlock rule to the current process</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">unsigned</span> <span class="pre">int</span> <span class="pre">flags</span></code></dt>
<dd>not used for now, but could be used for TSYNC</dd>
<dt><code class="docutils literal"><span class="pre">const</span> <span class="pre">char</span> <span class="pre">__user</span> <span class="pre">*</span> <span class="pre">user_bpf_fd</span></code></dt>
<dd>file descriptor pointing to a loaded Landlock rule</dd>
</dl>
<p><strong>Description</strong></p>
<p>current-&gt;seccomp.landlock_events is lazily allocated. When a process fork,
only a pointer is copied. When a new event is added by a process, if there
is other references to this process&#8217; landlock_events, then a new allocation
is made to contains an array pointing to Landlock rule lists. This design
has low-performance impact and is memory efficient while keeping the
property of append-only rules.</p>
</div>
</div>
<div class="section" id="questions-and-answers">
<h2>Questions and answers<a class="headerlink" href="#questions-and-answers" title="Permalink to this headline">¶</a></h2>
<div class="section" id="why-not-create-a-custom-event-type-for-each-kind-of-action">
<h3>Why not create a custom event type for each kind of action?<a class="headerlink" href="#why-not-create-a-custom-event-type-for-each-kind-of-action" title="Permalink to this headline">¶</a></h3>
<p>Landlock rules can handle these checks.  Adding more exceptions to the kernel
code would lead to more code complexity.  A decision to ignore a kind of action
can and should be done at the beginning of a Landlock rule.</p>
</div>
<div class="section" id="why-a-rule-does-not-return-an-errno-code">
<h3>Why a rule does not return an errno code?<a class="headerlink" href="#why-a-rule-does-not-return-an-errno-code" title="Permalink to this headline">¶</a></h3>
<p>seccomp filters can return multiple kind of code, including an errno value,
which may be convenient for access control.  Those return codes are hardwired
in the userland ABI.  Instead, Landlock approach is to return a boolean to
allow or deny an action, which is much simpler and more generic.  Moreover, we
do not really have a choice because, unlike to seccomp, Landlock rules are not
enforced at the syscall entry point but may be executed at any point in the
kernel (through LSM hooks) where an errno return code may not make sense.
However, with this simple ABI and with the ability to call helpers, Landlock
may gain features similar to seccomp-bpf in the future while being compatible
with previous rules.</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../sound/index.html" class="btn btn-neutral float-right" title="Linux Sound Subsystem Documentation" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="user.html" class="btn btn-neutral" title="Landlock: userland documentation" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, The kernel development community.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'4.10.0-rc8+',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>